import{Q as ve}from"./QHeader.289f0645.js";import{Q as te}from"./QPage.fcc9aae1.js";import{Q as fe,a as _e}from"./QLayout.30990248.js";import{aL as ne,bY as re,f as z,M as ge,r as o,h as V,S as ye,w as le,o as c,a as w,F as W,bZ as Ee,e as x,y as he,bP as Se,z as P,A as l,d as e,a7 as Z,a8 as j,B as I,a9 as O,ab as Ce,aa as be,ac as X,t as D,D as q,Q as ee,bN as L,ad as we,J as Ne,x as xe}from"./index.687b44e8.js";import{u as Ie}from"./summaryStore.ade2e05f.js";import{u as ke}from"./useDashboardNavigation.a26a0a3f.js";import{Q as B}from"./QItemLabel.bbebea39.js";import{Q as Te,a as $}from"./QItem.eb9291fb.js";import{Q as De}from"./QList.1288e946.js";import"./index.46922028.js";import{u as Pe}from"./use-quasar.ba375293.js";import{a as Y}from"./api.1c42dce4.js";import{_ as oe}from"./plugin-vue_export-helper.21dcd24c.js";import{P as Qe}from"./PlayerNavigationMenu.1a7d2e68.js";import"./QTabs.979bee57.js";import"./rtl.276c3f1b.js";import"./QFooter.b7b22f15.js";const R={STRIPE_NOT_LOADED:"Stripe is not loaded. Include it as script or load using loadStripe method of @stripe/stripe-js",INSTANCE_NOT_DEFINED:"Stripe instance is not defined. Initialize Stripe before creating elements",ELEMENTS_NOT_DEFINED:"Elements object is not defined. You can't create stripe element without it",ELEMENT_TYPE_NOT_DEFINED:"elementType is required. You can't create stripe element without it"},Me=(m,n)=>{try{if(!window.Stripe)throw new Error(R.STRIPE_NOT_LOADED);return window.Stripe(m,n)}catch(p){console.error(p)}},Oe=(m,n)=>{try{if(!m)throw new Error(R.INSTANCE_NOT_DEFINED);return n!=null&&n.clientSecret,m.elements(n)}catch(p){console.error(p)}},je=(m,n,p)=>{try{if(!m)throw new Error(R.ELEMENTS_NOT_DEFINED);if(!n)throw new Error(R.ELEMENT_TYPE_NOT_DEFINED);return m.create.bind(m)(n,p)}catch(v){console.error(v)}},ae=["change","ready","focus","blur","click","escape","loaderror","loaderstart"],qe=ne({__name:"StripeElement",props:{type:{},elements:{},options:{}},emits:ae,setup(m,{expose:n,emit:p}){const v=m,E=p,{type:f,elements:d,options:s}=re(v),N=z(()=>d.value?"card":"payment"),h=ge("providedElements"),S=o(document.createElement("div")),a=o(),b=o();return V(()=>{const _=()=>{var i,C;a.value=je(d.value||h.value,f.value||N.value,s.value),(i=b.value)==null||i.appendChild(S.value),(C=a.value)==null||C.mount(S.value)},g=()=>{function i(C){return!!C&&typeof C.on=="function"}if(a.value&&i(a.value))for(const C of ae)a.value.on(C,A=>{E(C,A)})};try{_(),g()}catch(i){console.error(i)}}),ye(()=>{var _,g;(_=a.value)==null||_.unmount(),(g=a.value)==null||g.destroy()}),le(s,()=>{s.value&&a.value&&"update"in a.value&&a.value.update(s.value)}),n({stripeElement:a,domElement:S,mountPoint:b}),(_,g)=>(c(),w("div",{ref_key:"mountPoint",ref:b},null,512))}}),Le={key:0},Re=ne({__name:"StripeElements",props:{stripeKey:{},instanceOptions:{},elementsOptions:{}},setup(m,{expose:n}){const p=m,{stripeKey:v,instanceOptions:E,elementsOptions:f}=re(p),d=o(),s=o(),N=z(()=>s.value?Object.keys(s.value).length>0:!1);return V(()=>{d.value=Me(v.value,E.value),s.value=Oe(d.value,f.value)}),le(f,()=>{var h;(h=s.value)==null||h.update(f.value)}),W("providedInstance",d),W("providedElements",s),n({elements:s,instance:d,elementsUsable:N}),(h,S)=>N.value?(c(),w("div",Le,[Ee(h.$slots,"default",{instance:d.value,elements:s.value})])):x("",!0)}});const Ae={key:1,class:"text-center text-grey q-pa-lg"},Fe={key:2,class:"text-center q-pa-lg"},Be={class:"q-mt-lg"},$e={key:0,class:"stripe-elements-container"},Ye={key:0,class:"text-negative q-mt-sm text-caption"},ze={key:1,class:"text-negative q-pa-sm"},Ve={key:2,class:"text-center q-my-md"},Ue={__name:"PaymentMethodsComponent",setup(m){const n=Pe(),p=he(),v=o({}.VITE_STRIPE_PUBLISHABLE_KEY),E=o([]),f=o(!1),d=o(!1),s=o(null),N=o(null),h=o(!1),S=o(!1),a=o(null),b=o(null),_=o(!1),g=o(null),i=o(null);Se(null),o(null);const C=o({}),A=z(()=>({clientSecret:i.value,appearance:{theme:"night",labels:"floating"}})),se=o({style:{base:{iconColor:"#c4f0ff",color:"#fff",fontWeight:"500",fontFamily:"Roboto, Open Sans, Segoe UI, sans-serif",fontSize:"16px",fontSmoothing:"antialiased",":-webkit-autofill":{color:"#fce883"},"::placeholder":{color:"#87bbfd"}},invalid:{iconColor:"#ffc7ee",color:"#ffc7ee"}},hidePostalCode:!0}),F=async()=>{f.value=!0;try{const t=await Y.get("/payments/payment-methods");E.value=t.data||[]}catch{}finally{f.value=!1}},ie=t=>{n.dialog({title:"Confirmar",message:"\xBFEst\xE1s seguro de que quieres eliminar esta tarjeta?",cancel:{label:"Cancelar",flat:!0},ok:{label:"Eliminar",color:"negative",push:!0},persistent:!0,dark:!0,class:"bg-black"}).onOk(async()=>{await ue(t)})},ue=async t=>{var r,u;n.loading.show({message:"Eliminando..."});try{await Y.delete(`/payments/payment-methods/${t}`),n.notify({type:"positive",message:"Tarjeta eliminada correctamente."}),await F()}catch(y){console.error("Error deleting payment method:",y),n.notify({type:"negative",message:((u=(r=y.response)==null?void 0:r.data)==null?void 0:u.detail)||"Error al eliminar la tarjeta."})}finally{n.loading.hide()}},ce=t=>({visa:"img:/icons/visa.svg",mastercard:"img:/icons/mastercard.svg",amex:"img:/icons/amex.svg"})[t]||"mdi-credit-card",U=t=>({visa:"Visa",mastercard:"Mastercard",amex:"American Express"})[t]||t.charAt(0).toUpperCase()+t.slice(1),de=t=>{_.value=t.complete,b.value=t.error?t.error.message:null},K=()=>{d.value=!1,a.value=null,b.value=null,g.value=null,i.value=null,_.value=!1},me=async()=>{var t,r,u;S.value=!0,d.value=!0,g.value=null,i.value=null,_.value=!1;try{const M=(t=(await Y.post("/payments/setup-intent")).data)==null?void 0:t.clientSecret;if(!M)throw new Error("No se recibi\xF3 la configuraci\xF3n de pago del servidor.");i.value=M,console.log("Client Secret obtenido para SetupIntent"),await Ne()}catch(y){console.error("Error fetching client secret for SetupIntent:",y),g.value=((u=(r=y.response)==null?void 0:r.data)==null?void 0:u.detail)||y.message||"Error al iniciar el formulario de pago.",d.value=!1}finally{S.value=!1}},pe=async()=>{var u,y,M,H;const t=(u=s.value)==null?void 0:u.instance,r=(y=N.value)==null?void 0:y.stripeElement;if(!t||!r){a.value="El formulario de pago no est\xE1 listo (instancias no encontradas).",console.error("Error: Instancia de Stripe o CardElement no encontrada en refs. Verifica 'elementsRef' y 'cardElementRef'.",{stripeRef:s.value,cardRef:N.value});return}if(!_.value){a.value="Por favor, completa los datos de la tarjeta.";return}if(!i.value){a.value="Falta la configuraci\xF3n de pago (Client Secret).";return}h.value=!0,a.value=null,b.value=null;try{console.log("Llamando a confirmCardSetup con clientSecret:",i.value);const{error:k,setupIntent:T}=await t.confirmCardSetup(i.value,{payment_method:{card:r,billing_details:{name:p.userName||"Nombre No Disponible",email:p.userEmail||void 0}},expand:["payment_method"]});if(k)console.error("Stripe confirmCardSetup error:",k),a.value=k.message||"Ocurri\xF3 un error al guardar la tarjeta.";else if(T.status==="succeeded"){console.log("SetupIntent Succeeded:",T);const Q=T.payment_method;let G="tarjeta",J="****";typeof Q=="object"&&(Q==null?void 0:Q.card)&&(G=Q.card.brand,J=Q.card.last4),n.notify({type:"positive",message:`Tarjeta ${U(G)} terminada en ${J} guardada.`}),K(),await F()}else T.status==="requires_action"?(console.warn("SetupIntent requires_action despu\xE9s de confirmCardSetup. Status:",T.status),a.value="Se requiere autenticaci\xF3n adicional o la acci\xF3n no se complet\xF3."):(console.warn("SetupIntent status:",T.status),a.value=`El estado de la configuraci\xF3n fue: ${T.status}. Intenta de nuevo.`)}catch(k){console.error("Error in saveNewCard function execution:",k),a.value=((H=(M=k.response)==null?void 0:M.data)==null?void 0:H.detail)||k.message||"Error inesperado al guardar la tarjeta."}finally{h.value=!1}};return V(()=>{F()}),(t,r)=>(c(),P(te,{class:"q-pa-md"},{default:l(()=>[e(Z,null,{default:l(()=>[e(j,{class:"card-methods"},{default:l(()=>[r[2]||(r[2]=I("h4",{class:"q-mt-none q-mb-md text-white"},"Mis M\xE9todos de Pago",-1)),!f.value&&E.value.length>0?(c(),P(De,{key:0,bordered:"",separator:""},{default:l(()=>[e(B,{header:"",class:"text-grey-7"},{default:l(()=>[...r[0]||(r[0]=[O("Tarjetas Guardadas",-1)])]),_:1}),(c(!0),w(Ce,null,be(E.value,u=>(c(),P(Te,{key:u.id},{default:l(()=>[e($,{avatar:""},{default:l(()=>[e(X,{name:ce(u.brand),size:"lg",color:"white"},null,8,["name"])]),_:2},1024),e($,null,{default:l(()=>[e(B,null,{default:l(()=>[O(D(U(u.brand))+" terminada en "+D(u.last4),1)]),_:2},1024),e(B,{caption:""},{default:l(()=>[O("Expira: "+D(String(u.expMonth).padStart(2,"0"))+"/"+D(u.expYear),1)]),_:2},1024)]),_:2},1024),e($,{side:""},{default:l(()=>[e(q,{icon:"delete",color:"negative",flat:"",round:"",dense:"",onClick:y=>ie(u.id),title:"Eliminar tarjeta"},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):x("",!0),!f.value&&E.value.length===0&&!d.value?(c(),w("div",Ae,[e(X,{name:"mdi-credit-card-off-outline",size:"lg"}),r[1]||(r[1]=I("p",{class:"q-mt-sm"},"No tienes tarjetas guardadas.",-1))])):x("",!0),f.value?(c(),w("div",Fe,[e(ee,{color:"primary",size:"md"})])):x("",!0)]),_:1})]),_:1}),I("div",Be,[d.value?x("",!0):(c(),P(q,{key:0,label:"A\xF1adir Nueva Tarjeta",color:"green",icon:"add_card",onClick:me,loading:S.value,push:""},null,8,["loading"])),d.value?(c(),P(Z,{key:1,flat:"",bordered:"",class:"q-pa-md"},{default:l(()=>[e(j,{class:"q-pb-none"},{default:l(()=>[...r[3]||(r[3]=[I("div",{class:"text-h6"},"A\xF1adir Tarjeta",-1)])]),_:1}),e(j,null,{default:l(()=>[v.value&&i.value?(c(),w("div",$e,[e(L(Re),{ref_key:"elementsRef",ref:s,"stripe-key":v.value,"instance-options":C.value,"elements-options":A.value},{default:l(()=>[e(L(qe),{ref_key:"cardElementRef",ref:N,type:"card",options:se.value,onChange:de},null,8,["options"])]),_:1},8,["stripe-key","instance-options","elements-options"]),b.value?(c(),w("div",Ye,D(b.value),1)):x("",!0)])):g.value?(c(),w("div",ze,D(g.value),1)):(c(),w("div",Ve,[e(ee,{color:"primary",size:"sm"}),r[4]||(r[4]=O(" Iniciando formulario seguro... ",-1))]))]),_:1}),a.value?(c(),P(j,{key:0,class:"text-negative"},{default:l(()=>[O(D(a.value),1)]),_:1})):x("",!0),e(we,{align:"right"},{default:l(()=>[e(q,{label:"Cancelar",flat:"",color:"grey",onClick:K}),e(q,{label:"Guardar Tarjeta",color:"primary",onClick:pe,loading:h.value||S.value,disable:S.value||!i.value||!_.value,push:""},null,8,["loading","disable"])]),_:1})]),_:1})):x("",!0)])]),_:1}))}};var Ke=oe(Ue,[["__scopeId","data-v-f49a7d2e"]]);const He={class:"header-content"},Ge={class:"greeting"},Je={__name:"PaymentMethods",setup(m){Ie(),xe();const{goToDashboard:n}=ke();return(p,v)=>(c(),P(fe,{view:"hHh lpR fFf",class:"text-white"},{default:l(()=>[e(ve,{elevated:"",class:"text-white"},{default:l(()=>[I("div",He,[I("div",Ge,[I("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon clickable-logo",onClick:v[0]||(v[0]=(...E)=>L(n)&&L(n)(...E))})]),v[1]||(v[1]=I("div",{class:"header-icons"},null,-1))])]),_:1}),e(_e,null,{default:l(()=>[e(te,{class:"q-pa-md"},{default:l(()=>[e(Ke)]),_:1})]),_:1}),e(Qe)]),_:1}))}};var va=oe(Je,[["__scopeId","data-v-c40e8358"]]);export{va as default};
