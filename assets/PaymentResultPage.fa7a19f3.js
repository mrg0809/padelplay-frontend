import{x as $,a5 as F,r as g,h as J,a1 as H,o as d,z as N,A as O,d as s,Q as G,a as P,ac as h,B as r,D as b,a7 as K}from"./index.673cf58d.js";import{Q as W}from"./QPage.1da70bf2.js";import{u as X}from"./use-quasar.8083eaf6.js";import{a as m}from"./api.5f33f013.js";import{i as S,s as Y,c as Z,v as ee,m as ae}from"./capacitorPaymentUtils.0af0a5f5.js";import{i as te,h as se,g as oe,e as re,d as ne}from"./finalizeUtils.f306d73e.js";import{_ as ie}from"./plugin-vue_export-helper.21dcd24c.js";import"./hourUtils.51636ade.js";const le={key:1},ce={key:2},ue={key:3},de={key:4},me={__name:"PaymentResultPage",setup(pe){const o=$(),y=F(),l=X(),_=g(!0),c=g(null),u=g(null),k=g(!1);let q=null;const z=async()=>{try{_.value=!0;const e=y.query.status,a=y.query.payment_order_id,n=y.query.payment_id||y.query.collection_id;if(console.log("Processing payment result:",{status:e,paymentOrderId:a,paymentId:n}),c.value=e,!a){console.error("No payment_order_id in URL"),_.value=!1;return}S()&&await Z();try{const t=await ee(a,m);console.log("Backend verification result:",t),t.payment_status&&(c.value=ae(t.payment_status)),u.value=t}catch(t){console.error("Error verifying payment status:",t)}c.value==="success"&&u.value&&await j(u.value)}catch(e){console.error("Error processing payment result:",e),l.notify({type:"negative",message:"Error al procesar el resultado del pago"})}finally{_.value=!1}},j=async e=>{var a,n,t,x,R,T,I,C,B,D,E,M,Q,L;try{const p=e.event_type,V=e.id,f={baseData:{clubId:(a=e.metadata)==null?void 0:a.club_id,id:e.event_id,participants:((n=e.metadata)==null?void 0:n.participants)||1},extraData:{date:(t=e.metadata)==null?void 0:t.date,time:(x=e.metadata)==null?void 0:x.time,duration:((R=e.metadata)==null?void 0:R.duration)||60,paymentOption:((T=e.metadata)==null?void 0:T.payment_option)||"total",isPublicMatch:((I=e.metadata)==null?void 0:I.is_public_match)||!1,partnerId:(C=e.metadata)==null?void 0:C.partner_id,isRetas:(B=e.metadata)==null?void 0:B.is_retas,matchId:(D=e.metadata)==null?void 0:D.match_id,slotIndex:(E=e.metadata)==null?void 0:E.slot_index,teamToJoin:(M=e.metadata)==null?void 0:M.team_to_join},selectedProducts:e.additional_items||[],paymentOrderId:V,totalAmount:e.total_amount,amountToPay:e.total_amount,itemDetails:((Q=e.metadata)==null?void 0:Q.item_details)||[],paymentOption:((L=e.metadata)==null?void 0:L.payment_option)||"total"},v={status:"approved",payment_id:e.transaction_id};console.log("Finalizing transaction for event type:",p);let i={success:!1};switch(p){case"court":case"reservation":i=await ne(v,f,m,l);break;case"class":case"private_lesson":i=await re(v,f,m,l);break;case"public_lesson":i=await oe(v,f,m,l);break;case"match":case"match_join":case"open_match_join":i=await se(v,f,m,l);break;case"tournament":i=await te(v,f,m,l);break;default:console.log("No specific finalization for event type:",p),i={success:!0}}console.log("Finalization result:",i)}catch(p){console.error("Error finalizing transaction:",p)}},w=()=>{if(u.value){const e=u.value.event_type,a=u.value.event_id;e==="match"&&a?o.push(`/player/match/${a}`):e==="tournament"&&a?o.push(`/tournament/${a}`):e==="class"&&a?o.push("/player/classes"):o.push("/player/dashboard")}else o.push("/player/dashboard")},A=()=>{o.back()},U=()=>{o.push("/player/dashboard")};return J(async()=>{await z(),S()&&(q=Y(async e=>{if(k.value){console.log("Already processing deep link, ignoring duplicate");return}k.value=!0;try{console.log("Deep link received:",e.url);const a=new URL(e.url),n=a.searchParams.get("status"),t=a.searchParams.get("payment_order_id");n&&t&&(o.replace({query:{status:n,payment_order_id:t}}),await z())}finally{setTimeout(()=>{k.value=!1},1e3)}}))}),H(()=>{q&&q()}),(e,a)=>(d(),N(W,{class:"flex flex-center"},{default:O(()=>[s(K,{class:"q-pa-lg text-center",style:{"min-width":"300px"}},{default:O(()=>[_.value?(d(),N(G,{key:0,color:"primary",size:"3rem"})):c.value==="success"?(d(),P("div",le,[s(h,{name:"check_circle",color:"positive",size:"5rem"}),a[0]||(a[0]=r("h5",{class:"q-mt-md q-mb-sm"},"\xA1Pago Exitoso!",-1)),a[1]||(a[1]=r("p",null,"Tu pago ha sido procesado correctamente.",-1)),s(b,{color:"primary",label:"Continuar",onClick:w,class:"q-mt-md"})])):c.value==="failure"?(d(),P("div",ce,[s(h,{name:"error",color:"negative",size:"5rem"}),a[2]||(a[2]=r("h5",{class:"q-mt-md q-mb-sm"},"Pago Rechazado",-1)),a[3]||(a[3]=r("p",null,"Hubo un problema al procesar tu pago. Por favor, intenta nuevamente.",-1)),s(b,{color:"primary",label:"Reintentar",onClick:A,class:"q-mt-md"})])):c.value==="pending"?(d(),P("div",ue,[s(h,{name:"schedule",color:"warning",size:"5rem"}),a[4]||(a[4]=r("h5",{class:"q-mt-md q-mb-sm"},"Pago Pendiente",-1)),a[5]||(a[5]=r("p",null,"Tu pago est\xE1 siendo procesado. Te notificaremos cuando se complete.",-1)),s(b,{color:"primary",label:"Continuar",onClick:w,class:"q-mt-md"})])):(d(),P("div",de,[s(h,{name:"help",color:"grey",size:"5rem"}),a[6]||(a[6]=r("h5",{class:"q-mt-md q-mb-sm"},"Estado Desconocido",-1)),a[7]||(a[7]=r("p",null,"No pudimos determinar el estado de tu pago.",-1)),s(b,{color:"primary",label:"Volver",onClick:U,class:"q-mt-md"})]))]),_:1})]),_:1}))}};var ke=ie(me,[["__scopeId","data-v-4c2e6122"]]);export{ke as default};
