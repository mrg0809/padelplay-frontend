import{r as h,y as B,a3 as T,k as v,G as b,H as n,p as o,ab as D,I as m,l as S,ae as N,af as P,K as j,bH as H,J as k,a9 as V,aa as M}from"./index.63dc7e23.js";import{Q as q}from"./QHeader.fafcae42.js";import{Q as w}from"./QPage.2aaa1d93.js";import{a as I,Q as C}from"./QLayout.554612a4.js";import{s as p}from"./supabase.87115abf.js";import{Q as x}from"./QChatMessage.aa640d59.js";import{_ as U}from"./plugin-vue_export-helper.21dcd24c.js";import{n as K}from"./navigationUtils.2c4b9dee.js";import{P as L}from"./PlayerNavigationMenu.f00bb1db.js";import"./QTabs.6a3d63d5.js";import"./rtl.276c3f1b.js";import"./QFooter.9d6e02eb.js";const F={props:{matchId:{type:String,required:!0}},components:{QChatMessage:x},setup(c){const t=h([]),l=h(""),e=h(null),u=h({full_name:"Usuario desconocido"}),f=h({});let s=null;const i=async()=>{try{const{data:a,error:r}=await p.from("chat_messages").select("*").eq("match_id",c.matchId).order("timestamp",{ascending:!0});r?console.error("Error al cargar mensajes:",r):t.value=a}catch(a){console.error("Error inesperado al cargar mensajes:",a)}},d=async a=>{try{const{data:r,error:_}=await p.from("players").select("user_id, first_name, photo_url").in("user_id",a);_?console.error("Error al obtener detalles de usuarios:",_):r.forEach(g=>{f.value[g.user_id]=g})}catch(r){console.error("Error inesperado al obtener detalles de usuarios:",r)}},Q=async()=>{try{const{error:a}=await p.from("chat_messages").insert({match_id:c.matchId,sender:u.value.full_name,sender_id:e.value,message:l.value.trim()});a?console.error("Error al enviar mensaje:",a):l.value=""}catch(a){console.error("Error inesperado al enviar mensaje:",a)}},E=()=>{s=p.channel("public:chat_messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`match_id=eq.${c.matchId}`},a=>{t.value.push(a.new)}).subscribe(a=>{a==="SUBSCRIBED"&&console.log("Realtime subscription active")})},R=a=>new Date(a).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});return B(async()=>{const a=localStorage.getItem("token");if(a){const g=a.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),y=JSON.parse(atob(g));e.value=y.sub,u.value.full_name=y.full_name||"Usuario desconocido"}await i();const r=t.value.map(_=>_.sender_id);await d(r),E()}),T(()=>{s&&p.removeChannel(s)}),{currentUserId:e,messages:t,newMessage:l,formatTimestamp:R,sendMessage:Q,user:u,userMap:f}}},J={class:"chat-messages"},G={class:"chat-message-input"};function O(c,t,l,e,u,f){return v(),b(C,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:n(()=>[o(I,null,{default:n(()=>[o(w,null,{default:n(()=>[o(D,{class:"text-white chat-card"},{default:n(()=>[m("div",J,[(v(!0),S(P,null,N(e.messages,s=>{var i,d;return v(),b(x,{key:s.id,name:((i=e.userMap[s.sender_id])==null?void 0:i.first_name)||"Usuario desconocido",avatar:(d=e.userMap[s.sender_id])==null?void 0:d.photo_url,text:[s.message],stamp:e.formatTimestamp(s.timestamp),sent:s.sender_id===e.currentUserId,"bg-color":s.sender_id===e.currentUserId?"amber-7":"primary","text-color":s.sender_id===e.currentUserId?"black":"white"},null,8,["name","avatar","text","stamp","sent","bg-color","text-color"])}),128))])]),_:1}),m("div",G,[o(j,{modelValue:e.newMessage,"onUpdate:modelValue":t[0]||(t[0]=s=>e.newMessage=s),placeholder:"Escribe un mensaje...",outlined:"",dense:"",dark:"",onKeyup:H(e.sendMessage,["enter"])},null,8,["modelValue","onKeyup"]),o(k,{color:"black",onClick:e.sendMessage,disable:!e.newMessage.trim(),icon:"o_send"},null,8,["onClick","disable"])])]),_:1})]),_:1})]),_:1})}var X=U(F,[["render",O],["__scopeId","data-v-16742b44"]]);const z={components:{MatchChatRoom:X,PlayerNavigationMenu:L},setup(){return{matchId:V().params.matchId,goBack:()=>{window.history.back()},goToDashboard:()=>{K(router,userStore)}}}},A={class:"header-content"},W={class:"greeting"},Y={class:"header-icons"};function Z(c,t,l,e,u,f){const s=M("MatchChatRoom"),i=M("PlayerNavigationMenu");return v(),b(C,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:n(()=>[o(q,{elevated:"",class:"bg-primary text-white"},{default:n(()=>[m("div",A,[m("div",W,[m("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon clickable-logo",onClick:t[0]||(t[0]=(...d)=>e.goToDashboard&&e.goToDashboard(...d))})]),m("div",Y,[o(k,{flat:"",round:"",icon:"close",onClick:e.goBack},null,8,["onClick"])])])]),_:1}),o(I,null,{default:n(()=>[o(w,{class:"q-pa-md"},{default:n(()=>[o(s,{matchId:e.matchId},null,8,["matchId"])]),_:1})]),_:1}),o(i)]),_:1})}var me=U(z,[["render",Z],["__scopeId","data-v-586a3f20"]]);export{me as default};
