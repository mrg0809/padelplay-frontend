import{Q as Ae}from"./QHeader.289f0645.js";import{r as i,f as be,h as ke,w as xe,o as C,z as F,A as l,d as r,B as o,a8 as O,Q as ge,e as j,a as G,aa as Ne,ab as qe,aK as Me,D as Y,ac as W,t as $,E as _e,aR as Ve,a9 as Re,aS as ze,aT as Ie,a7 as le,aP as Fe,J as Pe,S as je,x as Oe,a5 as Qe,a6 as he,af as Ee,ad as Se}from"./index.687b44e8.js";import{Q as Te}from"./QBanner.7143372b.js";import{Q as Ue}from"./QPage.fcc9aae1.js";import{Q as $e,a as Le}from"./QLayout.30990248.js";import{u as we}from"./use-quasar.ba375293.js";import{Q as De}from"./QForm.c4c1505e.js";import{_ as Be}from"./MP_RGB_horizontal.ee11db59.js";import{a as S}from"./api.1c42dce4.js";import{i as Ke,o as He}from"./capacitorPaymentUtils.c0ae8c12.js";import{_ as Ce}from"./plugin-vue_export-helper.21dcd24c.js";import{P as Je}from"./PlayerNavigationMenu.1a7d2e68.js";import{d as Ye,e as We,g as Ge,h as Ze,i as Xe}from"./finalizeUtils.f306d73e.js";import"./QTabs.979bee57.js";import"./rtl.276c3f1b.js";import"./QFooter.b7b22f15.js";import"./hourUtils.51636ade.js";const ea={class:"text-center"},aa={class:"row q-col-gutter-sm"},ta={class:"col"},oa={class:"text-body2"},ra={class:"text-caption"},na={class:"text-caption"},sa={class:"text-center"},la={class:"text-center text-white"},ia={key:0,class:"q-mb-md"},ca={class:"row items-center q-py-md"},ua=["src","alt"],da={class:"text-white text-h6"},ma=["src","alt"],pa={class:"row q-col-gutter-md"},va={class:"col-6"},ya={class:"col-6"},_a={class:"text-center"},ga={class:"q-mb-md"},fa={__name:"CheckoutAPI",props:{cartItems:{type:Array,required:!0},userInfo:{type:Object,required:!0},totalAmount:{type:Number,required:!0},externalReference:{type:String,required:!0},metadata:{type:Object,default:()=>({})}},emits:["payment-success","payment-error"],setup(L,{emit:v}){const s=L,n=v,E=we(),I=i(!0),k=i(!1),N=i(!1),z=i(null),p=i(!1),b=i(""),A=i([]),V=i(null),x=i([]),y=i(null),P=i([]),R=i(null),u=i({number:"",holderName:"",expiry:"",cvv:""}),ue=i(1),d=i(!1),_=i(!1),m=i({supports_tokenization:!0,supports_deferred_capture:!0,payment_method_id:null,issuer_id:null,card_type:null,message:""});be(()=>[{label:"1 pago",value:1}]);const g=be(()=>R.value&&!p.value?!0:b.value&&b.value!==null&&b.value!==""&&K(u.value.number)&&u.value.holderName&&u.value.holderName.trim()!==""&&Z(u.value.expiry)&&X(u.value.cvv)),T=e=>{const t={visa:"credit_card",master:"credit_card",amex:"credit_card",naranja:"credit_card",cabal:"credit_card",default:"credit_card"};return t[e]||t.default},q=e=>({visa:"VISA",master:"Mastercard",amex:"American Express",naranja:"Naranja",cabal:"Cabal"})[e]||(e==null?void 0:e.toUpperCase()),M=e=>({visa:"visa",master:"mastercard",amex:"amex"})[e]||e,ae=e=>`/icons/${M(e)}.svg`,K=e=>{if(!e)return!1;const t=e.replace(/\s/g,"");return t.length>=13&&t.length<=19&&/^\d+$/.test(t)},Z=e=>{if(!e||e.length!==5)return!1;const[t,a]=e.split("/"),h=parseInt(t),Q=parseInt("20"+a),B=new Date,c=B.getFullYear(),U=B.getMonth()+1;return h>=1&&h<=12&&Q>=c&&(Q>c||h>=U)},X=e=>e?e.length>=3&&e.length<=4&&/^\d+$/.test(e):!1,te=()=>{let e=u.value.number.replace(/\s/g,"");e=e.replace(/(.{4})/g,"$1 ").trim(),u.value.number=e;const t=e.replace(/\s/g,"");J(t)},ie=()=>{let e=u.value.expiry.replace(/\D/g,"");e.length>=2&&(e=e.substring(0,2)+"/"+e.substring(2,4)),u.value.expiry=e},ee=async e=>{try{if(!e){x.value=[],y.value=null;return}const t=await S.get(`/payments/card_issuers/${e}`);t.data&&t.data.issuers?(x.value=t.data.issuers,x.value.length>0?(y.value=x.value[0].id,console.log(`Auto-selected issuer for Mexico compatibility: ${x.value[0].id} (${x.value[0].name})`)):(y.value=null,console.warn(`No issuers found for payment method: ${e}`))):(x.value=[],y.value=null)}catch(t){console.error("Error loading card issuers:",t),x.value=[],y.value=null}},ce=async e=>{try{if(!e||e.length<6){_.value=!1,m.value={supports_tokenization:!0,supports_deferred_capture:!0,payment_method_id:null,issuer_id:null,card_type:null,message:""};return}console.log(`Checking BIN capabilities for: ${e.substring(0,6)}`);const t=await S.get(`/payments/check_bin_capabilities/${e.substring(0,6)}`);t.data&&(m.value=t.data,_.value=!0,console.log("BIN check result:",{supports_tokenization:t.data.supports_tokenization,card_type:t.data.card_type,message:t.data.message}))}catch(t){console.error("Error checking BIN capabilities:",t),_.value=!0,m.value={supports_tokenization:!1,supports_deferred_capture:!1,payment_method_id:null,issuer_id:null,card_type:null,message:"No se pudo verificar la tarjeta. Se usar\xE1 pago directo."}}},J=async e=>{if(!e){b.value="",V.value=null,x.value=[],y.value=null,_.value=!1;return}const t={visa:/^4/,master:/^5[1-5]/,amex:/^3[47]/};for(const[a,h]of Object.entries(t))if(h.test(e)){const B=b.value!==a;b.value=a,V.value=a,B&&x.value.length===0&&await ee(a),e.length===6&&!_.value&&await ce(e);return}b.value="",V.value=null,x.value=[],y.value=null,_.value=!1},oe=e=>{},re=e=>{},w=async()=>{try{N.value=!0;const e=await S.get("/payments/payment_methods");if(e.data&&e.data.payment_methods){const t=["visa","master","amex","pse","efecty","bancolombia","banco_agrario","banco_av_villas","banco_bogota","banco_davivienda","banco_falabella","banco_gnb_sudameris","banco_itau","banco_occidente","banco_popular","banco_santander_colombia","bbva_colombia"];A.value=e.data.payment_methods.filter(a=>t.includes(a.id)||a.payment_type_id==="credit_card"&&["visa","master","amex"].includes(a.id)||a.payment_type_id==="bank_transfer"),V.value=null}else throw new Error("Invalid response format")}catch(e){console.error("Error loading payment methods:",e),A.value=[],V.value=null,E.notify({type:"negative",message:"Error al cargar m\xE9todos de pago"})}finally{N.value=!1}},f=async()=>{try{const e=await S.get("/payments/saved_payment_methods");e.data&&e.data.saved_payment_methods?P.value=e.data.saved_payment_methods:P.value=[]}catch(e){console.error("Error loading saved payment methods:",e),P.value=[]}},ne=e=>{R.value=e,p.value=!1},se=async e=>{var t;try{z.value=e.id,await S.delete(`/payments/saved_payment_methods/${e.id}`),P.value=P.value.filter(a=>a.id!==e.id),((t=R.value)==null?void 0:t.id)===e.id&&(R.value=null),E.notify({type:"positive",message:"M\xE9todo de pago eliminado"})}catch(a){console.error("Error deleting saved method:",a),E.notify({type:"negative",message:"Error al eliminar m\xE9todo de pago"})}finally{z.value=null}},H=async()=>{var e,t,a,h,Q,B;try{k.value=!0;const c=_.value&&!m.value.supports_tokenization;console.log(`Payment flow: ${c?"CHECKOUT PRO (BIN exclusion fallback)":"TOKENIZATION"}`),console.log("BIN capabilities:",m.value);const[U,pe]=u.value.expiry.split("/");let ve,de;if(c){de="/payments/create_checkout_pro_fallback",ve={transaction_amount:s.totalAmount,description:`Pago por ${s.cartItems.length} items`,external_reference:s.externalReference,payer:{email:s.userInfo.email,first_name:((e=s.userInfo.name)==null?void 0:e.split(" ")[0])||"",last_name:((t=s.userInfo.name)==null?void 0:t.split(" ").slice(1).join(" "))||""},metadata:s.metadata},console.log("Using CHECKOUT PRO fallback for BIN exclusion");const ye=await S.post(de,ve),{init_point:me,preference_id:Oa}=ye.data;console.log("Received init_point:",me),Ke()?(console.log("Opening Checkout Pro in native browser"),await He(me),E.notify({type:"info",message:"Abriendo pasarela de pago...",timeout:2e3})):(console.log("Redirecting to Checkout Pro in web browser"),window.location.href=me);return}else{de="/payments/process_payment";const me=(await S.post("/payments/tokenize_card",{card_number:u.value.number.replace(/\s/g,""),expiration_month:U,expiration_year:"20"+pe,security_code:u.value.cvv,card_holder_name:u.value.holderName})).data.token;ve={transaction_amount:s.totalAmount,description:`Pago por ${s.cartItems.length} items`,payment_method_id:V.value,payer:{email:s.userInfo.email,first_name:((a=s.userInfo.name)==null?void 0:a.split(" ")[0])||"",last_name:((h=s.userInfo.name)==null?void 0:h.split(" ").slice(1).join(" "))||""},payment_method:{token:me,installments:ue.value||1,card_holder_name:u.value.holderName,issuer_id:y.value},external_reference:s.externalReference,metadata:s.metadata},console.log("Using TOKENIZATION flow with pre-generated token")}console.log(`Calling endpoint: ${de}`);const fe=(await S.post(de,ve)).data;if(d.value&&fe.status==="approved"&&m.value.supports_tokenization&&!useDirectPayment)try{await S.post("/payments/save_payment_method",{payment_method_id:V.value,last_four_digits:u.value.number.replace(/\s/g,"").slice(-4),card_holder_name:u.value.holderName,expiration_month:U,expiration_year:"20"+pe,issuer_name:fe.issuer_name}),E.notify({type:"positive",message:"M\xE9todo de pago guardado exitosamente",timeout:2e3})}catch(ye){console.error("Error saving payment method:",ye)}n("payment-success",fe)}catch(c){console.error("Payment error:",c);const U=((B=(Q=c.response)==null?void 0:Q.data)==null?void 0:B.detail)||"Error al procesar el pago";n("payment-error",U),E.notify({type:"negative",message:U})}finally{k.value=!1}},D=async()=>{try{k.value=!0,E.notify({type:"negative",message:"Los m\xE9todos guardados requieren una implementaci\xF3n avanzada. Por favor, usa una nueva tarjeta."}),p.value=!0,R.value=null}catch(e){console.error("Saved method payment error:",e),n("payment-error","Error al procesar pago con m\xE9todo guardado")}finally{k.value=!1}};return ke(async()=>{try{await Promise.all([w(),f()]),P.value.length===0&&(p.value=!0)}catch(e){console.error("Error during component initialization:",e),E.notify({type:"negative",message:"Error al inicializar el formulario de pago"})}finally{I.value=!1}}),xe(()=>u.value.number,e=>{if(e){const t=e.replace(/\s/g,"");J(t)}else b.value="",V.value=null,x.value=[],y.value=null,_.value=!1,m.value={supports_tokenization:!0,supports_deferred_capture:!0,payment_method_id:null,issuer_id:null,card_type:null,message:""}},{immediate:!0}),(e,t)=>(C(),F(le,{class:"text-white"},{default:l(()=>[r(O,null,{default:l(()=>[...t[6]||(t[6]=[o("img",{src:Be,alt:"Logo",style:{height:"150px",width:"auto"},class:"q-mb-md"},null,-1),o("p",{class:"text-caption"},"Ingresa los datos de tu tarjeta de manera segura",-1)])]),_:1}),I.value?(C(),F(O,{key:0},{default:l(()=>[o("div",ea,[r(ge,{color:"primary",size:"3rem"}),t[7]||(t[7]=o("p",{class:"q-mt-md"},"Cargando m\xE9todos de pago...",-1))])]),_:1})):j("",!0),!I.value&&P.value.length>0?(C(),F(O,{key:1},{default:l(()=>[t[8]||(t[8]=o("h5",{class:"q-mb-md"},"M\xE9todos de pago guardados",-1)),o("div",aa,[(C(!0),G(qe,null,Ne(P.value,a=>{var h;return C(),G("div",{key:a.id,class:"col-12"},[r(le,{flat:"",bordered:"",class:Fe(((h=R.value)==null?void 0:h.id)===a.id?"bg-primary text-white":"bg-grey-8 text-white"),clickable:"",onClick:Q=>ne(a)},{default:l(()=>[r(O,{class:"row items-center"},{default:l(()=>[r(W,{name:T(a.payment_method_id),size:"sm",class:"q-mr-sm"},null,8,["name"]),o("div",ta,[o("div",oa,"**** **** **** "+$(a.last_four_digits),1),o("div",ra,$(a.card_holder_name),1),o("div",na,$(a.expiration_month)+"/"+$(a.expiration_year),1)]),r(Y,{flat:"",icon:"delete",size:"sm",onClick:Ie(Q=>se(a),["stop"]),loading:z.value===a.id},null,8,["onClick","loading"])]),_:2},1024)]),_:2},1032,["class","onClick"])])}),128))]),r(Me,{class:"q-my-md"}),r(Y,{flat:"",label:p.value?"Usar m\xE9todo guardado":"Usar nueva tarjeta",onClick:t[0]||(t[0]=a=>p.value=!p.value),class:"full-width q-mb-md"},null,8,["label"])]),_:1})):j("",!0),!I.value&&N.value?(C(),F(O,{key:2},{default:l(()=>[o("div",sa,[r(ge,{color:"primary",size:"2rem"}),t[9]||(t[9]=o("p",{class:"q-mt-md text-white"},"Cargando m\xE9todos de pago...",-1))])]),_:1})):j("",!0),!I.value&&!N.value&&A.value.length===0&&(P.value.length===0||p.value)?(C(),F(O,{key:3},{default:l(()=>[o("div",la,[r(W,{name:"error",size:"3rem",color:"negative"}),t[10]||(t[10]=o("p",{class:"q-mt-md"},"No se pudieron cargar los m\xE9todos de pago disponibles.",-1)),r(Y,{color:"primary",label:"Reintentar",onClick:w,class:"q-mt-md"})])]),_:1})):j("",!0),!I.value&&!N.value&&A.value.length>0&&(P.value.length===0||p.value)?(C(),F(O,{key:4},{default:l(()=>[r(De,{onSubmit:Ie(H,["prevent"])},{default:l(()=>[b.value?(C(),G("div",ia,[t[11]||(t[11]=o("div",{class:"text-body2 q-mb-sm text-white"},"Tipo de tarjeta detectado",-1)),o("div",ca,[o("img",{src:ae(b.value),alt:q(b.value),style:{height:"32px",width:"auto",filter:"brightness(1.2)"},class:"q-mr-md",onError:oe,onLoad:re},null,40,ua),o("span",da,$(q(b.value)),1)])])):j("",!0),r(_e,{modelValue:u.value.number,"onUpdate:modelValue":t[1]||(t[1]=a=>u.value.number=a),label:"N\xFAmero de tarjeta",placeholder:"1234 5678 9012 3456",filled:"",dark:"",maxlength:"19",rules:[a=>K(a)||"N\xFAmero de tarjeta inv\xE1lido"],onInput:te,class:"q-mb-md"},Ve({_:2},[b.value?{name:"prepend",fn:l(()=>[o("img",{src:ae(b.value),alt:q(b.value),style:{height:"24px",width:"auto"},onError:oe,onLoad:re},null,40,ma)]),key:"0"}:{name:"prepend",fn:l(()=>[r(W,{name:"credit_card",color:"grey"})]),key:"1"}]),1032,["modelValue","rules"]),r(_e,{modelValue:u.value.holderName,"onUpdate:modelValue":t[2]||(t[2]=a=>u.value.holderName=a),label:"Nombre del titular",placeholder:"JUAN P\xC9REZ",filled:"",dark:"",rules:[a=>!!a||"El nombre es requerido"],class:"q-mb-md"},null,8,["modelValue","rules"]),o("div",pa,[o("div",va,[r(_e,{modelValue:u.value.expiry,"onUpdate:modelValue":t[3]||(t[3]=a=>u.value.expiry=a),label:"MM/AA",placeholder:"12/28",filled:"",dark:"",maxlength:"5",rules:[a=>Z(a)||"Fecha inv\xE1lida (MM/AA)"],onInput:ie,onKeyup:ie},null,8,["modelValue","rules"])]),o("div",ya,[r(_e,{modelValue:u.value.cvv,"onUpdate:modelValue":t[4]||(t[4]=a=>u.value.cvv=a),label:"CVV",placeholder:"123",filled:"",dark:"",maxlength:"4",type:"password",rules:[a=>X(a)||"CVV inv\xE1lido"]},null,8,["modelValue","rules"])])]),_.value&&!m.value.supports_tokenization?(C(),F(Te,{key:1,class:"bg-secondary text-white q-mb-md",rounded:""},{avatar:l(()=>[r(W,{name:"info",color:"white"})]),default:l(()=>[t[12]||(t[12]=o("div",null,[o("strong",null,"Pago seguro alternativo"),o("br"),Re(" Para esta tarjeta, completar\xE1s el pago en el portal seguro de MercadoPago. Esto es requerido por tu banco para mayor seguridad. ")],-1))]),_:1})):j("",!0),_.value&&m.value.supports_tokenization?(C(),F(ze,{key:2,modelValue:d.value,"onUpdate:modelValue":t[5]||(t[5]=a=>d.value=a),label:"Guardar m\xE9todo de pago para futuras compras",color:"primary",dark:"",class:"q-mb-md"},null,8,["modelValue"])):j("",!0),r(Y,{type:"submit",color:g.value?"positive":"primary",size:"lg",label:_.value&&!m.value.supports_tokenization?"Continuar a pago seguro":`Pagar $${L.totalAmount}`,class:"full-width text black",loading:k.value,disable:!g.value},null,8,["color","label","loading","disable"])]),_:1})]),_:1})):j("",!0),!I.value&&!N.value&&R.value&&!p.value?(C(),F(O,{key:5},{default:l(()=>[o("div",_a,[o("p",ga," Pagar con: **** **** **** "+$(R.value.last_four_digits),1),r(Y,{color:"positive",size:"lg",label:`Pagar $${L.totalAmount}`,class:"full-width",loading:k.value,onClick:D},null,8,["label","loading"])])]),_:1})):j("",!0)]),_:1}))}};var ha=Ce(fa,[["__scopeId","data-v-24c04a4c"]]);const ba={class:"checkout-bricks-container text-white"},xa={key:0,class:"error-card"},ka={class:"q-mt-md"},wa={class:"payment-section"},Ca={class:"payment-brick-wrapper brick-isolation"},Ia={key:0,class:"brick-loading-overlay text-center"},Pa={__name:"CheckoutBricks",props:{cartItems:{type:Array,required:!0},userInfo:{type:Object,required:!0},totalAmount:{type:Number,required:!0},externalReference:{type:String,required:!0},metadata:{type:Object,default:()=>({})}},emits:["payment-success","payment-error"],setup(L,{emit:v}){const s=L,n=v,E=we(),I=i(!0),k=i(null),N=i(!1),z=i(null),p=i([]),b=i(null),A=i(!1);let V=null,x=null,y=null,P=0;function R(){return window.MercadoPago}function u(m=5e3){return new Promise((g,T)=>{if(R()){g(R());return}const q=Date.now(),M=setInterval(()=>{R()?(clearInterval(M),g(R())):Date.now()-q>m&&(clearInterval(M),T(new Error("Mercado Pago SDK no carg\xF3")))},100)})}async function ue(){var m,g;try{const T=await S.get("/payments/saved_payment_methods");z.value=((m=T.data)==null?void 0:m.mercadopago_customer_id)||null,p.value=(((g=T.data)==null?void 0:g.saved_payment_methods)||[]).filter(q=>q.mercadopago_card_id)}catch{z.value=null,p.value=[]}}async function d(){var m,g,T;if(z.value)return!0;try{const q=await S.post("/payments/create_or_get_customer");return z.value=((m=q.data)==null?void 0:m.mercadopago_customer_id)||null,Boolean(z.value)}catch(q){const M=((T=(g=q.response)==null?void 0:g.data)==null?void 0:T.detail)||q.message||"No se pudo crear el perfil de pago";return E.notify({type:"negative",message:M}),!1}}async function _(){var T,q;if(A.value)return;A.value=!0,P+=1;const m=P;I.value=!0,k.value=null,await Pe();const g=b.value;if(!g){I.value=!1,k.value="Contenedor de pago no encontrado",A.value=!1;return}if(g.innerHTML="",x!=null&&x.unmount)try{await x.unmount()}catch{}y&&clearTimeout(y),y=setTimeout(()=>{P===m&&(I.value=!1,k.value="El formulario de pago tard\xF3 demasiado en cargar. Intenta nuevamente.",A.value=!1)},2e4);try{const M="APP_USR-e7f45646-679d-466d-8067-5b8886da4126".trim()||"";if(!M)throw new Error("Falta VITE_MERCADOPAGO_PUBLIC_KEY en el .env del frontend");const ae=await u();await ue(),p.value.length>0&&!z.value&&await d();const K=new ae(M,{locale:"es-MX"}),Z=(s.userInfo.name||"Usuario").split(" "),X=Z[0]||"",te=Z.slice(1).join(" ")||"",ee=(((T=s.metadata)==null?void 0:T.payer_entity_type)||"").toString().toLowerCase()==="padelite"?"padelite":"individual",ce=ee==="padelite"?"padelite":"individual",J={amount:s.totalAmount,payer:{email:s.userInfo.email||"",firstName:X,lastName:te,entityType:ee,entity_type:ee,type:ce}};z.value&&p.value.length>0&&(J.customerId=z.value,J.cards=p.value.map(w=>({id:w.mercadopago_card_id,last_four_digits:w.last_four_digits,payment_method_id:w.payment_method_id,cardholderName:w.card_holder_name,expiration_month:w.expiration_month,expiration_year:w.expiration_year})));const oe={onSubmit:async({selectedPaymentMethod:w,formData:f})=>{var ne,se;try{const H=(f==null?void 0:f.paymentMethodId)||(f==null?void 0:f.payment_method_id)||(w==null?void 0:w.id)||(w==null?void 0:w.payment_method_id),D=f==null?void 0:f.token,e=f.cardholderName||f.cardHolderName||s.userInfo.name||"",t=f.lastFourDigits||f.last_four_digits||"",a=f.expirationMonth||f.expiration_month||"",h=f.expirationYear||f.expiration_year||"";if(!H||!D)throw new Error("Faltan datos de la tarjeta. Verifica el formulario e intenta nuevamente.");if(N.value&&D&&e&&t)if(!await d())N.value=!1;else try{await S.post("/payments/save_card_to_customer",{token:D,payment_method_id:H,last_four_digits:String(t).slice(-4),card_holder_name:e,expiration_month:a||"01",expiration_year:h||new Date().getFullYear().toString().slice(2)}),E.notify({type:"positive",message:"Tarjeta guardada para futuras compras",timeout:2e3})}catch(pe){console.warn("Save card failed (continuing with payment):",pe)}const Q={transaction_amount:s.totalAmount,description:`Pago por ${s.cartItems.length} items`,payment_method_id:H,payer:{email:s.userInfo.email,first_name:X,last_name:te},payment_method:{token:D,installments:f.installments||1,card_holder_name:e,issuer_id:f.issuerId||f.issuer_id||null},external_reference:s.externalReference,metadata:s.metadata},c=(await S.post("/payments/process_payment",Q)).data;c.status==="approved"||c.status==="pending"?n("payment-success",c):(n("payment-error",c.status_detail||"Pago no aprobado"),E.notify({type:"negative",message:c.status_detail||"Pago no aprobado"}))}catch(H){const D=((se=(ne=H.response)==null?void 0:ne.data)==null?void 0:se.detail)||H.message||"Error al procesar el pago";n("payment-error",D),E.notify({type:"negative",message:D})}},onReady:()=>{P===m&&(I.value=!1,A.value=!1,y&&(clearTimeout(y),y=null))},onError:w=>{P===m&&(I.value=!1,k.value=(w==null?void 0:w.message)||"Error al cargar el formulario de pago",n("payment-error",k.value),A.value=!1,y&&(clearTimeout(y),y=null))}};if(typeof K.bricks=="function")V=K.bricks();else if(typeof K.bricks=="object"&&typeof K.bricks.create=="function")V=K.bricks;else throw new Error("Mercado Pago Bricks no disponible en este SDK");const re={theme:"dark",textPrimaryColor:"#ffffff",textSecondaryColor:"rgba(255, 255, 255, 0.75)",inputBackgroundColor:"#1e1e1e",formBackgroundColor:"#2c2c2c",baseColor:"#CFE74E",baseColorFirstVariant:"#b8d042",baseColorSecondVariant:"#a3b93a",errorColor:"#C10015",successColor:"#2e7d32",outlinePrimaryColor:"#CFE74E",outlineSecondaryColor:"#61127C",buttonTextColor:"#000000",fontSizeExtraSmall:"11px",fontSizeSmall:"13px",fontSizeMedium:"15px",fontSizeLarge:"17px",fontSizeExtraLarge:"19px",fontWeightNormal:"400",fontWeightSemiBold:"600",formInputsTextTransform:"none",inputVerticalPadding:"12px",inputHorizontalPadding:"14px",inputFocusedBoxShadow:"0 0 0 2px #CFE74E",inputErrorFocusedBoxShadow:"0 0 0 2px #C10015",inputBorderWidth:"1px",inputFocusedBorderWidth:"2px",borderRadiusSmall:"4px",borderRadiusMedium:"8px",borderRadiusLarge:"12px",borderRadiusFull:"9999px",formPadding:"20px"};console.log("CheckoutBricks init config",J),x=await V.create("payment","payment-brick-container",{initialization:J,customization:{paymentMethods:{creditCard:"all",debitCard:"all"},visual:{style:re}},callbacks:oe})}catch(M){console.error("CheckoutBricks init error",((q=M==null?void 0:M.response)==null?void 0:q.data)||M),P===m&&(I.value=!1,k.value=M.message||"Error al inicializar el pago",n("payment-error",k.value),E.notify({type:"negative",message:k.value}),A.value=!1,y&&(clearTimeout(y),y=null))}}return ke(()=>{Pe(()=>{setTimeout(()=>{_()},250)})}),je(()=>{const m=b.value;if(m&&(m.innerHTML=""),x!=null&&x.unmount)try{x.unmount()}catch{}y&&(clearTimeout(y),y=null)}),xe(()=>[s.totalAmount,s.externalReference],()=>{!I.value&&!k.value&&_()}),xe(N,async m=>{m&&(await d()||(N.value=!1))}),(m,g)=>(C(),G("div",ba,[g[2]||(g[2]=o("div",{class:"header"},[o("img",{src:Be,alt:"Logo Mercado Pago",class:"brand"}),o("p",{class:"text-caption"},"Ingresa los datos de tu tarjeta de manera segura")],-1)),k.value?(C(),G("div",xa,[r(W,{name:"error",size:"3rem"}),o("p",ka,$(k.value),1),r(Y,{color:"primary",label:"Reintentar",onClick:_,class:"q-mt-md"})])):j("",!0),o("div",wa,[r(ze,{modelValue:N.value,"onUpdate:modelValue":g[0]||(g[0]=T=>N.value=T),label:"Guardar tarjeta para futuras compras",color:"primary",dark:"",class:"q-mb-md text-white"},null,8,["modelValue"]),o("div",Ca,[o("div",{ref_key:"paymentBrickContainer",ref:b,id:"payment-brick-container",class:"payment-brick-container"},null,512),I.value?(C(),G("div",Ia,[r(ge,{color:"primary",size:"3rem"}),g[1]||(g[1]=o("p",{class:"q-mt-md text-white"},"Cargando formulario de pago...",-1))])):j("",!0)])])]))}};var Ea=Ce(Pa,[["__scopeId","data-v-2355bf7e"]]);const Sa={name:"MercadoPayment",components:{CheckoutAPI:ha,CheckoutBricks:Ea,PlayerNavigationMenu:Je},setup(){const L=Oe(),v=Qe(),s=we(),n=i(!0),E=i(null),I=i([]),k=i({}),N=i(null),z=i(null),p=i(!1),b=i(!1),A=i(!1),V=i(""),x=be(()=>I.value.reduce((d,_)=>d+_.unit_price*_.quantity,0).toFixed(2)),y=!0,P=async()=>{n.value=!0,E.value=null;try{try{const _=await S.get("/payments/demo-status");p.value=_.data.demo_mode}catch(_){console.warn("Could not check demo status:",_)}const d=v.params.paymentData||JSON.parse(localStorage.getItem("mercadoPaymentData")||"{}");if(!d.cartItems||!d.userInfo)throw new Error("Datos de pago incompletos");I.value=d.cartItems,k.value=d.userInfo,N.value=d.externalReference,z.value=d.metadata,n.value=!1}catch{E.value="Error al cargar los datos de pago. Por favor, int\xE9ntalo nuevamente.",n.value=!1}},R=async d=>{var m,g,T,q,M,ae,K,Z,X,te,ie,ee,ce,J,oe,re,w,f,ne,se,H,D,e,t;console.log("Payment successful:",d);const _=localStorage.getItem("mercadoPaymentData");if(localStorage.removeItem("mercadoPaymentData"),d.status==="approved"){let a={};try{a=JSON.parse(_||"{}")}catch(B){console.error("Error parsing payment data:",B)}const h=(m=a.metadata)==null?void 0:m.item_type,Q=(g=a.metadata)==null?void 0:g.payment_order_id;if(console.log("Processing finalization for item type:",h),console.log("Payment metadata:",a.metadata),h&&Q){const B={baseData:{clubId:(T=a.metadata)==null?void 0:T.club_id,id:(q=a.metadata)==null?void 0:q.item_id,participants:((M=a.metadata)==null?void 0:M.participants)||1},extraData:{date:(ae=a.metadata)==null?void 0:ae.date,time:(K=a.metadata)==null?void 0:K.time,duration:((Z=a.metadata)==null?void 0:Z.duration)||60,paymentOption:((X=a.metadata)==null?void 0:X.payment_option)||"total",isPublicMatch:((te=a.metadata)==null?void 0:te.is_public_match)||!1,partnerId:(ie=a.metadata)==null?void 0:ie.partner_id,isRetas:(ee=a.metadata)==null?void 0:ee.is_retas,matchId:(ce=a.metadata)==null?void 0:ce.match_id,slotIndex:(J=a.metadata)==null?void 0:J.slot_index,teamToJoin:(oe=a.metadata)==null?void 0:oe.team_to_join},selectedProducts:((re=a.metadata)==null?void 0:re.additional_items)||[],paymentOrderId:Q,totalAmount:((w=a.metadata)==null?void 0:w.total_amount)||((ne=(f=a.cartItems)==null?void 0:f[0])==null?void 0:ne.unit_price)||0,amountToPay:((se=a.metadata)==null?void 0:se.amount_to_pay)||((D=(H=a.cartItems)==null?void 0:H[0])==null?void 0:D.unit_price)||0,itemDetails:((e=a.metadata)==null?void 0:e.item_details)||[],paymentOption:((t=a.metadata)==null?void 0:t.payment_option)||"total"};try{let c={success:!1},U="/player/dashboard";h==="court"?(c=await Ye(d,B,S,s),c.success&&c.matchId&&(U=`/player/match/${c.matchId}`)):h==="class"||h==="private_lesson"?(c=await We(d,B,S,s),c.success&&c.path&&(U=c.path)):h==="public_lesson"?c=await Ge(d,B,S,s):h==="match"||h==="match_join"||h==="open_match_join"?(c=await Ze(d,B,S,s),c.success&&c.matchId&&(U=`/player/match/${c.matchId}`)):h==="tournament"?c=await Xe(d,B,S,s):(console.warn("Unknown item type:",h),s.notify({type:"warning",message:"Tipo de compra no reconocido, pero el pago fue exitoso.",timeout:3e3}),c={success:!0}),c.success?(localStorage.setItem("mercadoPagoSuccessRedirect",U),b.value=!0):u("El pago fue exitoso, pero hubo un problema al completar la operaci\xF3n. Contacta al soporte.")}catch(c){console.error("Error during finalization:",c),u("El pago fue exitoso, pero hubo un problema al completar la operaci\xF3n. Contacta al soporte.")}}else console.warn("Could not determine item type or payment order ID"),b.value=!0}else d.status==="pending"?(s.notify({type:"info",message:"Tu pago est\xE1 siendo procesado. Te notificaremos cuando se complete.",timeout:5e3}),setTimeout(()=>{L.push("/player/dashboard")},2e3)):u("El pago no fue aprobado. Por favor, intenta con otro m\xE9todo de pago.")},u=d=>{console.error("Payment error:",d),V.value=d,A.value=!0},ue=()=>{b.value=!1;const d=localStorage.getItem("mercadoPagoSuccessRedirect");localStorage.removeItem("mercadoPagoSuccessRedirect"),d?L.push(d).catch(_=>{console.error("Error navigating to stored path:",_),L.push("/player/dashboard")}):L.push("/player/dashboard").catch(()=>{L.push("/")})};return ke(()=>{P()}),{loading:n,error:E,cartItems:I,userInfo:k,externalReference:N,metadata:z,demoModeActive:p,totalAmount:x,useCheckoutBricks:y,showSuccessDialog:b,showErrorDialog:A,paymentErrorMessage:V,initPayment:P,handlePaymentSuccess:R,handlePaymentError:u,navigateToSuccess:ue}}},Na={class:"row q-col-gutter-md"},qa={class:"col-12 col-md-6"},Ma={class:"row justify-between"},za={class:"row justify-between text-h6"},Ta={class:"col-12 col-md-6"},Ba={class:"text-center"},Aa={class:"text-center text-negative"},Va={class:"q-mt-md"},Ra={key:0,class:"col-12 brick-full-width"};function Fa(L,v,s,n,E,I){const k=he("CheckoutAPI"),N=he("CheckoutBricks"),z=he("PlayerNavigationMenu");return C(),F($e,{view:"hHh lpR fFf",class:"text-white"},{default:l(()=>[r(Ae,{elevated:"",class:"text-white"},{default:l(()=>[...v[3]||(v[3]=[o("div",{class:"header-content"},[o("div",{class:"greeting"},[o("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon"})]),o("div",{class:"header-icons"})],-1)])]),_:1}),r(Le,{class:"home"},{default:l(()=>[r(Ue,{class:"q-pa-md"},{default:l(()=>[n.demoModeActive?(C(),F(Te,{key:0,class:"bg-secondary text-white q-mb-md"},{avatar:l(()=>[r(W,{name:"info",color:"white"})]),default:l(()=>[v[4]||(v[4]=o("strong",null,"MODO DEMOSTRACI\xD3N ACTIVO",-1)),v[5]||(v[5]=o("div",{class:"text-caption"}," Todos los pagos se aprueban autom\xE1ticamente para prop\xF3sitos de demostraci\xF3n. ",-1))]),_:1})):j("",!0),o("div",Na,[o("div",qa,[r(le,{class:"text-white"},{default:l(()=>[r(O,null,{default:l(()=>[...v[6]||(v[6]=[o("h4",{class:"text-white q-my-none"},"Resumen de la compra",-1)])]),_:1}),r(O,null,{default:l(()=>[(C(!0),G(qe,null,Ne(n.cartItems,p=>(C(),G("div",{key:p.id,class:"q-mb-sm"},[o("div",Ma,[o("span",null,$(p.title)+" (x"+$(p.quantity)+")",1),o("span",null,"$"+$((p.unit_price*p.quantity).toFixed(2)),1)])]))),128)),r(Me,{class:"q-my-md"}),o("div",za,[o("strong",null,"Total: $"+$(n.totalAmount),1)])]),_:1})]),_:1})]),o("div",Ta,[n.loading?(C(),F(le,{key:0,class:"text-white"},{default:l(()=>[r(O,null,{default:l(()=>[o("div",Ba,[r(ge,{color:"primary",size:"3rem"}),v[7]||(v[7]=o("p",{class:"q-mt-md"},"Cargando formulario de pago...",-1))])]),_:1})]),_:1})):n.error?(C(),F(le,{key:1,class:"text-white"},{default:l(()=>[r(O,null,{default:l(()=>[o("div",Aa,[r(W,{name:"error",size:"3rem"}),o("p",Va,$(n.error),1),r(Y,{color:"primary",label:"Reintentar",onClick:n.initPayment,class:"q-mt-md"},null,8,["onClick"])])]),_:1})]),_:1})):n.useCheckoutBricks?j("",!0):(C(),F(k,{key:2,"cart-items":n.cartItems,"user-info":n.userInfo,"total-amount":parseFloat(n.totalAmount),"external-reference":n.externalReference,metadata:n.metadata,onPaymentSuccess:n.handlePaymentSuccess,onPaymentError:n.handlePaymentError},null,8,["cart-items","user-info","total-amount","external-reference","metadata","onPaymentSuccess","onPaymentError"]))]),n.useCheckoutBricks&&!n.loading&&!n.error?(C(),G("div",Ra,[r(N,{"cart-items":n.cartItems,"user-info":n.userInfo,"total-amount":parseFloat(n.totalAmount),"external-reference":n.externalReference,metadata:n.metadata,onPaymentSuccess:n.handlePaymentSuccess,onPaymentError:n.handlePaymentError},null,8,["cart-items","user-info","total-amount","external-reference","metadata","onPaymentSuccess","onPaymentError"])])):j("",!0)]),r(Ee,{modelValue:n.showSuccessDialog,"onUpdate:modelValue":v[0]||(v[0]=p=>n.showSuccessDialog=p),persistent:""},{default:l(()=>[r(le,{class:"text-center"},{default:l(()=>[r(O,null,{default:l(()=>[r(W,{name:"check_circle",color:"positive",size:"4rem"}),v[8]||(v[8]=o("h4",{class:"q-my-md"},"\xA1Pago exitoso!",-1)),v[9]||(v[9]=o("p",null,"Tu pago ha sido procesado correctamente.",-1))]),_:1}),r(Se,{align:"center"},{default:l(()=>[r(Y,{color:"primary",label:"Continuar",onClick:n.navigateToSuccess},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),r(Ee,{modelValue:n.showErrorDialog,"onUpdate:modelValue":v[2]||(v[2]=p=>n.showErrorDialog=p)},{default:l(()=>[r(le,{class:"text-center"},{default:l(()=>[r(O,null,{default:l(()=>[r(W,{name:"error",color:"negative",size:"4rem"}),v[10]||(v[10]=o("h4",{class:"q-my-md"},"Error en el pago",-1)),o("p",null,$(n.paymentErrorMessage),1)]),_:1}),r(Se,{align:"center"},{default:l(()=>[r(Y,{color:"primary",label:"Intentar nuevamente",onClick:v[1]||(v[1]=p=>n.showErrorDialog=!1)})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),r(z)]),_:1})}var rt=Ce(Sa,[["render",Fa],["__scopeId","data-v-22547117"]]);export{rt as default};
