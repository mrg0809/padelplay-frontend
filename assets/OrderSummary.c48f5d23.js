import{Q as be}from"./QSpinnerCube.49ec10d2.js";import{F as xe,r as D,a as $e,j as P,w as ue,q as n,G as $,H as r,v as o,I as i,ab as de,ac as q,x as m,s as c,ae as A,af as E,aO as T,ad as g,y as I,ag as ce,aM as Ve,aN as Be,ah as pe,J as b,ai as ye,aj as Fe,aP as Re,B as Ae,a2 as Ee,aa as fe,aQ as Ie,aR as je}from"./index.0dae1473.js";import{u as ze}from"./summaryStore.2666e2ae.js";import{Q as Je}from"./QHeader.daa47c6c.js";import{Q as Le}from"./QTooltip.2ad4dabb.js";import{Q as Ue}from"./QPage.93249297.js";import{a as Me,Q as Ge}from"./QLayout.c8e0bf98.js";import{Q as He}from"./QSpace.d4ca8845.js";import{Q as Ke}from"./QSpinnerDots.09070328.js";import{Q as ge}from"./QItemLabel.abb776d6.js";import{Q as We,a as _e}from"./QItem.73fbae79.js";import{C as ve}from"./ClosePopup.6ca29b01.js";import{u as Xe}from"./use-quasar.5ccf209f.js";import{g as Ye}from"./products.e3ee38ef.js";import{u as Ze}from"./userStore.3198d202.js";import{a as ea}from"./api.2af71db3.js";import{P as aa}from"./PlayerNavigationMenu.1db31516.js";import{_ as De}from"./plugin-vue_export-helper.21dcd24c.js";import{D as ta}from"./DesktopNavigation.1304785f.js";import"./pinia.8dcdf680.js";import"./position-engine.0d8bf4bb.js";import"./selection.94b8945c.js";import"./supabase.25da9554.js";import"./QTabs.dbece195.js";import"./rtl.276c3f1b.js";import"./QFooter.aca25710.js";const oa={class:"text-white"},sa={key:0},la={class:"q-ml-md q-mb-sm",style:{"list-style-type":"none","padding-left":"0"}},ra={class:"text-h6"},ia={key:2,class:"text-caption q-mt-sm"},na={key:0,class:"text-center q-pa-md"},ma={key:1,class:"text-grey-7 q-pa-md text-center"},ua={class:"row items-center no-wrap"},da={class:"text-h6 text-black text-weight-bold q-mx-xs",style:{"min-width":"25px","text-align":"center"}},ca={__name:"OrderComponent",props:{summaryTitle:{type:String,required:!0,default:"Resumen"},itemDetails:{type:Array,required:!0,default:()=>[]},baseData:{type:Object,required:!0},commissionRate:{type:Number,default:4},showPublicToggle:{type:Boolean,default:!1},allowPaymentSplit:{type:Boolean,default:!1},extraData:{type:Object,default:()=>({})}},setup(y){var J,L,U;const e=y,h=xe(),k=Xe(),V=Ze();console.log("OrderComponent - Props received:"),console.log("baseData:",e.baseData),console.log("extraData:",e.extraData),console.log("baseData.player2_email:",(J=e.baseData)==null?void 0:J.player2_email),console.log("extraData.player2_email:",(L=e.extraData)==null?void 0:L.player2_email);const d=D([]),l=$e({}),p=D([]),Q=D(!1),B=D(!1),S=D(!1),F=D(!1),f=D(e.allowPaymentSplit&&((U=e.baseData)==null?void 0:U.participants)>1?"partial":"total"),R=P(()=>{var t;return(((t=e.baseData)==null?void 0:t.price)||0)+j.value}),Pe=P(()=>R.value*(e.commissionRate/100)),j=P(()=>p.value.reduce((a,t)=>a+t.product.price*t.quantity,0)),_=P(()=>R.value+Pe.value),he=P(()=>{var a;return[{label:`Pagar mi parte (1/${((a=e.baseData)==null?void 0:a.participants)||1})`,value:"partial"},{label:"Pagar el total",value:"total"}]}),we=P(()=>{var s;const a=((s=e.baseData)==null?void 0:s.participants)||1;let t=_.value;return e.allowPaymentSplit&&a>1&&f.value==="partial"&&(t=_.value/a),`Pagar $${t.toFixed(2)}`}),z=async()=>{var a;if(!((a=e.baseData)!=null&&a.clubId)){d.value=[];return}B.value=!0;try{const t=await Ye(e.baseData.clubId);d.value=t||[],d.value.forEach(s=>{l[s.id]===void 0&&(l[s.id]=0)})}catch(t){console.error("Error al cargar productos:",t),d.value=[],k.notify({type:"warning",message:"No se pudieron cargar los productos adicionales."})}finally{B.value=!1}},ke=()=>{var a;d.value.length===0&&((a=e.baseData)==null?void 0:a.clubId)?z():p.value.length===0&&d.value.forEach(t=>{l[t.id]=0}),Q.value=!0},Qe=a=>{(l[a]===void 0||l[a]===null||isNaN(Number(l[a])))&&(l[a]=0);const t=Number(l[a]);t>0&&(l[a]=t-1)},qe=a=>{(l[a]===void 0||l[a]===null||isNaN(Number(l[a])))&&(l[a]=0);const t=Number(l[a]);l[a]=t+1},Se=()=>{p.value=d.value.filter(a=>l[a.id]&&Number(l[a.id])>0).map(a=>({product:{id:a.id,name:a.name,price:a.price},quantity:Number(l[a.id])})),Q.value=!1},Ne=()=>{Ce("mercadopago")},Ce=async a=>{var t,s,u,N,M,G,H,K,W,X,Y,Z,ee,ae,te,oe,se,le,re,ie,ne;F.value=!0,k.loading.show({spinner:be,message:"Generando orden de pago..."});try{const v=((t=e.baseData)==null?void 0:t.participants)||1;let w=_.value,me=!0;e.allowPaymentSplit&&v>1&&f.value==="partial"&&(w=_.value/v,me=!1);const x={total_price:_.value,pay_total:me,item_id:(s=e.baseData)==null?void 0:s.id,item_type:(u=e.baseData)==null?void 0:u.type,club_id:(N=e.baseData)==null?void 0:N.clubId,recipient_id:(M=e.baseData)==null?void 0:M.recipient_user_id,participants:v,products:p.value.map(O=>({id:O.product.id,quantity:O.quantity})),is_public:e.showPublicToggle?S.value:void 0};((G=e.baseData)==null?void 0:G.type)==="tournament"&&(x.player2_email=(W=(H=e.baseData)==null?void 0:H.player2_email)!=null?W:(K=e.extraData)==null?void 0:K.player2_email,x.tournament_name=(X=e.extraData)==null?void 0:X.tournament_name,x.is_retas=((Y=e.extraData)==null?void 0:Y.isRetas)||!1,console.log("Tournament registration - baseData:",e.baseData),console.log("Tournament registration - extraData:",e.extraData),console.log("Tournament registration - baseData.player2_email:",(Z=e.baseData)==null?void 0:Z.player2_email),console.log("Tournament registration - extraData.player2_email:",(ee=e.extraData)==null?void 0:ee.player2_email),console.log("Tournament registration - final player2_email:",x.player2_email),console.log("Tournament registration - is_retas:",x.is_retas)),console.log("Enviando a API /payment_order_and_split_payment:",x);const C=(ae=(await ea.post("payments/payment_order_and_split_payment",x)).data)==null?void 0:ae.payment_order_id;if(!C)throw new Error("Respuesta inv\xE1lida del servidor: No se recibi\xF3 payment_order_id.");if(a==="stripe")h.push({name:"StripePayment",query:{paymentOrderId:C,amountToPay:w.toFixed(2),totalAmount:_.value.toFixed(2),description:e.summaryTitle,clubId:(te=e.baseData)==null?void 0:te.clubId,baseData:JSON.stringify(e.baseData||{}),extraData:JSON.stringify(e.extraData||{}),selectedProducts:JSON.stringify(p.value||[]),itemDetails:JSON.stringify(e.itemDetails||[]),paymentOption:f.value}});else if(a==="mercadopago"){const O=[{id:((oe=e.baseData)==null?void 0:oe.id)||"item_1",title:e.summaryTitle,quantity:1,unit_price:w}],Oe={email:V.email||"user@example.com",name:V.fullName||"Usuario"},Te={cartItems:O,userInfo:Oe,externalReference:C,metadata:{payment_order_id:C,club_id:(se=e.baseData)==null?void 0:se.clubId,item_type:(le=e.baseData)==null?void 0:le.type,amount_to_pay:w,payment_option:f.value,item_id:(re=e.baseData)==null?void 0:re.id,participants:v,is_public_match:e.showPublicToggle?S.value:!1,total_amount:_.value,additional_items:p.value,...e.extraData&&{date:e.extraData.date,time:e.extraData.time,duration:e.extraData.duration,reservation_date:e.extraData.date,start_time:e.extraData.time,lesson_date:e.extraData.date,lesson_time:e.extraData.time,tournament_id:e.extraData.tournament_id,partner_id:e.extraData.partner_id,is_retas:e.extraData.is_retas,match_id:e.extraData.match_id,slot_index:e.extraData.slot_index,team_to_join:e.extraData.team_to_join},item_details:e.itemDetails}};localStorage.setItem("mercadoPaymentData",JSON.stringify(Te)),h.push({name:"MercadoPayment"})}}catch(v){console.error("Error en processPayment:",v);const w=((ne=(ie=v.response)==null?void 0:ie.data)==null?void 0:ne.message)||v.message||"Error al procesar el pago. Por favor intente de nuevo.";k.notify({type:"negative",message:w})}finally{F.value=!1,k.loading.hide()}};return ue(()=>{var a;return(a=e.baseData)==null?void 0:a.clubId},(a,t)=>{a&&a!==t&&(d.value=[],p.value=[],Object.keys(l).forEach(s=>delete l[s]),z())},{immediate:!0}),ue(()=>e.allowPaymentSplit,a=>{var t;a&&((t=e.baseData)==null?void 0:t.participants)>1?f.value="partial":f.value="total"},{immediate:!0}),(a,t)=>(n(),$(Ge,{view:"hHh lpR fFf",class:"text-white"},{default:r(()=>[o(Je,{elevated:"",class:"text-white"},{default:r(()=>t[3]||(t[3]=[i("div",{class:"header-content"},[i("div",{class:"greeting"},[i("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon"})]),i("div",{class:"header-icons"})],-1)])),_:1}),o(Me,{class:"home"},{default:r(()=>[o(Ue,{class:"q-pa-md"},{default:r(()=>[o(de,{class:"text-white"},{default:r(()=>[o(q,null,{default:r(()=>[i("h3",oa,m(e.summaryTitle),1)]),_:1}),o(q,null,{default:r(()=>{var s;return[(n(!0),c(E,null,A(e.itemDetails,(u,N)=>(n(),c("p",{key:N},[i("strong",null,m(u.label)+":",1),g(" "+m(u.value),1)]))),128)),o(T,{dark:"",spaced:"sm"}),i("p",null,[t[4]||(t[4]=i("strong",null,"Precio Base:",-1)),g(" $"+m(((s=e.baseData.price)==null?void 0:s.toFixed(2))||"0.00"),1)]),p.value.length>0?(n(),c("div",sa,[i("p",null,[t[5]||(t[5]=i("strong",null,"Adicionales:",-1)),g(" $"+m(j.value.toFixed(2)),1)]),i("ul",la,[(n(!0),c(E,null,A(p.value,u=>(n(),c("li",{key:u.product.id,class:"text-caption"},[o(ce,{name:"mdi-cart-outline",size:"xs",class:"q-mr-xs"}),g(" "+m(u.product.name)+" x "+m(u.quantity)+" - $"+m((u.product.price*u.quantity).toFixed(2)),1)]))),128))])])):I("",!0),i("p",null,[t[6]||(t[6]=i("strong",null,"Subtotal:",-1)),g(" $"+m(R.value.toFixed(2)),1)]),o(T,{dark:"",spaced:"sm"}),i("p",ra,[t[7]||(t[7]=i("strong",null,"Total a pagar:",-1)),g(" $"+m(_.value.toFixed(2))+" ",1),o(ce,{name:"o_info",size:"sm",class:"cursor-help q-ml-xs"},{default:r(()=>[o(Le,{anchor:"top middle",self:"bottom middle",offset:[0,10],class:"bg-grey-9 text-body2"},{default:r(()=>[g(" Precio total (Base + Adicionales + Comisi\xF3n del "+m(e.commissionRate)+"%). ",1)]),_:1})]),_:1})])]}),_:1}),o(q,{class:"q-pt-none"},{default:r(()=>[e.showPublicToggle?(n(),$(Ve,{key:0,modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=s=>S.value=s),"checked-icon":"check",color:"primary",label:"Partido P\xFAblico (otros podr\xE1n unirse)",class:"q-mb-sm"},null,8,["modelValue"])):I("",!0),e.allowPaymentSplit&&e.baseData.participants>1?(n(),$(Be,{key:1,modelValue:f.value,"onUpdate:modelValue":t[1]||(t[1]=s=>f.value=s),options:he.value,color:"primary",inline:"",dense:""},null,8,["modelValue","options"])):e.baseData.participants>1?(n(),c("div",ia," Nota: El pago es individual por participante. ")):I("",!0)]),_:1}),o(pe,{align:"right",class:"q-pa-md"},{default:r(()=>[o(b,{icon:"mdi-basket-plus-outline",label:"Productos",color:"primary",onClick:ke,dense:""}),o(b,{label:we.value,color:"green","icon-right":"mdi-credit-card-outline",onClick:Ne,loading:F.value,padding:"sm lg"},null,8,["label","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),o(Fe,{modelValue:Q.value,"onUpdate:modelValue":t[2]||(t[2]=s=>Q.value=s)},{default:r(()=>[o(de,{style:{"min-width":"300px","max-width":"400px"},class:"bg-grey-2 text-black"},{default:r(()=>[o(q,{class:"row items-center q-pb-none bg-primary text-white"},{default:r(()=>[t[8]||(t[8]=i("div",{class:"text-h6"},"A\xF1adir Productos",-1)),o(He),ye(o(b,{icon:"close",flat:"",round:"",dense:""},null,512),[[ve]])]),_:1}),o(q,{style:{"max-height":"60vh","overflow-y":"auto"}},{default:r(()=>[B.value?(n(),c("div",na,[o(Ke,{color:"primary",size:"40px"}),t[9]||(t[9]=i("div",{class:"q-mt-sm"},"Cargando...",-1))])):!d.value||d.value.length===0?(n(),c("div",ma," No hay productos adicionales disponibles en este club. ")):(n(!0),c(E,{key:2},A(d.value,s=>(n(),c("div",{key:s.id,class:"q-mb-xs"},[o(We,{dense:""},{default:r(()=>[o(_e,null,{default:r(()=>[o(ge,{class:"text-weight-medium text-black"},{default:r(()=>[g(m(s.name),1)]),_:2},1024),o(ge,{caption:""},{default:r(()=>[g("$"+m(s.price.toFixed(2)),1)]),_:2},1024)]),_:2},1024),o(_e,{side:"",top:""},{default:r(()=>[i("div",ua,[o(b,{icon:"mdi-minus",color:"negative",round:"",dense:"",flat:"",size:"sm",onClick:u=>Qe(s.id),disable:!l[s.id]||l[s.id]<=0,class:"q-mr-xs"},null,8,["onClick","disable"]),i("span",da,m(l[s.id]||0),1),o(b,{icon:"mdi-plus",color:"positive",round:"",dense:"",flat:"",size:"sm",onClick:u=>qe(s.id),class:"q-ml-xs"},null,8,["onClick"])])]),_:2},1024)]),_:2},1024),o(T,{spaced:"xs"})]))),128))]),_:1}),o(T),o(pe,{align:"right",class:"q-pa-md"},{default:r(()=>[ye(o(b,{label:"Cancelar",color:"grey-7",flat:""},null,512),[[ve]]),o(b,{label:"Aceptar",color:"primary",push:"",onClick:Se})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(aa)]),_:1}))}};var pa=De(ca,[["__scopeId","data-v-4be28148"]]);const ya=Re({name:"OrderSummary",components:{OrderComponent:pa,DesktopNavigation:ta},setup(){const y=ze(),e=xe(),h=P(()=>y.getSummaryDetails);return Ae(()=>{y.hasActiveSummary?console.log("ReservationSummaryPage mounted with data:",h.value):(console.warn("No hay datos de resumen en el store. Redirigiendo..."),e.replace({name:"DashboardPlayer"}))}),Ee(()=>{y.clearSummaryDetails()}),{summaryData:h}}}),fa={key:1,class:"fullscreen text-white text-center q-pa-md flex flex-center"};function ga(y,e,h,k,V,d){const l=fe("OrderComponent"),p=fe("DesktopNavigation");return n(),c("div",null,[y.summaryData?(n(),$(l,Ie(je({key:0},y.summaryData)),null,16)):(n(),c("div",fa,[i("div",null,[o(be,{color:"primary",size:"xl"}),e[1]||(e[1]=i("div",{class:"q-mt-md text-h6"},"Cargando resumen...",-1)),o(b,{class:"q-mt-xl",color:"white","text-color":"black",unelevated:"",onClick:e[0]||(e[0]=Q=>y.$router.go(-1)),label:"Volver","no-caps":""})])])),o(p)])}var La=De(ya,[["render",ga]]);export{La as default};
