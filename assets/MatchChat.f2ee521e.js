import{k as E,j as f,p as o,bv as R,r as b,B as N,a2 as T,q as M,G as w,H as u,v as d,a9 as $,I as p,s as L,ac as P,ad as j,K as V,bF as z,J as k,a7 as F,a8 as I}from"./index.743d29a7.js";import{Q as K}from"./QHeader.c54c4dab.js";import{Q as B}from"./QPage.399b9a9b.js";import{a as H,Q as S}from"./QLayout.166d0f49.js";import{s as x}from"./supabase.846d8680.js";import{_ as U}from"./plugin-vue_export-helper.21dcd24c.js";import{P as D}from"./PlayerNavigationMenu.8bca405a.js";import"./QTabs.243f63db.js";import"./rtl.276c3f1b.js";import"./QFooter.962d26d2.js";var Q=E({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(e,{slots:t}){const l=f(()=>e.sent===!0?"sent":"received"),s=f(()=>`q-message-text-content q-message-text-content--${l.value}`+(e.textColor!==void 0?` text-${e.textColor}`:"")),v=f(()=>`q-message-text q-message-text--${l.value}`+(e.bgColor!==void 0?` text-${e.bgColor}`:"")),_=f(()=>"q-message-container row items-end no-wrap"+(e.sent===!0?" reverse":"")),n=f(()=>e.size!==void 0?`col-${e.size}`:""),i=f(()=>({msg:e.textHtml===!0?"innerHTML":"textContent",stamp:e.stampHtml===!0?"innerHTML":"textContent",name:e.nameHtml===!0?"innerHTML":"textContent",label:e.labelHtml===!0?"innerHTML":"textContent"}));function h(c){return t.stamp!==void 0?[c,o("div",{class:"q-message-stamp"},t.stamp())]:e.stamp?[c,o("div",{class:"q-message-stamp",[i.value.stamp]:e.stamp})]:[c]}function C(c,m){const a=m===!0?c.length>1?r=>r:r=>o("div",[r]):r=>o("div",{[i.value.msg]:r});return c.map((r,g)=>o("div",{key:g,class:v.value},[o("div",{class:s.value},h(a(r)))]))}return()=>{const c=[];t.avatar!==void 0?c.push(t.avatar()):e.avatar!==void 0&&c.push(o("img",{class:`q-message-avatar q-message-avatar--${l.value}`,src:e.avatar,"aria-hidden":"true"}));const m=[];t.name!==void 0?m.push(o("div",{class:`q-message-name q-message-name--${l.value}`},t.name())):e.name!==void 0&&m.push(o("div",{class:`q-message-name q-message-name--${l.value}`,[i.value.name]:e.name})),t.default!==void 0?m.push(C(R(t.default()),!0)):e.text!==void 0&&m.push(C(e.text)),c.push(o("div",{class:n.value},m));const a=[];return t.label!==void 0?a.push(o("div",{class:"q-message-label"},t.label())):e.label!==void 0&&a.push(o("div",{class:"q-message-label",[i.value.label]:e.label})),a.push(o("div",{class:_.value},c)),o("div",{class:`q-message q-message-${l.value}`},a)}}});const J={props:{matchId:{type:String,required:!0}},components:{QChatMessage:Q},setup(e){const t=b([]),l=b(""),s=b(null),v=b({full_name:"Usuario desconocido"}),_=b({});let n=null;const i=async()=>{try{const{data:a,error:r}=await x.from("chat_messages").select("*").eq("match_id",e.matchId).order("timestamp",{ascending:!0});r?console.error("Error al cargar mensajes:",r):t.value=a}catch(a){console.error("Error inesperado al cargar mensajes:",a)}},h=async a=>{try{const{data:r,error:g}=await x.from("players").select("user_id, first_name, photo_url").in("user_id",a);g?console.error("Error al obtener detalles de usuarios:",g):r.forEach(y=>{_.value[y.user_id]=y})}catch(r){console.error("Error inesperado al obtener detalles de usuarios:",r)}},C=async()=>{try{const{error:a}=await x.from("chat_messages").insert({match_id:e.matchId,sender:v.value.full_name,sender_id:s.value,message:l.value.trim()});a?console.error("Error al enviar mensaje:",a):l.value=""}catch(a){console.error("Error inesperado al enviar mensaje:",a)}},c=()=>{n=x.channel("public:chat_messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`match_id=eq.${e.matchId}`},a=>{t.value.push(a.new)}).subscribe(a=>{a==="SUBSCRIBED"&&console.log("Realtime subscription active")})},m=a=>new Date(a).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});return N(async()=>{const a=localStorage.getItem("token");if(a){const y=a.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),q=JSON.parse(atob(y));s.value=q.sub,v.value.full_name=q.full_name||"Usuario desconocido"}await i();const r=t.value.map(g=>g.sender_id);await h(r),c()}),T(()=>{n&&x.removeChannel(n)}),{currentUserId:s,messages:t,newMessage:l,formatTimestamp:m,sendMessage:C,user:v,userMap:_}}},A={class:"chat-messages"},G={class:"chat-message-input"};function O(e,t,l,s,v,_){return M(),w(S,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:u(()=>[d(H,null,{default:u(()=>[d(B,null,{default:u(()=>[d($,{class:"text-white chat-card"},{default:u(()=>[p("div",A,[(M(!0),L(j,null,P(s.messages,n=>{var i,h;return M(),w(Q,{key:n.id,name:((i=s.userMap[n.sender_id])==null?void 0:i.first_name)||"Usuario desconocido",avatar:(h=s.userMap[n.sender_id])==null?void 0:h.photo_url,text:[n.message],stamp:s.formatTimestamp(n.timestamp),sent:n.sender_id===s.currentUserId,"bg-color":n.sender_id===s.currentUserId?"amber-7":"primary","text-color":n.sender_id===s.currentUserId?"black":"white"},null,8,["name","avatar","text","stamp","sent","bg-color","text-color"])}),128))])]),_:1}),p("div",G,[d(V,{modelValue:s.newMessage,"onUpdate:modelValue":t[0]||(t[0]=n=>s.newMessage=n),placeholder:"Escribe un mensaje...",outlined:"",dense:"",dark:"",onKeyup:z(s.sendMessage,["enter"])},null,8,["modelValue","onKeyup"]),d(k,{color:"black",onClick:s.sendMessage,disable:!s.newMessage.trim(),icon:"o_send"},null,8,["onClick","disable"])])]),_:1})]),_:1})]),_:1})}var X=U(J,[["render",O],["__scopeId","data-v-16742b44"]]);const W={components:{MatchChatRoom:X,PlayerNavigationMenu:D},setup(){return{matchId:F().params.matchId,goBack:()=>{window.history.back()}}}},Y={class:"header-content"},Z={class:"header-icons"};function ee(e,t,l,s,v,_){const n=I("MatchChatRoom"),i=I("PlayerNavigationMenu");return M(),w(S,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:u(()=>[d(K,{elevated:"",class:"bg-primary text-white"},{default:u(()=>[p("div",Y,[t[0]||(t[0]=p("div",{class:"greeting"},[p("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon"})],-1)),p("div",Z,[d(k,{flat:"",round:"",icon:"close",onClick:s.goBack},null,8,["onClick"])])])]),_:1}),d(H,null,{default:u(()=>[d(B,{class:"q-pa-md"},{default:u(()=>[d(n,{matchId:s.matchId},null,8,["matchId"])]),_:1})]),_:1}),d(i)]),_:1})}var me=U(W,[["render",ee],["__scopeId","data-v-66047aed"]]);export{me as default};
