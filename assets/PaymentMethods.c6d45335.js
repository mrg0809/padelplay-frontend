import{Q as ve}from"./QHeader.fafcae42.js";import{Q as te}from"./QPage.2aaa1d93.js";import{Q as fe,a as _e}from"./QLayout.554612a4.js";import{aP as re,f as ne,j as Y,i as ge,r as l,y as z,X as ye,w as oe,k as c,l as w,L as W,bV as Ee,s as N,bO as he,G as P,H as o,p as e,ab as X,ac as D,I as k,ad as q,af as Se,ae as Ce,ag as Z,q as O,J as M,Q as ee,bI as L,ah as be,n as we,F as Ie}from"./index.63dc7e23.js";import{u as Ne}from"./summaryStore.8f5e73fe.js";import{u as ke}from"./useDashboardNavigation.0080d3f5.js";import{Q as B}from"./QItemLabel.8574eb87.js";import{Q as xe,a as $}from"./QItem.0839bf79.js";import{Q as Te}from"./QList.e359b89a.js";import"./index.46922028.js";import{u as Oe}from"./use-quasar.a32cc7fc.js";import{u as Pe}from"./userStore.45e0b5eb.js";import{a as V}from"./api.e96a150b.js";import{_ as le}from"./plugin-vue_export-helper.21dcd24c.js";import{P as Qe}from"./PlayerNavigationMenu.f00bb1db.js";import"./pinia.53eba05e.js";import"./index.c98ef0da.js";import"./QTabs.6a3d63d5.js";import"./rtl.276c3f1b.js";import"./QFooter.9d6e02eb.js";const R={STRIPE_NOT_LOADED:"Stripe is not loaded. Include it as script or load using loadStripe method of @stripe/stripe-js",INSTANCE_NOT_DEFINED:"Stripe instance is not defined. Initialize Stripe before creating elements",ELEMENTS_NOT_DEFINED:"Elements object is not defined. You can't create stripe element without it",ELEMENT_TYPE_NOT_DEFINED:"elementType is required. You can't create stripe element without it"},je=(m,r)=>{try{if(!window.Stripe)throw new Error(R.STRIPE_NOT_LOADED);return window.Stripe(m,r)}catch(p){console.error(p)}},qe=(m,r)=>{try{if(!m)throw new Error(R.INSTANCE_NOT_DEFINED);return r!=null&&r.clientSecret,m.elements(r)}catch(p){console.error(p)}},De=(m,r,p)=>{try{if(!m)throw new Error(R.ELEMENTS_NOT_DEFINED);if(!r)throw new Error(R.ELEMENT_TYPE_NOT_DEFINED);return m.create.bind(m)(r,p)}catch(v){console.error(v)}},ae=["change","ready","focus","blur","click","escape","loaderror","loaderstart"],Me=re({__name:"StripeElement",props:{type:{},elements:{},options:{}},emits:ae,setup(m,{expose:r,emit:p}){const v=m,E=p,{type:f,elements:d,options:s}=ne(v),I=Y(()=>d.value?"card":"payment"),h=ge("providedElements"),S=l(document.createElement("div")),a=l(),b=l();return z(()=>{const _=()=>{var i,C;a.value=De(d.value||h.value,f.value||I.value,s.value),(i=b.value)==null||i.appendChild(S.value),(C=a.value)==null||C.mount(S.value)},g=()=>{function i(C){return!!C&&typeof C.on=="function"}if(a.value&&i(a.value))for(const C of ae)a.value.on(C,A=>{E(C,A)})};try{_(),g()}catch(i){console.error(i)}}),ye(()=>{var _,g;(_=a.value)==null||_.unmount(),(g=a.value)==null||g.destroy()}),oe(s,()=>{s.value&&a.value&&"update"in a.value&&a.value.update(s.value)}),r({stripeElement:a,domElement:S,mountPoint:b}),(_,g)=>(c(),w("div",{ref_key:"mountPoint",ref:b},null,512))}}),Le={key:0},Re=re({__name:"StripeElements",props:{stripeKey:{},instanceOptions:{},elementsOptions:{}},setup(m,{expose:r}){const p=m,{stripeKey:v,instanceOptions:E,elementsOptions:f}=ne(p),d=l(),s=l(),I=Y(()=>s.value?Object.keys(s.value).length>0:!1);return z(()=>{d.value=je(v.value,E.value),s.value=qe(d.value,f.value)}),oe(f,()=>{var h;(h=s.value)==null||h.update(f.value)}),W("providedInstance",d),W("providedElements",s),r({elements:s,instance:d,elementsUsable:I}),(h,S)=>I.value?(c(),w("div",Le,[Ee(h.$slots,"default",{instance:d.value,elements:s.value})])):N("",!0)}});const Ae={key:1,class:"text-center text-grey q-pa-lg"},Fe={key:2,class:"text-center q-pa-lg"},Be={class:"q-mt-lg"},$e={key:0,class:"stripe-elements-container"},Ve={key:0,class:"text-negative q-mt-sm text-caption"},Ye={key:1,class:"text-negative q-pa-sm"},ze={key:2,class:"text-center q-my-md"},Ue={__name:"PaymentMethodsComponent",setup(m){const r=Oe(),p=Pe(),v=l({}.VITE_STRIPE_PUBLISHABLE_KEY),E=l([]),f=l(!1),d=l(!1),s=l(null),I=l(null),h=l(!1),S=l(!1),a=l(null),b=l(null),_=l(!1),g=l(null),i=l(null);he(null),l(null);const C=l({}),A=Y(()=>({clientSecret:i.value,appearance:{theme:"night",labels:"floating"}})),se=l({style:{base:{iconColor:"#c4f0ff",color:"#fff",fontWeight:"500",fontFamily:"Roboto, Open Sans, Segoe UI, sans-serif",fontSize:"16px",fontSmoothing:"antialiased",":-webkit-autofill":{color:"#fce883"},"::placeholder":{color:"#87bbfd"}},invalid:{iconColor:"#ffc7ee",color:"#ffc7ee"}},hidePostalCode:!0}),F=async()=>{f.value=!0;try{const t=await V.get("/payments/payment-methods");E.value=t.data||[]}catch{}finally{f.value=!1}},ie=t=>{r.dialog({title:"Confirmar",message:"\xBFEst\xE1s seguro de que quieres eliminar esta tarjeta?",cancel:{label:"Cancelar",flat:!0},ok:{label:"Eliminar",color:"negative",push:!0},persistent:!0,dark:!0,class:"bg-black"}).onOk(async()=>{await ue(t)})},ue=async t=>{var n,u;r.loading.show({message:"Eliminando..."});try{await V.delete(`/payments/payment-methods/${t}`),r.notify({type:"positive",message:"Tarjeta eliminada correctamente."}),await F()}catch(y){console.error("Error deleting payment method:",y),r.notify({type:"negative",message:((u=(n=y.response)==null?void 0:n.data)==null?void 0:u.detail)||"Error al eliminar la tarjeta."})}finally{r.loading.hide()}},ce=t=>({visa:"img:/icons/visa.svg",mastercard:"img:/icons/mastercard.svg",amex:"img:/icons/amex.svg"})[t]||"mdi-credit-card",U=t=>({visa:"Visa",mastercard:"Mastercard",amex:"American Express"})[t]||t.charAt(0).toUpperCase()+t.slice(1),de=t=>{_.value=t.complete,b.value=t.error?t.error.message:null},H=()=>{d.value=!1,a.value=null,b.value=null,g.value=null,i.value=null,_.value=!1},me=async()=>{var t,n,u;S.value=!0,d.value=!0,g.value=null,i.value=null,_.value=!1;try{const j=(t=(await V.post("/payments/setup-intent")).data)==null?void 0:t.clientSecret;if(!j)throw new Error("No se recibi\xF3 la configuraci\xF3n de pago del servidor.");i.value=j,console.log("Client Secret obtenido para SetupIntent"),await we()}catch(y){console.error("Error fetching client secret for SetupIntent:",y),g.value=((u=(n=y.response)==null?void 0:n.data)==null?void 0:u.detail)||y.message||"Error al iniciar el formulario de pago.",d.value=!1}finally{S.value=!1}},pe=async()=>{var u,y,j,K;const t=(u=s.value)==null?void 0:u.instance,n=(y=I.value)==null?void 0:y.stripeElement;if(!t||!n){a.value="El formulario de pago no est\xE1 listo (instancias no encontradas).",console.error("Error: Instancia de Stripe o CardElement no encontrada en refs. Verifica 'elementsRef' y 'cardElementRef'.",{stripeRef:s.value,cardRef:I.value});return}if(!_.value){a.value="Por favor, completa los datos de la tarjeta.";return}if(!i.value){a.value="Falta la configuraci\xF3n de pago (Client Secret).";return}h.value=!0,a.value=null,b.value=null;try{console.log("Llamando a confirmCardSetup con clientSecret:",i.value);const{error:x,setupIntent:T}=await t.confirmCardSetup(i.value,{payment_method:{card:n,billing_details:{name:p.userName||"Nombre No Disponible",email:p.userEmail||void 0}},expand:["payment_method"]});if(x)console.error("Stripe confirmCardSetup error:",x),a.value=x.message||"Ocurri\xF3 un error al guardar la tarjeta.";else if(T.status==="succeeded"){console.log("SetupIntent Succeeded:",T);const Q=T.payment_method;let G="tarjeta",J="****";typeof Q=="object"&&(Q==null?void 0:Q.card)&&(G=Q.card.brand,J=Q.card.last4),r.notify({type:"positive",message:`Tarjeta ${U(G)} terminada en ${J} guardada.`}),H(),await F()}else T.status==="requires_action"?(console.warn("SetupIntent requires_action despu\xE9s de confirmCardSetup. Status:",T.status),a.value="Se requiere autenticaci\xF3n adicional o la acci\xF3n no se complet\xF3."):(console.warn("SetupIntent status:",T.status),a.value=`El estado de la configuraci\xF3n fue: ${T.status}. Intenta de nuevo.`)}catch(x){console.error("Error in saveNewCard function execution:",x),a.value=((K=(j=x.response)==null?void 0:j.data)==null?void 0:K.detail)||x.message||"Error inesperado al guardar la tarjeta."}finally{h.value=!1}};return z(()=>{F()}),(t,n)=>(c(),P(te,{class:"q-pa-md"},{default:o(()=>[e(X,null,{default:o(()=>[e(D,{class:"card-methods"},{default:o(()=>[n[2]||(n[2]=k("h4",{class:"q-mt-none q-mb-md text-white"},"Mis M\xE9todos de Pago",-1)),!f.value&&E.value.length>0?(c(),P(Te,{key:0,bordered:"",separator:""},{default:o(()=>[e(B,{header:"",class:"text-grey-7"},{default:o(()=>n[0]||(n[0]=[q("Tarjetas Guardadas")])),_:1}),(c(!0),w(Se,null,Ce(E.value,u=>(c(),P(xe,{key:u.id},{default:o(()=>[e($,{avatar:""},{default:o(()=>[e(Z,{name:ce(u.brand),size:"lg",color:"white"},null,8,["name"])]),_:2},1024),e($,null,{default:o(()=>[e(B,null,{default:o(()=>[q(O(U(u.brand))+" terminada en "+O(u.last4),1)]),_:2},1024),e(B,{caption:""},{default:o(()=>[q("Expira: "+O(String(u.expMonth).padStart(2,"0"))+"/"+O(u.expYear),1)]),_:2},1024)]),_:2},1024),e($,{side:""},{default:o(()=>[e(M,{icon:"delete",color:"negative",flat:"",round:"",dense:"",onClick:y=>ie(u.id),title:"Eliminar tarjeta"},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):N("",!0),!f.value&&E.value.length===0&&!d.value?(c(),w("div",Ae,[e(Z,{name:"mdi-credit-card-off-outline",size:"lg"}),n[1]||(n[1]=k("p",{class:"q-mt-sm"},"No tienes tarjetas guardadas.",-1))])):N("",!0),f.value?(c(),w("div",Fe,[e(ee,{color:"primary",size:"md"})])):N("",!0)]),_:1})]),_:1}),k("div",Be,[d.value?N("",!0):(c(),P(M,{key:0,label:"A\xF1adir Nueva Tarjeta",color:"green",icon:"add_card",onClick:me,loading:S.value,push:""},null,8,["loading"])),d.value?(c(),P(X,{key:1,flat:"",bordered:"",class:"q-pa-md"},{default:o(()=>[e(D,{class:"q-pb-none"},{default:o(()=>n[3]||(n[3]=[k("div",{class:"text-h6"},"A\xF1adir Tarjeta",-1)])),_:1}),e(D,null,{default:o(()=>[v.value&&i.value?(c(),w("div",$e,[e(L(Re),{ref_key:"elementsRef",ref:s,"stripe-key":v.value,"instance-options":C.value,"elements-options":A.value},{default:o(()=>[e(L(Me),{ref_key:"cardElementRef",ref:I,type:"card",options:se.value,onChange:de},null,8,["options"])]),_:1},8,["stripe-key","instance-options","elements-options"]),b.value?(c(),w("div",Ve,O(b.value),1)):N("",!0)])):g.value?(c(),w("div",Ye,O(g.value),1)):(c(),w("div",ze,[e(ee,{color:"primary",size:"sm"}),n[4]||(n[4]=q(" Iniciando formulario seguro... "))]))]),_:1}),a.value?(c(),P(D,{key:0,class:"text-negative"},{default:o(()=>[q(O(a.value),1)]),_:1})):N("",!0),e(be,{align:"right"},{default:o(()=>[e(M,{label:"Cancelar",flat:"",color:"grey",onClick:H}),e(M,{label:"Guardar Tarjeta",color:"primary",onClick:pe,loading:h.value||S.value,disable:S.value||!i.value||!_.value,push:""},null,8,["loading","disable"])]),_:1})]),_:1})):N("",!0)])]),_:1}))}};var He=le(Ue,[["__scopeId","data-v-f49a7d2e"]]);const Ke={class:"header-content"},Ge={class:"greeting"},Je={__name:"PaymentMethods",setup(m){Ne(),Ie();const{goToDashboard:r}=ke();return(p,v)=>(c(),P(fe,{view:"hHh lpR fFf",class:"text-white"},{default:o(()=>[e(ve,{elevated:"",class:"text-white"},{default:o(()=>[k("div",Ke,[k("div",Ge,[k("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon clickable-logo",onClick:v[0]||(v[0]=(...E)=>L(r)&&L(r)(...E))})]),v[1]||(v[1]=k("div",{class:"header-icons"},null,-1))])]),_:1}),e(_e,null,{default:o(()=>[e(te,{class:"q-pa-md"},{default:o(()=>[e(He)]),_:1})]),_:1}),e(Qe)]),_:1}))}};var ga=le(Je,[["__scopeId","data-v-c40e8358"]]);export{ga as default};
