import{r as h,h as R,a1 as D,o as v,z as b,A as n,d as t,a7 as T,B as m,a as S,aa as N,ab as P,E as j,bF as V,D as w,a5 as q,a6 as M}from"./index.284c5517.js";import{Q as F}from"./QHeader.54948f97.js";import{Q as k}from"./QPage.dfd00166.js";import{a as I,Q as C}from"./QLayout.c9dda368.js";import{s as p}from"./supabase.d0690741.js";import{Q as x}from"./QChatMessage.961cc979.js";import{_ as U}from"./plugin-vue_export-helper.21dcd24c.js";import{n as L}from"./navigationUtils.2c4b9dee.js";import{P as H}from"./PlayerNavigationMenu.3819ea2c.js";import"./QTabs.b10b01c4.js";import"./rtl.276c3f1b.js";import"./QFooter.d2ce5627.js";const K={props:{matchId:{type:String,required:!0}},components:{QChatMessage:x},setup(c){const s=h([]),l=h(""),e=h(null),u=h({full_name:"Usuario desconocido"}),g=h({});let o=null;const i=async()=>{try{const{data:a,error:r}=await p.from("chat_messages").select("*").eq("match_id",c.matchId).order("timestamp",{ascending:!0});r?console.error("Error al cargar mensajes:",r):s.value=a}catch(a){console.error("Error inesperado al cargar mensajes:",a)}},d=async a=>{try{const{data:r,error:_}=await p.from("players").select("user_id, first_name, photo_url").in("user_id",a);_?console.error("Error al obtener detalles de usuarios:",_):r.forEach(f=>{g.value[f.user_id]=f})}catch(r){console.error("Error inesperado al obtener detalles de usuarios:",r)}},E=async()=>{try{const{error:a}=await p.from("chat_messages").insert({match_id:c.matchId,sender:u.value.full_name,sender_id:e.value,message:l.value.trim()});a?console.error("Error al enviar mensaje:",a):l.value=""}catch(a){console.error("Error inesperado al enviar mensaje:",a)}},Q=()=>{o=p.channel("public:chat_messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`match_id=eq.${c.matchId}`},a=>{s.value.push(a.new)}).subscribe(a=>{a==="SUBSCRIBED"&&console.log("Realtime subscription active")})},B=a=>new Date(a).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});return R(async()=>{const a=localStorage.getItem("token");if(a){const f=a.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),y=JSON.parse(atob(f));e.value=y.sub,u.value.full_name=y.full_name||"Usuario desconocido"}await i();const r=s.value.map(_=>_.sender_id);await d(r),Q()}),D(()=>{o&&p.removeChannel(o)}),{currentUserId:e,messages:s,newMessage:l,formatTimestamp:B,sendMessage:E,user:u,userMap:g}}},z={class:"chat-messages"},A={class:"chat-message-input"};function J(c,s,l,e,u,g){return v(),b(C,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:n(()=>[t(I,null,{default:n(()=>[t(k,null,{default:n(()=>[t(T,{class:"text-white chat-card"},{default:n(()=>[m("div",z,[(v(!0),S(P,null,N(e.messages,o=>{var i,d;return v(),b(x,{key:o.id,name:((i=e.userMap[o.sender_id])==null?void 0:i.first_name)||"Usuario desconocido",avatar:(d=e.userMap[o.sender_id])==null?void 0:d.photo_url,text:[o.message],stamp:e.formatTimestamp(o.timestamp),sent:o.sender_id===e.currentUserId,"bg-color":o.sender_id===e.currentUserId?"amber-7":"primary","text-color":o.sender_id===e.currentUserId?"black":"white"},null,8,["name","avatar","text","stamp","sent","bg-color","text-color"])}),128))])]),_:1}),m("div",A,[t(j,{modelValue:e.newMessage,"onUpdate:modelValue":s[0]||(s[0]=o=>e.newMessage=o),placeholder:"Escribe un mensaje...",outlined:"",dense:"",dark:"",onKeyup:V(e.sendMessage,["enter"])},null,8,["modelValue","onKeyup"]),t(w,{color:"black",onClick:e.sendMessage,disable:!e.newMessage.trim(),icon:"o_send"},null,8,["onClick","disable"])])]),_:1})]),_:1})]),_:1})}var O=U(K,[["render",J],["__scopeId","data-v-16742b44"]]);const X={components:{MatchChatRoom:O,PlayerNavigationMenu:H},setup(){return{matchId:q().params.matchId,goBack:()=>{window.history.back()},goToDashboard:()=>{L(router,userStore)}}}},G={class:"header-content"},W={class:"greeting"},Y={class:"header-icons"};function Z(c,s,l,e,u,g){const o=M("MatchChatRoom"),i=M("PlayerNavigationMenu");return v(),b(C,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:n(()=>[t(F,{elevated:"",class:"bg-primary text-white"},{default:n(()=>[m("div",G,[m("div",W,[m("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon clickable-logo",onClick:s[0]||(s[0]=(...d)=>e.goToDashboard&&e.goToDashboard(...d))})]),m("div",Y,[t(w,{flat:"",round:"",icon:"close",onClick:e.goBack},null,8,["onClick"])])])]),_:1}),t(I,null,{default:n(()=>[t(k,{class:"q-pa-md"},{default:n(()=>[t(o,{matchId:e.matchId},null,8,["matchId"])]),_:1})]),_:1}),t(i)]),_:1})}var me=U(X,[["render",Z],["__scopeId","data-v-586a3f20"]]);export{me as default};
