import{a7 as me,F as pe,r as c,j as L,w as Z,B as ve,a8 as ye,q as h,G as O,H as l,n as G,v as o,I as w,J as $,a9 as fe,aa as j,s as A,Q as ee,ab as q,y as V,ac as ge,ad as he,ag as ae,aQ as we,aR as te,x as M,af as Pe,ae as Ee,aG as oe}from"./index.cf1ae381.js";import{Q as _e}from"./QHeader.22bc8748.js";import{Q as F}from"./QItemLabel.bad9e799.js";import{Q as re,a as z}from"./QItem.ff5f9822.js";import{Q as be}from"./QList.060f9b6d.js";import{Q as xe}from"./QPage.3d29d4c0.js";import{Q as qe,a as Ie}from"./QLayout.3b12d370.js";import{u as Se}from"./use-quasar.fa8835f9.js";import{l as ke}from"./index.46922028.js";import{f as Ce}from"./reservationsUtils.a1674de8.js";import{f as De,a as Me,b as Qe,c as Ne}from"./finalizeUtils.6d45d404.js";import{a as I}from"./api.f1a1189d.js";import{D as Re}from"./DesktopNavigation.bd3e2669.js";import{_ as Te}from"./plugin-vue_export-helper.21dcd24c.js";import"./hourUtils.24f4f451.js";import"./QTooltip.c563cb8c.js";import"./position-engine.b650c4e5.js";import"./selection.e1a99fb1.js";const Be=r=>({visa:"img:/icons/visa.svg",mastercard:"img:/icons/mastercard.svg",amex:"img:/icons/amex.svg"})[r]||"mdi-credit-card",Oe=r=>({visa:"Visa",mastercard:"Mastercard",amex:"American Express"})[r]||r.charAt(0).toUpperCase()+r.slice(1);const Ve={name:"StripePayment",components:{DesktopNavigation:Re},setup(){const r=me(),a=pe(),t=Se(),n=c(r.query.paymentOrderId),Q=c(parseFloat(r.query.amountToPay||"0")),Y=c(parseFloat(r.query.totalAmount||"0")),J=c(r.query.description||"Pago PadelPlay");c(r.query.clubId);const d=c([]),U=c(r.query.paymentOption),v=L(()=>{try{return JSON.parse(r.query.baseData||"{}")}catch(e){return console.error("Error parsing baseData from query:",e),{}}}),K=L(()=>{try{return JSON.parse(r.query.extraData||"{}")}catch(e){return console.error("Error parsing extraData from query:",e),{}}}),W=L(()=>{try{return JSON.parse(r.query.selectedProducts||"[]")}catch(e){return console.error("Error parsing selectedProducts from query:",e),[]}}),E=c(null),S=c(null),p=c(null),f=c(null),_=c(!1),N=c(!1),k=c([]),i=c("new"),b=c(null),g=c(!1),ne=L(()=>(console.log("Checking isReadyToPay:",{clientSecret:!!f.value,selectedMethodId:i.value,isPaymentElementReady:g.value,elementsValueExists:!!S.value}),f.value?i.value==="new"?!!S.value&&g.value:!!i.value&&i.value!=="new":!1)),se=async()=>{N.value=!0,k.value=[];try{const e=await I.get("/payments/payment-methods");k.value=e.data||[],k.value.length>0?i.value=k.value[0].id:i.value="new"}catch(e){console.error("Error fetching saved payment methods:",e),i.value="new"}finally{N.value=!1}},le=async e=>{var s,m,R;try{if(!n.value||!e||e<=0)throw new Error("Falta ID de orden o el monto es inv\xE1lido para crear PaymentIntent.");const x=Math.round(e*100);let T=null;if(i.value!=="new"){const y=k.value.find(B=>B.id===i.value);y&&(T=y.customer)}const C=await I.post("payments/create-payment-intent",{payment_order_id:n.value,amount:x,customer:T,metadata:{item_type:(s=v.value)==null?void 0:s.type,item_id:(m=v.value)==null?void 0:m.id,description:J.value}});if(console.log("Client Secret response:",C.data),!((R=C.data)!=null&&R.clientSecret))throw new Error("Respuesta inv\xE1lida del servidor: No se recibi\xF3 clientSecret.");return C.data.clientSecret}catch(x){return console.error("Error al obtener clientSecret:",x),t.notify({type:"negative",message:x.message||"Error al preparar el pago."}),null}},H=()=>{if(!E.value||!f.value||i.value!=="new"){g.value=!1,p.value&&(console.log("Desmontando Payment Element..."),p.value.destroy(),p.value=null);return}if(!p.value&&i.value==="new"){console.log("Montando Payment Element...");try{const e={theme:"night",labels:"floating"};S.value=E.value.elements({clientSecret:f.value,appearance:e}),p.value=S.value.create("payment",{}),p.value.mount("#stripe-payment-element"),g.value=!1,b.value=null,p.value.on("ready",()=>{console.log("Payment Element listo."),g.value=!0}),p.value.on("change",s=>{s.error?(b.value=s.error.message,g.value=!1):b.value=null})}catch(e){console.error("Error montando Payment Element:",e),b.value="Error al cargar formulario de tarjeta.",g.value=!1}}},ie=async()=>{N.value=!0;try{if(E.value=await ke({}.VITE_STRIPE_PUBLISHABLE_KEY),!E.value)throw new Error("No se pudo cargar Stripe.js");if(await se(),f.value=await le(Q.value),!f.value)throw new Error("No se pudo obtener la informaci\xF3n de pago.");await G(),H()}catch(e){console.error("Error en la configuraci\xF3n inicial de pago:",e),t.notify({type:"negative",message:e.message||"Error al inicializar el pago. Intenta refrescar.",timeout:0,actions:[{label:"Cerrar",handler:()=>{}}]})}finally{N.value=!1}};Z(i,async e=>{console.log("M\xE9todo seleccionado cambiado a:",e),b.value=null,await G(),e==="new"?H():p.value&&(console.log("Desmontando Payment Element..."),p.value.destroy(),p.value=null,g.value=!1)}),Z(f,async e=>{e&&i.value==="new"&&(await G(),H())});const ce=async()=>{if(!E.value||!f.value||!i.value){t.notify({type:"negative",message:"Sistema de pago no inicializado."});return}_.value=!0,t.loading.show({message:"Procesando pago..."}),b.value=null;let e=null,s=null;try{if(i.value==="new"){if(!S.value||!p.value||!g.value)throw new Error("El formulario de nueva tarjeta no est\xE1 listo.");console.log("Confirmando pago con Payment Element...");const m=await E.value.confirmPayment({elements:S,confirmParams:{return_url:`${window.location.origin}/payment-complete`},redirect:"if_required"});e=m.error,s=m.paymentIntent}else{console.log(`Confirmando pago con tarjeta guardada: ${i.value}`);const m=await E.value.confirmCardPayment(f.value,{payment_method:i.value});e=m.error,s=m.paymentIntent}e?(console.error("Error al confirmar el pago:",e),t.notify({type:"negative",message:`Error: ${e.message}`}),b.value=e.message):s?(console.log("Resultado confirmaci\xF3n:",s),await de(s)):!e&&i.value!=="new"&&(console.warn("Confirmaci\xF3n con tarjeta guardada no devolvi\xF3 error ni paymentIntent."),t.notify({type:"warning",message:"Estado de pago incierto. Verifica tus operaciones."}))}catch(m){console.error("Excepci\xF3n durante confirmPayment:",m),t.notify({type:"negative",message:"Ocurri\xF3 un error inesperado durante el pago."})}finally{(e||s&&s.status!=="succeeded"||!e&&!s&&i.value!=="new")&&(t.loading.hide(),_.value=!1)}},ue=async e=>{var m,R,x,T,C;console.log("Pago Exitoso! Procesando tipo:",(m=v.value)==null?void 0:m.type,"con ID:",(R=v.value)==null?void 0:R.id),t.loading.show({message:"Confirmando reserva..."});const s={baseData:v.value,extraData:K.value,selectedProducts:W.value,paymentOrderId:n.value,totalAmount:Y.value,amountToPay:Q.value,itemDetails:d.value,paymentOption:U.value};try{const y=(x=v.value)==null?void 0:x.type;let B={success:!1},D="/dashboard/player",P=!1;if(y==="court")B=await Ce(e,s,I,t),P=B.success,P&&(D=`/player/match/${B.matchId}`);else if(y==="class"){const u=await De(e,s,I,t);P=u.success,D=u.path||`/player/privatelesson/${u.lesson_id}`}else if(y==="public_lesson"){const u=await Me(e,s,I,t);P=u.success,D=u.path||`/player/detallessesion/${u.lesson_id}`}else if(y==="tournament"){const u=await Qe(e,s,I,t);P=u.success,D=u.path||`/tournaments/${(T=v.value)==null?void 0:T.id}`}else if(y==="open_match_join"){const u=await Ne(e,s,I,t);P=u.success,D=u.path||(u.matchId?`/player/match/${u.matchId}`:`/player/match/${(C=v.value)==null?void 0:C.id}`)}else console.error(`Tipo de item desconocido: ${y}`),t.notify({type:"negative",message:"Error: Tipo de operaci\xF3n desconocida despu\xE9s del pago."}),P=!1;P&&(t.notify({type:"positive",message:"\xA1Operaci\xF3n completada con \xE9xito!"}),a.push(D))}catch(y){console.error("Error procesando \xE9xito del pago:",y),t.notify({type:"negative",message:"El pago fue exitoso, pero hubo un error al finalizar la operaci\xF3n."}),a.push("/user/dashboard")}finally{t.loading.hide(),_.value=!1}},de=async e=>{switch(e.status){case"succeeded":await ue(e);break;case"processing":t.notify({type:"info",message:"El pago se est\xE1 procesando. Te notificaremos cuando se complete."}),a.push("/user/dashboard");break;case"requires_payment_method":t.notify({type:"warning",message:"Pago fallido. Por favor, intenta con otro m\xE9todo de pago."}),_.value=!1,t.loading.hide();break;default:t.notify({type:"negative",message:"Algo sali\xF3 mal con el pago."}),_.value=!1,t.loading.hide();break}},X=()=>{a.back()};return ve(async()=>{var e;try{v.value=JSON.parse(r.query.baseData||"{}"),K.value=JSON.parse(r.query.extraData||"{}"),W.value=JSON.parse(r.query.selectedProducts||"[]")}catch(s){console.error("Error parsing data from route query:",s),t.notify({type:"negative",message:"Error al leer los datos de la orden."});return}try{d.value=JSON.parse(r.query.itemDetails||"[]")}catch(s){console.error("Error parsing itemDetails from query:",s),d.value=[]}if(!n.value||Q.value<=0||!((e=v.value)!=null&&e.type)){console.error("Faltan datos esenciales despu\xE9s de parsear:",{query:r.query,baseData:v.value}),t.notify({type:"negative",message:"Informaci\xF3n de pago incompleta. Por favor, vuelve a intentarlo.",timeout:0,actions:[{label:"Volver",handler:X}]});return}await ie()}),{amountToPay:Q,confirmPayment:ce,goBack:X,isProcessingPayment:_,savedMethods:k,selectedMethodId:i,isLoadingMethods:N,getBrandIcon:Be,getBrandName:Oe,isReadyToPay:ne}}},ze={class:"header-content"},Le={class:"header-icons"},je={key:0,class:"text-center q-my-md"},Ae={key:0,class:"text-negative q-mt-sm text-caption"},Fe={key:1,class:"text-center q-pa-md"},Je={class:"text-h6 text-right q-mb-none"};function Ue(r,a,t,n,Q,Y){const J=ye("DesktopNavigation");return h(),O(qe,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:l(()=>[o(_e,{elevated:"",class:"text-white"},{default:l(()=>[w("div",ze,[a[2]||(a[2]=w("div",{class:"greeting"},[w("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon"})],-1)),w("div",Le,[o($,{flat:"",round:"",icon:"close",onClick:n.goBack},null,8,["onClick"])])])]),_:1}),o(J),o(Ie,null,{default:l(()=>[o(xe,{class:"q-pa-md"},{default:l(()=>[o(fe,{class:"text-white"},{default:l(()=>[o(j,null,{default:l(()=>a[3]||(a[3]=[w("h3",{class:"text-white q-mt-none q-mb-md"},"Selecciona tu M\xE9todo de Pago",-1)])),_:1}),o(j,{class:"q-pt-none"},{default:l(()=>[n.isLoadingMethods?(h(),A("div",je,[o(ee,{color:"primary",size:"sm"}),a[4]||(a[4]=q(" Cargando m\xE9todos... "))])):V("",!0),!n.isLoadingMethods&&n.savedMethods.length>0?(h(),O(be,{key:1,bordered:"",separator:"",dark:""},{default:l(()=>[o(F,{header:"",class:"text-grey-5"},{default:l(()=>a[5]||(a[5]=[q("Usar tarjeta guardada")])),_:1}),(h(!0),A(he,null,ge(n.savedMethods,d=>ae((h(),O(re,{key:d.id,tag:"label"},{default:l(()=>[o(z,{avatar:"",top:""},{default:l(()=>[o(te,{modelValue:n.selectedMethodId,"onUpdate:modelValue":a[0]||(a[0]=U=>n.selectedMethodId=U),val:d.id,color:"green"},null,8,["modelValue","val"])]),_:2},1024),o(z,{avatar:""},{default:l(()=>[o(Ee,{name:n.getBrandIcon(d.brand),size:"md"},null,8,["name"])]),_:2},1024),o(z,null,{default:l(()=>[o(F,null,{default:l(()=>[q(M(n.getBrandName(d.brand))+" terminada en "+M(d.last4),1)]),_:2},1024),o(F,{caption:"",class:"text-grey-5"},{default:l(()=>[q(" Expira: "+M(String(d.expMonth).padStart(2,"0"))+"/"+M(d.expYear),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)),[[oe]])),128))]),_:1})):V("",!0),ae((h(),O(re,{tag:"label",class:we(["q-mt-md",{"bg-grey-9":n.selectedMethodId==="new"}])},{default:l(()=>[o(z,{avatar:"",top:""},{default:l(()=>[o(te,{modelValue:n.selectedMethodId,"onUpdate:modelValue":a[1]||(a[1]=d=>n.selectedMethodId=d),val:"new",color:"green"},null,8,["modelValue"])]),_:1}),o(z,null,{default:l(()=>[o(F,null,{default:l(()=>a[6]||(a[6]=[q("Usar nueva tarjeta")])),_:1})]),_:1})]),_:1},8,["class"])),[[oe]])]),_:1}),n.selectedMethodId==="new"?(h(),O(j,{key:0},{default:l(()=>[a[8]||(a[8]=w("p",{class:"text-caption text-grey-5 q-mb-sm"},"Introduce los datos de tu nueva tarjeta:",-1)),a[9]||(a[9]=w("div",{id:"stripe-payment-element",class:"stripe-payment-element-container"},null,-1)),r.paymentElementError?(h(),A("div",Ae,M(r.paymentElementError),1)):V("",!0),!r.isPaymentElementReady&&n.selectedMethodId==="new"?(h(),A("div",Fe,[o(ee,{size:"sm",color:"primary"}),a[7]||(a[7]=q(" Cargando formulario... "))])):V("",!0)]),_:1})):V("",!0),o(j,null,{default:l(()=>[w("p",Je,[a[10]||(a[10]=w("strong",null,"Total:",-1)),q(" $"+M(n.amountToPay.toFixed(2)),1)])]),_:1}),o(Pe,{align:"right",class:"q-pa-md"},{default:l(()=>[o($,{label:`PAGAR $${n.amountToPay.toFixed(2)}`,color:"green",class:"full-width",size:"lg",push:"",onClick:n.confirmPayment,loading:n.isProcessingPayment,disable:!n.isReadyToPay},null,8,["label","onClick","loading","disable"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}var ua=Te(Ve,[["render",Ue],["__scopeId","data-v-e9548af4"]]);export{ua as default};
