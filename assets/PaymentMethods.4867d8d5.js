import{Q as ve}from"./QHeader.3518b267.js";import{Q as te}from"./QPage.f01afbe1.js";import{Q as fe,a as _e}from"./QLayout.46a61ef3.js";import{aN as re,f as ne,j as Y,i as ge,r as s,B as z,X as ye,w as oe,q as c,s as w,L as W,bQ as Ee,y as I,bK as he,G as j,H as o,v as e,a9 as X,aa as P,I as k,ab as O,ad as Se,ac as Ce,ae as Z,x as Q,J as M,Q as ee,bG as L,af as be,n as we,F as Ne}from"./index.a05546fd.js";import{u as Ie}from"./summaryStore.45b2cdc4.js";import{u as ke}from"./useDashboardNavigation.a1f678a3.js";import{Q as B}from"./QItemLabel.3b94dbaa.js";import{Q as xe,a as $}from"./QItem.e38a8786.js";import{Q as Te}from"./QList.f969f6a2.js";import"./index.46922028.js";import{u as Qe}from"./use-quasar.c5364419.js";import{u as je}from"./userStore.2b3b6ba3.js";import{a as V}from"./api.2af71db3.js";import{_ as se}from"./plugin-vue_export-helper.21dcd24c.js";import{P as qe}from"./PlayerNavigationMenu.25e2275d.js";import"./pinia.eaa32ff8.js";import"./QTabs.b249ec85.js";import"./rtl.276c3f1b.js";import"./QFooter.216d5ed8.js";const R={STRIPE_NOT_LOADED:"Stripe is not loaded. Include it as script or load using loadStripe method of @stripe/stripe-js",INSTANCE_NOT_DEFINED:"Stripe instance is not defined. Initialize Stripe before creating elements",ELEMENTS_NOT_DEFINED:"Elements object is not defined. You can't create stripe element without it",ELEMENT_TYPE_NOT_DEFINED:"elementType is required. You can't create stripe element without it"},De=(m,r)=>{try{if(!window.Stripe)throw new Error(R.STRIPE_NOT_LOADED);return window.Stripe(m,r)}catch(p){console.error(p)}},Oe=(m,r)=>{try{if(!m)throw new Error(R.INSTANCE_NOT_DEFINED);return r!=null&&r.clientSecret,m.elements(r)}catch(p){console.error(p)}},Pe=(m,r,p)=>{try{if(!m)throw new Error(R.ELEMENTS_NOT_DEFINED);if(!r)throw new Error(R.ELEMENT_TYPE_NOT_DEFINED);return m.create.bind(m)(r,p)}catch(v){console.error(v)}},ae=["change","ready","focus","blur","click","escape","loaderror","loaderstart"],Me=re({__name:"StripeElement",props:{type:{},elements:{},options:{}},emits:ae,setup(m,{expose:r,emit:p}){const v=m,E=p,{type:f,elements:d,options:l}=ne(v),N=Y(()=>d.value?"card":"payment"),h=ge("providedElements"),S=s(document.createElement("div")),a=s(),b=s();return z(()=>{const _=()=>{var i,C;a.value=Pe(d.value||h.value,f.value||N.value,l.value),(i=b.value)==null||i.appendChild(S.value),(C=a.value)==null||C.mount(S.value)},g=()=>{function i(C){return!!C&&typeof C.on=="function"}if(a.value&&i(a.value))for(const C of ae)a.value.on(C,A=>{E(C,A)})};try{_(),g()}catch(i){console.error(i)}}),ye(()=>{var _,g;(_=a.value)==null||_.unmount(),(g=a.value)==null||g.destroy()}),oe(l,()=>{l.value&&a.value&&"update"in a.value&&a.value.update(l.value)}),r({stripeElement:a,domElement:S,mountPoint:b}),(_,g)=>(c(),w("div",{ref_key:"mountPoint",ref:b},null,512))}}),Le={key:0},Re=re({__name:"StripeElements",props:{stripeKey:{},instanceOptions:{},elementsOptions:{}},setup(m,{expose:r}){const p=m,{stripeKey:v,instanceOptions:E,elementsOptions:f}=ne(p),d=s(),l=s(),N=Y(()=>l.value?Object.keys(l.value).length>0:!1);return z(()=>{d.value=De(v.value,E.value),l.value=Oe(d.value,f.value)}),oe(f,()=>{var h;(h=l.value)==null||h.update(f.value)}),W("providedInstance",d),W("providedElements",l),r({elements:l,instance:d,elementsUsable:N}),(h,S)=>N.value?(c(),w("div",Le,[Ee(h.$slots,"default",{instance:d.value,elements:l.value})])):I("",!0)}});const Ae={key:1,class:"text-center text-grey q-pa-lg"},Fe={key:2,class:"text-center q-pa-lg"},Be={class:"q-mt-lg"},$e={key:0,class:"stripe-elements-container"},Ve={key:0,class:"text-negative q-mt-sm text-caption"},Ye={key:1,class:"text-negative q-pa-sm"},ze={key:2,class:"text-center q-my-md"},Ue={__name:"PaymentMethodsComponent",setup(m){const r=Qe(),p=je(),v=s({}.VITE_STRIPE_PUBLISHABLE_KEY),E=s([]),f=s(!1),d=s(!1),l=s(null),N=s(null),h=s(!1),S=s(!1),a=s(null),b=s(null),_=s(!1),g=s(null),i=s(null);he(null),s(null);const C=s({}),A=Y(()=>({clientSecret:i.value,appearance:{theme:"night",labels:"floating"}})),le=s({style:{base:{iconColor:"#c4f0ff",color:"#fff",fontWeight:"500",fontFamily:"Roboto, Open Sans, Segoe UI, sans-serif",fontSize:"16px",fontSmoothing:"antialiased",":-webkit-autofill":{color:"#fce883"},"::placeholder":{color:"#87bbfd"}},invalid:{iconColor:"#ffc7ee",color:"#ffc7ee"}},hidePostalCode:!0}),F=async()=>{f.value=!0;try{const t=await V.get("/payments/payment-methods");E.value=t.data||[]}catch{}finally{f.value=!1}},ie=t=>{r.dialog({title:"Confirmar",message:"\xBFEst\xE1s seguro de que quieres eliminar esta tarjeta?",cancel:{label:"Cancelar",flat:!0},ok:{label:"Eliminar",color:"negative",push:!0},persistent:!0,dark:!0,class:"bg-black"}).onOk(async()=>{await ue(t)})},ue=async t=>{var n,u;r.loading.show({message:"Eliminando..."});try{await V.delete(`/payments/payment-methods/${t}`),r.notify({type:"positive",message:"Tarjeta eliminada correctamente."}),await F()}catch(y){console.error("Error deleting payment method:",y),r.notify({type:"negative",message:((u=(n=y.response)==null?void 0:n.data)==null?void 0:u.detail)||"Error al eliminar la tarjeta."})}finally{r.loading.hide()}},ce=t=>({visa:"img:/icons/visa.svg",mastercard:"img:/icons/mastercard.svg",amex:"img:/icons/amex.svg"})[t]||"mdi-credit-card",U=t=>({visa:"Visa",mastercard:"Mastercard",amex:"American Express"})[t]||t.charAt(0).toUpperCase()+t.slice(1),de=t=>{_.value=t.complete,b.value=t.error?t.error.message:null},K=()=>{d.value=!1,a.value=null,b.value=null,g.value=null,i.value=null,_.value=!1},me=async()=>{var t,n,u;S.value=!0,d.value=!0,g.value=null,i.value=null,_.value=!1;try{const D=(t=(await V.post("/payments/setup-intent")).data)==null?void 0:t.clientSecret;if(!D)throw new Error("No se recibi\xF3 la configuraci\xF3n de pago del servidor.");i.value=D,console.log("Client Secret obtenido para SetupIntent"),await we()}catch(y){console.error("Error fetching client secret for SetupIntent:",y),g.value=((u=(n=y.response)==null?void 0:n.data)==null?void 0:u.detail)||y.message||"Error al iniciar el formulario de pago.",d.value=!1}finally{S.value=!1}},pe=async()=>{var u,y,D,G;const t=(u=l.value)==null?void 0:u.instance,n=(y=N.value)==null?void 0:y.stripeElement;if(!t||!n){a.value="El formulario de pago no est\xE1 listo (instancias no encontradas).",console.error("Error: Instancia de Stripe o CardElement no encontrada en refs. Verifica 'elementsRef' y 'cardElementRef'.",{stripeRef:l.value,cardRef:N.value});return}if(!_.value){a.value="Por favor, completa los datos de la tarjeta.";return}if(!i.value){a.value="Falta la configuraci\xF3n de pago (Client Secret).";return}h.value=!0,a.value=null,b.value=null;try{console.log("Llamando a confirmCardSetup con clientSecret:",i.value);const{error:x,setupIntent:T}=await t.confirmCardSetup(i.value,{payment_method:{card:n,billing_details:{name:p.userName||"Nombre No Disponible",email:p.userEmail||void 0}},expand:["payment_method"]});if(x)console.error("Stripe confirmCardSetup error:",x),a.value=x.message||"Ocurri\xF3 un error al guardar la tarjeta.";else if(T.status==="succeeded"){console.log("SetupIntent Succeeded:",T);const q=T.payment_method;let H="tarjeta",J="****";typeof q=="object"&&(q==null?void 0:q.card)&&(H=q.card.brand,J=q.card.last4),r.notify({type:"positive",message:`Tarjeta ${U(H)} terminada en ${J} guardada.`}),K(),await F()}else T.status==="requires_action"?(console.warn("SetupIntent requires_action despu\xE9s de confirmCardSetup. Status:",T.status),a.value="Se requiere autenticaci\xF3n adicional o la acci\xF3n no se complet\xF3."):(console.warn("SetupIntent status:",T.status),a.value=`El estado de la configuraci\xF3n fue: ${T.status}. Intenta de nuevo.`)}catch(x){console.error("Error in saveNewCard function execution:",x),a.value=((G=(D=x.response)==null?void 0:D.data)==null?void 0:G.detail)||x.message||"Error inesperado al guardar la tarjeta."}finally{h.value=!1}};return z(()=>{F()}),(t,n)=>(c(),j(te,{class:"q-pa-md"},{default:o(()=>[e(X,null,{default:o(()=>[e(P,{class:"card-methods"},{default:o(()=>[n[2]||(n[2]=k("h4",{class:"q-mt-none q-mb-md text-white"},"Mis M\xE9todos de Pago",-1)),!f.value&&E.value.length>0?(c(),j(Te,{key:0,bordered:"",separator:""},{default:o(()=>[e(B,{header:"",class:"text-grey-7"},{default:o(()=>n[0]||(n[0]=[O("Tarjetas Guardadas")])),_:1}),(c(!0),w(Se,null,Ce(E.value,u=>(c(),j(xe,{key:u.id},{default:o(()=>[e($,{avatar:""},{default:o(()=>[e(Z,{name:ce(u.brand),size:"lg",color:"white"},null,8,["name"])]),_:2},1024),e($,null,{default:o(()=>[e(B,null,{default:o(()=>[O(Q(U(u.brand))+" terminada en "+Q(u.last4),1)]),_:2},1024),e(B,{caption:""},{default:o(()=>[O("Expira: "+Q(String(u.expMonth).padStart(2,"0"))+"/"+Q(u.expYear),1)]),_:2},1024)]),_:2},1024),e($,{side:""},{default:o(()=>[e(M,{icon:"delete",color:"negative",flat:"",round:"",dense:"",onClick:y=>ie(u.id),title:"Eliminar tarjeta"},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):I("",!0),!f.value&&E.value.length===0&&!d.value?(c(),w("div",Ae,[e(Z,{name:"mdi-credit-card-off-outline",size:"lg"}),n[1]||(n[1]=k("p",{class:"q-mt-sm"},"No tienes tarjetas guardadas.",-1))])):I("",!0),f.value?(c(),w("div",Fe,[e(ee,{color:"primary",size:"md"})])):I("",!0)]),_:1})]),_:1}),k("div",Be,[d.value?I("",!0):(c(),j(M,{key:0,label:"A\xF1adir Nueva Tarjeta",color:"green",icon:"add_card",onClick:me,loading:S.value,push:""},null,8,["loading"])),d.value?(c(),j(X,{key:1,flat:"",bordered:"",class:"q-pa-md"},{default:o(()=>[e(P,{class:"q-pb-none"},{default:o(()=>n[3]||(n[3]=[k("div",{class:"text-h6"},"A\xF1adir Tarjeta",-1)])),_:1}),e(P,null,{default:o(()=>[v.value&&i.value?(c(),w("div",$e,[e(L(Re),{ref_key:"elementsRef",ref:l,"stripe-key":v.value,"instance-options":C.value,"elements-options":A.value},{default:o(()=>[e(L(Me),{ref_key:"cardElementRef",ref:N,type:"card",options:le.value,onChange:de},null,8,["options"])]),_:1},8,["stripe-key","instance-options","elements-options"]),b.value?(c(),w("div",Ve,Q(b.value),1)):I("",!0)])):g.value?(c(),w("div",Ye,Q(g.value),1)):(c(),w("div",ze,[e(ee,{color:"primary",size:"sm"}),n[4]||(n[4]=O(" Iniciando formulario seguro... "))]))]),_:1}),a.value?(c(),j(P,{key:0,class:"text-negative"},{default:o(()=>[O(Q(a.value),1)]),_:1})):I("",!0),e(be,{align:"right"},{default:o(()=>[e(M,{label:"Cancelar",flat:"",color:"grey",onClick:K}),e(M,{label:"Guardar Tarjeta",color:"primary",onClick:pe,loading:h.value||S.value,disable:S.value||!i.value||!_.value,push:""},null,8,["loading","disable"])]),_:1})]),_:1})):I("",!0)])]),_:1}))}};var Ke=se(Ue,[["__scopeId","data-v-d78b2aa2"]]);const Ge={class:"header-content"},He={class:"greeting"},Je={__name:"PaymentMethods",setup(m){Ie(),Ne();const{goToDashboard:r}=ke();return(p,v)=>(c(),j(fe,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:o(()=>[e(ve,{elevated:"",class:"text-white"},{default:o(()=>[k("div",Ge,[k("div",He,[k("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon clickable-logo",onClick:v[0]||(v[0]=(...E)=>L(r)&&L(r)(...E))})]),v[1]||(v[1]=k("div",{class:"header-icons"},null,-1))])]),_:1}),e(_e,null,{default:o(()=>[e(te,{class:"q-pa-md"},{default:o(()=>[e(Ke)]),_:1})]),_:1}),e(qe)]),_:1}))}};var _a=se(Je,[["__scopeId","data-v-dd277c78"]]);export{_a as default};
