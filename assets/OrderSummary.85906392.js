import{Q as be}from"./QSpinnerCube.d793e026.js";import{k as $e,p as Ve,F as xe,r as D,a as Be,j as P,w as me,q as n,G as $,H as r,v as s,I as i,a9 as de,aa as Q,x as u,s as c,ac as A,ad as E,aM as T,ab as f,y as I,ae as ce,aK as Fe,aL as Re,af as pe,J as b,ag as ye,ah as Ae,aN as Ee,B as Ie,a2 as ze,a8 as ge,aO as Le,aP as je}from"./index.926cdc30.js";import{u as Je}from"./summaryStore.af004ab1.js";import{Q as Ue}from"./QHeader.84613758.js";import{Q as Me}from"./QTooltip.8db7a570.js";import{Q as Ge}from"./QPage.761f77aa.js";import{a as He,Q as Ke}from"./QLayout.4f822e59.js";import{Q as We}from"./QSpinnerDots.68b3f3e1.js";import{Q as fe}from"./QItemLabel.1b922da2.js";import{Q as Xe,a as _e}from"./QItem.2901f214.js";import{C as ve}from"./ClosePopup.41240749.js";import{u as Ye}from"./use-quasar.4afeb4a4.js";import{g as Ze}from"./products.fba5c507.js";import{u as ea}from"./userStore.8829b966.js";import{a as aa}from"./api.92f95132.js";import{P as ta}from"./PlayerNavigationMenu.a926540a.js";import{_ as De}from"./plugin-vue_export-helper.21dcd24c.js";import{D as sa}from"./DesktopNavigation.185b43cd.js";import"./pinia.a55bf2ba.js";import"./position-engine.934de070.js";import"./selection.db442573.js";import"./supabase.f21eeafd.js";import"./QTabs.b974ffab.js";import"./rtl.276c3f1b.js";import"./QFooter.fc71ab7d.js";var oa=$e({name:"QSpace",setup(){const p=Ve("div",{class:"q-space"});return()=>p}});const la={class:"text-white"},ra={key:0},ia={class:"q-ml-md q-mb-sm",style:{"list-style-type":"none","padding-left":"0"}},na={class:"text-h6"},ua={key:2,class:"text-caption q-mt-sm"},ma={key:0,class:"text-center q-pa-md"},da={key:1,class:"text-grey-7 q-pa-md text-center"},ca={class:"row items-center no-wrap"},pa={class:"text-h6 text-black text-weight-bold q-mx-xs",style:{"min-width":"25px","text-align":"center"}},ya={__name:"OrderComponent",props:{summaryTitle:{type:String,required:!0,default:"Resumen"},itemDetails:{type:Array,required:!0,default:()=>[]},baseData:{type:Object,required:!0},commissionRate:{type:Number,default:4},showPublicToggle:{type:Boolean,default:!1},allowPaymentSplit:{type:Boolean,default:!1},extraData:{type:Object,default:()=>({})}},setup(p){var j,J,U;const e=p,h=xe(),w=Ye(),V=ea();console.log("OrderComponent - Props received:"),console.log("baseData:",e.baseData),console.log("extraData:",e.extraData),console.log("baseData.player2_email:",(j=e.baseData)==null?void 0:j.player2_email),console.log("extraData.player2_email:",(J=e.extraData)==null?void 0:J.player2_email);const d=D([]),l=Be({}),y=D([]),q=D(!1),B=D(!1),S=D(!1),F=D(!1),g=D(e.allowPaymentSplit&&((U=e.baseData)==null?void 0:U.participants)>1?"partial":"total"),R=P(()=>{var t;return(((t=e.baseData)==null?void 0:t.price)||0)+z.value}),Pe=P(()=>R.value*(e.commissionRate/100)),z=P(()=>y.value.reduce((a,t)=>a+t.product.price*t.quantity,0)),_=P(()=>R.value+Pe.value),he=P(()=>{var a;return[{label:`Pagar mi parte (1/${((a=e.baseData)==null?void 0:a.participants)||1})`,value:"partial"},{label:"Pagar el total",value:"total"}]}),ke=P(()=>{var o;const a=((o=e.baseData)==null?void 0:o.participants)||1;let t=_.value;return e.allowPaymentSplit&&a>1&&g.value==="partial"&&(t=_.value/a),`Pagar $${t.toFixed(2)}`}),L=async()=>{var a;if(!((a=e.baseData)!=null&&a.clubId)){d.value=[];return}B.value=!0;try{const t=await Ze(e.baseData.clubId);d.value=t||[],d.value.forEach(o=>{l[o.id]===void 0&&(l[o.id]=0)})}catch(t){console.error("Error al cargar productos:",t),d.value=[],w.notify({type:"warning",message:"No se pudieron cargar los productos adicionales."})}finally{B.value=!1}},we=()=>{var a;d.value.length===0&&((a=e.baseData)==null?void 0:a.clubId)?L():y.value.length===0&&d.value.forEach(t=>{l[t.id]=0}),q.value=!0},qe=a=>{(l[a]===void 0||l[a]===null||isNaN(Number(l[a])))&&(l[a]=0);const t=Number(l[a]);t>0&&(l[a]=t-1)},Qe=a=>{(l[a]===void 0||l[a]===null||isNaN(Number(l[a])))&&(l[a]=0);const t=Number(l[a]);l[a]=t+1},Se=()=>{y.value=d.value.filter(a=>l[a.id]&&Number(l[a.id])>0).map(a=>({product:{id:a.id,name:a.name,price:a.price},quantity:Number(l[a.id])})),q.value=!1},Ce=()=>{Ne("mercadopago")},Ne=async a=>{var t,o,m,C,M,G,H,K,W,X,Y,Z,ee,ae,te,se,oe,le,re,ie,ne;F.value=!0,w.loading.show({spinner:be,message:"Generando orden de pago..."});try{const v=((t=e.baseData)==null?void 0:t.participants)||1;let k=_.value,ue=!0;e.allowPaymentSplit&&v>1&&g.value==="partial"&&(k=_.value/v,ue=!1);const x={total_price:_.value,pay_total:ue,item_id:(o=e.baseData)==null?void 0:o.id,item_type:(m=e.baseData)==null?void 0:m.type,club_id:(C=e.baseData)==null?void 0:C.clubId,recipient_id:(M=e.baseData)==null?void 0:M.recipient_user_id,participants:v,products:y.value.map(O=>({id:O.product.id,quantity:O.quantity})),is_public:e.showPublicToggle?S.value:void 0};((G=e.baseData)==null?void 0:G.type)==="tournament"&&(x.player2_email=(W=(H=e.baseData)==null?void 0:H.player2_email)!=null?W:(K=e.extraData)==null?void 0:K.player2_email,x.tournament_name=(X=e.extraData)==null?void 0:X.tournament_name,x.is_retas=((Y=e.extraData)==null?void 0:Y.isRetas)||!1,console.log("Tournament registration - baseData:",e.baseData),console.log("Tournament registration - extraData:",e.extraData),console.log("Tournament registration - baseData.player2_email:",(Z=e.baseData)==null?void 0:Z.player2_email),console.log("Tournament registration - extraData.player2_email:",(ee=e.extraData)==null?void 0:ee.player2_email),console.log("Tournament registration - final player2_email:",x.player2_email),console.log("Tournament registration - is_retas:",x.is_retas)),console.log("Enviando a API /payment_order_and_split_payment:",x);const N=(ae=(await aa.post("payments/payment_order_and_split_payment",x)).data)==null?void 0:ae.payment_order_id;if(!N)throw new Error("Respuesta inv\xE1lida del servidor: No se recibi\xF3 payment_order_id.");if(a==="stripe")h.push({name:"StripePayment",query:{paymentOrderId:N,amountToPay:k.toFixed(2),totalAmount:_.value.toFixed(2),description:e.summaryTitle,clubId:(te=e.baseData)==null?void 0:te.clubId,baseData:JSON.stringify(e.baseData||{}),extraData:JSON.stringify(e.extraData||{}),selectedProducts:JSON.stringify(y.value||[]),itemDetails:JSON.stringify(e.itemDetails||[]),paymentOption:g.value}});else if(a==="mercadopago"){const O=[{id:((se=e.baseData)==null?void 0:se.id)||"item_1",title:e.summaryTitle,quantity:1,unit_price:k}],Oe={email:V.email||"user@example.com",name:V.fullName||"Usuario"},Te={cartItems:O,userInfo:Oe,externalReference:N,metadata:{payment_order_id:N,club_id:(oe=e.baseData)==null?void 0:oe.clubId,item_type:(le=e.baseData)==null?void 0:le.type,amount_to_pay:k,payment_option:g.value,item_id:(re=e.baseData)==null?void 0:re.id,participants:v,is_public_match:e.showPublicToggle?S.value:!1,total_amount:_.value,additional_items:y.value,...e.extraData&&{date:e.extraData.date,time:e.extraData.time,duration:e.extraData.duration,reservation_date:e.extraData.date,start_time:e.extraData.time,lesson_date:e.extraData.date,lesson_time:e.extraData.time,tournament_id:e.extraData.tournament_id,partner_id:e.extraData.partner_id,is_retas:e.extraData.is_retas,match_id:e.extraData.match_id,slot_index:e.extraData.slot_index,team_to_join:e.extraData.team_to_join},item_details:e.itemDetails}};localStorage.setItem("mercadoPaymentData",JSON.stringify(Te)),h.push({name:"MercadoPayment"})}}catch(v){console.error("Error en processPayment:",v);const k=((ne=(ie=v.response)==null?void 0:ie.data)==null?void 0:ne.message)||v.message||"Error al procesar el pago. Por favor intente de nuevo.";w.notify({type:"negative",message:k})}finally{F.value=!1,w.loading.hide()}};return me(()=>{var a;return(a=e.baseData)==null?void 0:a.clubId},(a,t)=>{a&&a!==t&&(d.value=[],y.value=[],Object.keys(l).forEach(o=>delete l[o]),L())},{immediate:!0}),me(()=>e.allowPaymentSplit,a=>{var t;a&&((t=e.baseData)==null?void 0:t.participants)>1?g.value="partial":g.value="total"},{immediate:!0}),(a,t)=>(n(),$(Ke,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:r(()=>[s(Ue,{elevated:"",class:"text-white"},{default:r(()=>t[3]||(t[3]=[i("div",{class:"header-content"},[i("div",{class:"greeting"},[i("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon"})]),i("div",{class:"header-icons"})],-1)])),_:1}),s(He,{class:"home"},{default:r(()=>[s(Ge,{class:"q-pa-md"},{default:r(()=>[s(de,{class:"text-white"},{default:r(()=>[s(Q,null,{default:r(()=>[i("h3",la,u(e.summaryTitle),1)]),_:1}),s(Q,null,{default:r(()=>{var o;return[(n(!0),c(E,null,A(e.itemDetails,(m,C)=>(n(),c("p",{key:C},[i("strong",null,u(m.label)+":",1),f(" "+u(m.value),1)]))),128)),s(T,{dark:"",spaced:"sm"}),i("p",null,[t[4]||(t[4]=i("strong",null,"Precio Base:",-1)),f(" $"+u(((o=e.baseData.price)==null?void 0:o.toFixed(2))||"0.00"),1)]),y.value.length>0?(n(),c("div",ra,[i("p",null,[t[5]||(t[5]=i("strong",null,"Adicionales:",-1)),f(" $"+u(z.value.toFixed(2)),1)]),i("ul",ia,[(n(!0),c(E,null,A(y.value,m=>(n(),c("li",{key:m.product.id,class:"text-caption"},[s(ce,{name:"mdi-cart-outline",size:"xs",class:"q-mr-xs"}),f(" "+u(m.product.name)+" x "+u(m.quantity)+" - $"+u((m.product.price*m.quantity).toFixed(2)),1)]))),128))])])):I("",!0),i("p",null,[t[6]||(t[6]=i("strong",null,"Subtotal:",-1)),f(" $"+u(R.value.toFixed(2)),1)]),s(T,{dark:"",spaced:"sm"}),i("p",na,[t[7]||(t[7]=i("strong",null,"Total a pagar:",-1)),f(" $"+u(_.value.toFixed(2))+" ",1),s(ce,{name:"o_info",size:"sm",class:"cursor-help q-ml-xs"},{default:r(()=>[s(Me,{anchor:"top middle",self:"bottom middle",offset:[0,10],class:"bg-grey-9 text-body2"},{default:r(()=>[f(" Precio total (Base + Adicionales + Comisi\xF3n del "+u(e.commissionRate)+"%). ",1)]),_:1})]),_:1})])]}),_:1}),s(Q,{class:"q-pt-none"},{default:r(()=>[e.showPublicToggle?(n(),$(Fe,{key:0,modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=o=>S.value=o),"checked-icon":"check",color:"green",label:"Partido P\xFAblico (otros podr\xE1n unirse)",class:"q-mb-sm"},null,8,["modelValue"])):I("",!0),e.allowPaymentSplit&&e.baseData.participants>1?(n(),$(Re,{key:1,modelValue:g.value,"onUpdate:modelValue":t[1]||(t[1]=o=>g.value=o),options:he.value,color:"green",inline:"",dense:""},null,8,["modelValue","options"])):e.baseData.participants>1?(n(),c("div",ua," Nota: El pago es individual por participante. ")):I("",!0)]),_:1}),s(pe,{align:"right",class:"q-pa-md"},{default:r(()=>[s(b,{icon:"mdi-basket-plus-outline",label:"Productos",color:"primary",onClick:we,dense:""}),s(b,{label:ke.value,color:"green","icon-right":"mdi-credit-card-outline",onClick:Ce,loading:F.value,padding:"sm lg"},null,8,["label","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),s(Ae,{modelValue:q.value,"onUpdate:modelValue":t[2]||(t[2]=o=>q.value=o)},{default:r(()=>[s(de,{style:{"min-width":"300px","max-width":"400px"},class:"bg-grey-2 text-black"},{default:r(()=>[s(Q,{class:"row items-center q-pb-none bg-primary text-white"},{default:r(()=>[t[8]||(t[8]=i("div",{class:"text-h6"},"A\xF1adir Productos",-1)),s(oa),ye(s(b,{icon:"close",flat:"",round:"",dense:""},null,512),[[ve]])]),_:1}),s(Q,{style:{"max-height":"60vh","overflow-y":"auto"}},{default:r(()=>[B.value?(n(),c("div",ma,[s(We,{color:"primary",size:"40px"}),t[9]||(t[9]=i("div",{class:"q-mt-sm"},"Cargando...",-1))])):!d.value||d.value.length===0?(n(),c("div",da," No hay productos adicionales disponibles en este club. ")):(n(!0),c(E,{key:2},A(d.value,o=>(n(),c("div",{key:o.id,class:"q-mb-xs"},[s(Xe,{dense:""},{default:r(()=>[s(_e,null,{default:r(()=>[s(fe,{class:"text-weight-medium text-black"},{default:r(()=>[f(u(o.name),1)]),_:2},1024),s(fe,{caption:""},{default:r(()=>[f("$"+u(o.price.toFixed(2)),1)]),_:2},1024)]),_:2},1024),s(_e,{side:"",top:""},{default:r(()=>[i("div",ca,[s(b,{icon:"mdi-minus",color:"negative",round:"",dense:"",flat:"",size:"sm",onClick:m=>qe(o.id),disable:!l[o.id]||l[o.id]<=0,class:"q-mr-xs"},null,8,["onClick","disable"]),i("span",pa,u(l[o.id]||0),1),s(b,{icon:"mdi-plus",color:"positive",round:"",dense:"",flat:"",size:"sm",onClick:m=>Qe(o.id),class:"q-ml-xs"},null,8,["onClick"])])]),_:2},1024)]),_:2},1024),s(T,{spaced:"xs"})]))),128))]),_:1}),s(T),s(pe,{align:"right",class:"q-pa-md"},{default:r(()=>[ye(s(b,{label:"Cancelar",color:"grey-7",flat:""},null,512),[[ve]]),s(b,{label:"Aceptar",color:"primary",push:"",onClick:Se})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(ta)]),_:1}))}};var ga=De(ya,[["__scopeId","data-v-c545dbac"]]);const fa=Ee({name:"OrderSummary",components:{OrderComponent:ga,DesktopNavigation:sa},setup(){const p=Je(),e=xe(),h=P(()=>p.getSummaryDetails);return Ie(()=>{p.hasActiveSummary?console.log("ReservationSummaryPage mounted with data:",h.value):(console.warn("No hay datos de resumen en el store. Redirigiendo..."),e.replace({name:"DashboardPlayer"}))}),ze(()=>{p.clearSummaryDetails()}),{summaryData:h}}}),_a={key:1,class:"fullscreen bg-dark text-white text-center q-pa-md flex flex-center"};function va(p,e,h,w,V,d){const l=ge("OrderComponent"),y=ge("DesktopNavigation");return n(),c("div",null,[p.summaryData?(n(),$(l,Le(je({key:0},p.summaryData)),null,16)):(n(),c("div",_a,[i("div",null,[s(be,{color:"orange",size:"xl"}),e[1]||(e[1]=i("div",{class:"q-mt-md text-h6"},"Cargando resumen...",-1)),s(b,{class:"q-mt-xl",color:"white","text-color":"black",unelevated:"",onClick:e[0]||(e[0]=q=>p.$router.go(-1)),label:"Volver","no-caps":""})])])),s(y)])}var Ua=De(fa,[["render",va]]);export{Ua as default};
