import{r as h,h as R,s as D,a1 as T,o as v,z as b,A as n,d as o,a7 as N,B as m,a as S,aa as P,ab as j,E as V,bJ as q,D as M,a5 as L,a6 as w}from"./index.343c8145.js";import{Q as F}from"./QHeader.74e9ea06.js";import{Q as k}from"./QPage.c2a4954a.js";import{a as I,Q as C}from"./QLayout.cf8964e2.js";import{s as p}from"./supabase.6e6ca5a2.js";import{Q as x}from"./QChatMessage.6e5672a5.js";import{_ as U}from"./plugin-vue_export-helper.21dcd24c.js";import{n as H}from"./navigationUtils.2c4b9dee.js";import{P as K}from"./PlayerNavigationMenu.c9ce75b7.js";import"./QTabs.ffe1e49b.js";import"./rtl.276c3f1b.js";import"./QFooter.32609e6a.js";const J={props:{matchId:{type:String,required:!0}},components:{QChatMessage:x},setup(c){const t=h([]),l=h(""),e=h(null),u=h({full_name:"Usuario desconocido"}),g=h({});let s=null;const i=async()=>{try{const{data:a,error:r}=await p.from("chat_messages").select("*").eq("match_id",c.matchId).order("timestamp",{ascending:!0});r?console.error("Error al cargar mensajes:",r):t.value=a}catch(a){console.error("Error inesperado al cargar mensajes:",a)}},d=async a=>{try{const{data:r,error:_}=await p.from("players").select("user_id, first_name, photo_url").in("user_id",a);_?console.error("Error al obtener detalles de usuarios:",_):r.forEach(f=>{g.value[f.user_id]=f})}catch(r){console.error("Error inesperado al obtener detalles de usuarios:",r)}},E=async()=>{try{const{error:a}=await p.from("chat_messages").insert({match_id:c.matchId,sender:u.value.full_name,sender_id:e.value,message:l.value.trim()});a?console.error("Error al enviar mensaje:",a):l.value=""}catch(a){console.error("Error inesperado al enviar mensaje:",a)}},Q=()=>{s=p.channel("public:chat_messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`match_id=eq.${c.matchId}`},a=>{t.value.push(a.new)}).subscribe(a=>{a==="SUBSCRIBED"&&console.log("Realtime subscription active")})},B=a=>new Date(a).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});return R(async()=>{const a=await D.getItem("token");if(a){const f=a.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),y=JSON.parse(atob(f));e.value=y.sub,u.value.full_name=y.full_name||"Usuario desconocido"}await i();const r=t.value.map(_=>_.sender_id);await d(r),Q()}),T(()=>{s&&p.removeChannel(s)}),{currentUserId:e,messages:t,newMessage:l,formatTimestamp:B,sendMessage:E,user:u,userMap:g}}},z={class:"chat-messages"},A={class:"chat-message-input"};function O(c,t,l,e,u,g){return v(),b(C,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:n(()=>[o(I,null,{default:n(()=>[o(k,null,{default:n(()=>[o(N,{class:"text-white chat-card"},{default:n(()=>[m("div",z,[(v(!0),S(j,null,P(e.messages,s=>{var i,d;return v(),b(x,{key:s.id,name:((i=e.userMap[s.sender_id])==null?void 0:i.first_name)||"Usuario desconocido",avatar:(d=e.userMap[s.sender_id])==null?void 0:d.photo_url,text:[s.message],stamp:e.formatTimestamp(s.timestamp),sent:s.sender_id===e.currentUserId,"bg-color":s.sender_id===e.currentUserId?"amber-7":"primary","text-color":s.sender_id===e.currentUserId?"black":"white"},null,8,["name","avatar","text","stamp","sent","bg-color","text-color"])}),128))])]),_:1}),m("div",A,[o(V,{modelValue:e.newMessage,"onUpdate:modelValue":t[0]||(t[0]=s=>e.newMessage=s),placeholder:"Escribe un mensaje...",outlined:"",dense:"",dark:"",onKeyup:q(e.sendMessage,["enter"])},null,8,["modelValue","onKeyup"]),o(M,{color:"black",onClick:e.sendMessage,disable:!e.newMessage.trim(),icon:"o_send"},null,8,["onClick","disable"])])]),_:1})]),_:1})]),_:1})}var X=U(J,[["render",O],["__scopeId","data-v-15191bba"]]);const G={components:{MatchChatRoom:X,PlayerNavigationMenu:K},setup(){return{matchId:L().params.matchId,goBack:()=>{window.history.back()},goToDashboard:()=>{H(router,userStore)}}}},W={class:"header-content"},Y={class:"greeting"},Z={class:"header-icons"};function $(c,t,l,e,u,g){const s=w("MatchChatRoom"),i=w("PlayerNavigationMenu");return v(),b(C,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:n(()=>[o(F,{elevated:"",class:"bg-primary text-white"},{default:n(()=>[m("div",W,[m("div",Y,[m("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon clickable-logo",onClick:t[0]||(t[0]=(...d)=>e.goToDashboard&&e.goToDashboard(...d))})]),m("div",Z,[o(M,{flat:"",round:"",icon:"close",onClick:e.goBack},null,8,["onClick"])])])]),_:1}),o(I,null,{default:n(()=>[o(k,{class:"q-pa-md"},{default:n(()=>[o(s,{matchId:e.matchId},null,8,["matchId"])]),_:1})]),_:1}),o(i)]),_:1})}var ue=U(G,[["render",$],["__scopeId","data-v-586a3f20"]]);export{ue as default};
