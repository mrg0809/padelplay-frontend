import{k as Q,j as f,p as o,bx as E,r as b,B as R,a2 as N,q as M,G as w,H as g,v as d,ab as D,I as p,s as L,ae as P,af as j,K as V,bF as $,J as I,a9 as z,aa as q}from"./index.e2d2987d.js";import{Q as F}from"./QHeader.749f252e.js";import{Q as B}from"./QPage.b49faddd.js";import{a as H,Q as S}from"./QLayout.1c0276b1.js";import{s as x}from"./supabase.35b69d41.js";import{_ as T}from"./plugin-vue_export-helper.21dcd24c.js";import{n as K}from"./navigationUtils.2c4b9dee.js";import{P as J}from"./PlayerNavigationMenu.eef848b6.js";import"./QTabs.47989598.js";import"./rtl.276c3f1b.js";import"./QFooter.cc7bc209.js";var U=Q({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(e,{slots:s}){const l=f(()=>e.sent===!0?"sent":"received"),t=f(()=>`q-message-text-content q-message-text-content--${l.value}`+(e.textColor!==void 0?` text-${e.textColor}`:"")),v=f(()=>`q-message-text q-message-text--${l.value}`+(e.bgColor!==void 0?` text-${e.bgColor}`:"")),_=f(()=>"q-message-container row items-end no-wrap"+(e.sent===!0?" reverse":"")),r=f(()=>e.size!==void 0?`col-${e.size}`:""),c=f(()=>({msg:e.textHtml===!0?"innerHTML":"textContent",stamp:e.stampHtml===!0?"innerHTML":"textContent",name:e.nameHtml===!0?"innerHTML":"textContent",label:e.labelHtml===!0?"innerHTML":"textContent"}));function u(i){return s.stamp!==void 0?[i,o("div",{class:"q-message-stamp"},s.stamp())]:e.stamp?[i,o("div",{class:"q-message-stamp",[c.value.stamp]:e.stamp})]:[i]}function C(i,m){const a=m===!0?i.length>1?n=>n:n=>o("div",[n]):n=>o("div",{[c.value.msg]:n});return i.map((n,h)=>o("div",{key:h,class:v.value},[o("div",{class:t.value},u(a(n)))]))}return()=>{const i=[];s.avatar!==void 0?i.push(s.avatar()):e.avatar!==void 0&&i.push(o("img",{class:`q-message-avatar q-message-avatar--${l.value}`,src:e.avatar,"aria-hidden":"true"}));const m=[];s.name!==void 0?m.push(o("div",{class:`q-message-name q-message-name--${l.value}`},s.name())):e.name!==void 0&&m.push(o("div",{class:`q-message-name q-message-name--${l.value}`,[c.value.name]:e.name})),s.default!==void 0?m.push(C(E(s.default()),!0)):e.text!==void 0&&m.push(C(e.text)),i.push(o("div",{class:r.value},m));const a=[];return s.label!==void 0?a.push(o("div",{class:"q-message-label"},s.label())):e.label!==void 0&&a.push(o("div",{class:"q-message-label",[c.value.label]:e.label})),a.push(o("div",{class:_.value},i)),o("div",{class:`q-message q-message-${l.value}`},a)}}});const A={props:{matchId:{type:String,required:!0}},components:{QChatMessage:U},setup(e){const s=b([]),l=b(""),t=b(null),v=b({full_name:"Usuario desconocido"}),_=b({});let r=null;const c=async()=>{try{const{data:a,error:n}=await x.from("chat_messages").select("*").eq("match_id",e.matchId).order("timestamp",{ascending:!0});n?console.error("Error al cargar mensajes:",n):s.value=a}catch(a){console.error("Error inesperado al cargar mensajes:",a)}},u=async a=>{try{const{data:n,error:h}=await x.from("players").select("user_id, first_name, photo_url").in("user_id",a);h?console.error("Error al obtener detalles de usuarios:",h):n.forEach(y=>{_.value[y.user_id]=y})}catch(n){console.error("Error inesperado al obtener detalles de usuarios:",n)}},C=async()=>{try{const{error:a}=await x.from("chat_messages").insert({match_id:e.matchId,sender:v.value.full_name,sender_id:t.value,message:l.value.trim()});a?console.error("Error al enviar mensaje:",a):l.value=""}catch(a){console.error("Error inesperado al enviar mensaje:",a)}},i=()=>{r=x.channel("public:chat_messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`match_id=eq.${e.matchId}`},a=>{s.value.push(a.new)}).subscribe(a=>{a==="SUBSCRIBED"&&console.log("Realtime subscription active")})},m=a=>new Date(a).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});return R(async()=>{const a=localStorage.getItem("token");if(a){const y=a.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),k=JSON.parse(atob(y));t.value=k.sub,v.value.full_name=k.full_name||"Usuario desconocido"}await c();const n=s.value.map(h=>h.sender_id);await u(n),i()}),N(()=>{r&&x.removeChannel(r)}),{currentUserId:t,messages:s,newMessage:l,formatTimestamp:m,sendMessage:C,user:v,userMap:_}}},G={class:"chat-messages"},O={class:"chat-message-input"};function X(e,s,l,t,v,_){return M(),w(S,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:g(()=>[d(H,null,{default:g(()=>[d(B,null,{default:g(()=>[d(D,{class:"text-white chat-card"},{default:g(()=>[p("div",G,[(M(!0),L(j,null,P(t.messages,r=>{var c,u;return M(),w(U,{key:r.id,name:((c=t.userMap[r.sender_id])==null?void 0:c.first_name)||"Usuario desconocido",avatar:(u=t.userMap[r.sender_id])==null?void 0:u.photo_url,text:[r.message],stamp:t.formatTimestamp(r.timestamp),sent:r.sender_id===t.currentUserId,"bg-color":r.sender_id===t.currentUserId?"amber-7":"primary","text-color":r.sender_id===t.currentUserId?"black":"white"},null,8,["name","avatar","text","stamp","sent","bg-color","text-color"])}),128))])]),_:1}),p("div",O,[d(V,{modelValue:t.newMessage,"onUpdate:modelValue":s[0]||(s[0]=r=>t.newMessage=r),placeholder:"Escribe un mensaje...",outlined:"",dense:"",dark:"",onKeyup:$(t.sendMessage,["enter"])},null,8,["modelValue","onKeyup"]),d(I,{color:"black",onClick:t.sendMessage,disable:!t.newMessage.trim(),icon:"o_send"},null,8,["onClick","disable"])])]),_:1})]),_:1})]),_:1})}var W=T(A,[["render",X],["__scopeId","data-v-16742b44"]]);const Y={components:{MatchChatRoom:W,PlayerNavigationMenu:J},setup(){return{matchId:z().params.matchId,goBack:()=>{window.history.back()},goToDashboard:()=>{K(router,userStore)}}}},Z={class:"header-content"},ee={class:"greeting"},ae={class:"header-icons"};function te(e,s,l,t,v,_){const r=q("MatchChatRoom"),c=q("PlayerNavigationMenu");return M(),w(S,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:g(()=>[d(F,{elevated:"",class:"bg-primary text-white"},{default:g(()=>[p("div",Z,[p("div",ee,[p("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon clickable-logo",onClick:s[0]||(s[0]=(...u)=>t.goToDashboard&&t.goToDashboard(...u))})]),p("div",ae,[d(I,{flat:"",round:"",icon:"close",onClick:t.goBack},null,8,["onClick"])])])]),_:1}),d(H,null,{default:g(()=>[d(B,{class:"q-pa-md"},{default:g(()=>[d(r,{matchId:t.matchId},null,8,["matchId"])]),_:1})]),_:1}),d(c)]),_:1})}var ve=T(Y,[["render",te],["__scopeId","data-v-586a3f20"]]);export{ve as default};
