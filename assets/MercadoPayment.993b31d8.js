import{Q as Ae}from"./QHeader.74e9ea06.js";import{r as i,f as be,h as ke,w as xe,o as w,z as j,A as l,d as r,B as o,a8 as Q,Q as _e,e as O,a as G,aa as Ne,ab as qe,aK as Me,D as J,ac as W,t as $,E as ye,aR as Ve,a9 as Re,aS as ze,aT as Ie,a7 as ie,aP as Fe,J as Pe,S as je,x as Oe,a5 as Qe,a6 as he,af as Ee,ad as Se}from"./index.343c8145.js";import{Q as Te}from"./QBanner.5b79c17c.js";import{Q as Ue}from"./QPage.c2a4954a.js";import{Q as $e,a as Le}from"./QLayout.cf8964e2.js";import{u as we}from"./use-quasar.ffcb6c45.js";import{Q as De}from"./QForm.4454f63e.js";import{_ as Be}from"./MP_RGB_horizontal.ee11db59.js";import{a as S}from"./api.c78da0f8.js";import{i as Ke,o as He}from"./capacitorPaymentUtils.98bc7ac2.js";import{_ as Ce}from"./plugin-vue_export-helper.21dcd24c.js";import{P as Ye}from"./PlayerNavigationMenu.c9ce75b7.js";import{d as Je,e as We,g as Ge,h as Ze,i as Xe}from"./finalizeUtils.f306d73e.js";import"./QTabs.ffe1e49b.js";import"./rtl.276c3f1b.js";import"./QFooter.32609e6a.js";import"./hourUtils.51636ade.js";const ea={class:"text-center"},aa={class:"row q-col-gutter-sm"},ta={class:"col"},oa={class:"text-body2"},ra={class:"text-caption"},na={class:"text-caption"},sa={class:"text-center"},la={class:"text-center text-white"},ia={key:0,class:"q-mb-md"},ca={class:"row items-center q-py-md"},ua=["src","alt"],da={class:"text-white text-h6"},ma=["src","alt"],pa={class:"row q-col-gutter-md"},va={class:"col-6"},ya={class:"col-6"},_a={class:"text-center"},ga={class:"q-mb-md"},fa={__name:"CheckoutAPI",props:{cartItems:{type:Array,required:!0},userInfo:{type:Object,required:!0},totalAmount:{type:Number,required:!0},externalReference:{type:String,required:!0},metadata:{type:Object,default:()=>({})}},emits:["payment-success","payment-error"],setup(L,{emit:p}){const s=L,n=p,E=we(),I=i(!0),k=i(!1),N=i(!1),z=i(null),m=i(!1),b=i(""),A=i([]),V=i(null),x=i([]),y=i(null),P=i([]),R=i(null),c=i({number:"",holderName:"",expiry:"",cvv:""}),ue=i(1),u=i(!1),_=i(!1),d=i({supports_tokenization:!0,supports_deferred_capture:!0,payment_method_id:null,issuer_id:null,card_type:null,message:""});be(()=>[{label:"1 pago",value:1}]);const g=be(()=>R.value&&!m.value?!0:b.value&&b.value!==null&&b.value!==""&&ae(c.value.number)&&c.value.holderName&&c.value.holderName.trim()!==""&&K(c.value.expiry)&&Z(c.value.cvv)),T=e=>{const t={visa:"credit_card",master:"credit_card",amex:"credit_card",naranja:"credit_card",cabal:"credit_card",default:"credit_card"};return t[e]||t.default},q=e=>({visa:"VISA",master:"Mastercard",amex:"American Express",naranja:"Naranja",cabal:"Cabal"})[e]||(e==null?void 0:e.toUpperCase()),D=e=>({visa:"visa",master:"mastercard",amex:"amex"})[e]||e,F=e=>`/icons/${D(e)}.svg`,ae=e=>{if(!e)return!1;const t=e.replace(/\s/g,"");return t.length>=13&&t.length<=19&&/^\d+$/.test(t)},K=e=>{if(!e||e.length!==5)return!1;const[t,a]=e.split("/"),h=parseInt(t),U=parseInt("20"+a),B=new Date,v=B.getFullYear(),M=B.getMonth()+1;return h>=1&&h<=12&&U>=v&&(U>v||h>=M)},Z=e=>e?e.length>=3&&e.length<=4&&/^\d+$/.test(e):!1,te=()=>{let e=c.value.number.replace(/\s/g,"");e=e.replace(/(.{4})/g,"$1 ").trim(),c.value.number=e;const t=e.replace(/\s/g,"");oe(t)},X=()=>{let e=c.value.expiry.replace(/\D/g,"");e.length>=2&&(e=e.substring(0,2)+"/"+e.substring(2,4)),c.value.expiry=e},de=async e=>{try{if(!e){x.value=[],y.value=null;return}const t=await S.get(`/payments/card_issuers/${e}`);t.data&&t.data.issuers?(x.value=t.data.issuers,x.value.length>0?(y.value=x.value[0].id,console.log(`Auto-selected issuer for Mexico compatibility: ${x.value[0].id} (${x.value[0].name})`)):(y.value=null,console.warn(`No issuers found for payment method: ${e}`))):(x.value=[],y.value=null)}catch(t){console.error("Error loading card issuers:",t),x.value=[],y.value=null}},ee=async e=>{try{if(!e||e.length<6){_.value=!1,d.value={supports_tokenization:!0,supports_deferred_capture:!0,payment_method_id:null,issuer_id:null,card_type:null,message:""};return}console.log(`Checking BIN capabilities for: ${e.substring(0,6)}`);const t=await S.get(`/payments/check_bin_capabilities/${e.substring(0,6)}`);t.data&&(d.value=t.data,_.value=!0,console.log("BIN check result:",{supports_tokenization:t.data.supports_tokenization,card_type:t.data.card_type,message:t.data.message}))}catch(t){console.error("Error checking BIN capabilities:",t),_.value=!0,d.value={supports_tokenization:!1,supports_deferred_capture:!1,payment_method_id:null,issuer_id:null,card_type:null,message:"No se pudo verificar la tarjeta. Se usar\xE1 pago directo."}}},oe=async e=>{if(!e){b.value="",V.value=null,x.value=[],y.value=null,_.value=!1;return}const t={visa:/^4/,master:/^5[1-5]/,amex:/^3[47]/};for(const[a,h]of Object.entries(t))if(h.test(e)){const B=b.value!==a;b.value=a,V.value=a,B&&x.value.length===0&&await de(a),e.length===6&&!_.value&&await ee(e);return}b.value="",V.value=null,x.value=[],y.value=null,_.value=!1},Y=e=>{},re=e=>{},ne=async()=>{try{N.value=!0;const e=await S.get("/payments/payment_methods");if(e.data&&e.data.payment_methods){const t=["visa","master","amex","pse","efecty","bancolombia","banco_agrario","banco_av_villas","banco_bogota","banco_davivienda","banco_falabella","banco_gnb_sudameris","banco_itau","banco_occidente","banco_popular","banco_santander_colombia","bbva_colombia"];A.value=e.data.payment_methods.filter(a=>t.includes(a.id)||a.payment_type_id==="credit_card"&&["visa","master","amex"].includes(a.id)||a.payment_type_id==="bank_transfer"),V.value=null}else throw new Error("Invalid response format")}catch(e){console.error("Error loading payment methods:",e),A.value=[],V.value=null,E.notify({type:"negative",message:"Error al cargar m\xE9todos de pago"})}finally{N.value=!1}},C=async()=>{try{const e=await S.get("/payments/saved_payment_methods");e.data&&e.data.saved_payment_methods?P.value=e.data.saved_payment_methods:P.value=[]}catch(e){console.error("Error loading saved payment methods:",e),P.value=[]}},f=e=>{R.value=e,m.value=!1},se=async e=>{var t;try{z.value=e.id,await S.delete(`/payments/saved_payment_methods/${e.id}`),P.value=P.value.filter(a=>a.id!==e.id),((t=R.value)==null?void 0:t.id)===e.id&&(R.value=null),E.notify({type:"positive",message:"M\xE9todo de pago eliminado"})}catch(a){console.error("Error deleting saved method:",a),E.notify({type:"negative",message:"Error al eliminar m\xE9todo de pago"})}finally{z.value=null}},le=async()=>{var e,t,a,h,U,B;try{k.value=!0;const v=_.value&&!d.value.supports_tokenization;console.log(`Payment flow: ${v?"CHECKOUT PRO (BIN exclusion fallback)":"TOKENIZATION"}`),console.log("BIN capabilities:",d.value);const[M,ge]=c.value.expiry.split("/");let ce,me;if(v){me="/payments/create_checkout_pro_fallback",ce={transaction_amount:s.totalAmount,description:`Pago por ${s.cartItems.length} items`,external_reference:s.externalReference,payer:{email:s.userInfo.email,first_name:((e=s.userInfo.name)==null?void 0:e.split(" ")[0])||"",last_name:((t=s.userInfo.name)==null?void 0:t.split(" ").slice(1).join(" "))||""},metadata:s.metadata},console.log("Using CHECKOUT PRO fallback for BIN exclusion");const ve=await S.post(me,ce),{init_point:pe,preference_id:Oa}=ve.data;console.log("Received init_point:",pe),Ke()?(console.log("Opening Checkout Pro in native browser"),await He(pe),E.notify({type:"info",message:"Abriendo pasarela de pago...",timeout:2e3})):(console.log("Redirecting to Checkout Pro in web browser"),window.location.href=pe);return}else{me="/payments/process_payment";const pe=(await S.post("/payments/tokenize_card",{card_number:c.value.number.replace(/\s/g,""),expiration_month:M,expiration_year:"20"+ge,security_code:c.value.cvv,card_holder_name:c.value.holderName})).data.token;ce={transaction_amount:s.totalAmount,description:`Pago por ${s.cartItems.length} items`,payment_method_id:V.value,payer:{email:s.userInfo.email,first_name:((a=s.userInfo.name)==null?void 0:a.split(" ")[0])||"",last_name:((h=s.userInfo.name)==null?void 0:h.split(" ").slice(1).join(" "))||""},payment_method:{token:pe,installments:ue.value||1,card_holder_name:c.value.holderName,issuer_id:y.value},external_reference:s.externalReference,metadata:s.metadata},console.log("Using TOKENIZATION flow with pre-generated token")}console.log(`Calling endpoint: ${me}`);const fe=(await S.post(me,ce)).data;if(u.value&&fe.status==="approved"&&d.value.supports_tokenization&&!useDirectPayment)try{await S.post("/payments/save_payment_method",{payment_method_id:V.value,last_four_digits:c.value.number.replace(/\s/g,"").slice(-4),card_holder_name:c.value.holderName,expiration_month:M,expiration_year:"20"+ge,issuer_name:fe.issuer_name}),E.notify({type:"positive",message:"M\xE9todo de pago guardado exitosamente",timeout:2e3})}catch(ve){console.error("Error saving payment method:",ve)}n("payment-success",fe)}catch(v){console.error("Payment error:",v);const M=((B=(U=v.response)==null?void 0:U.data)==null?void 0:B.detail)||"Error al procesar el pago";n("payment-error",M),E.notify({type:"negative",message:M})}finally{k.value=!1}},H=async()=>{try{k.value=!0,E.notify({type:"negative",message:"Los m\xE9todos guardados requieren una implementaci\xF3n avanzada. Por favor, usa una nueva tarjeta."}),m.value=!0,R.value=null}catch(e){console.error("Saved method payment error:",e),n("payment-error","Error al procesar pago con m\xE9todo guardado")}finally{k.value=!1}};return ke(async()=>{try{await Promise.all([ne(),C()]),P.value.length===0&&(m.value=!0)}catch(e){console.error("Error during component initialization:",e),E.notify({type:"negative",message:"Error al inicializar el formulario de pago"})}finally{I.value=!1}}),xe(()=>c.value.number,e=>{if(e){const t=e.replace(/\s/g,"");oe(t)}else b.value="",V.value=null,x.value=[],y.value=null,_.value=!1,d.value={supports_tokenization:!0,supports_deferred_capture:!0,payment_method_id:null,issuer_id:null,card_type:null,message:""}},{immediate:!0}),(e,t)=>(w(),j(ie,{class:"text-white"},{default:l(()=>[r(Q,null,{default:l(()=>[...t[6]||(t[6]=[o("img",{src:Be,alt:"Logo",style:{height:"150px",width:"auto"},class:"q-mb-md"},null,-1),o("p",{class:"text-caption"},"Ingresa los datos de tu tarjeta de manera segura",-1)])]),_:1}),I.value?(w(),j(Q,{key:0},{default:l(()=>[o("div",ea,[r(_e,{color:"primary",size:"3rem"}),t[7]||(t[7]=o("p",{class:"q-mt-md"},"Cargando m\xE9todos de pago...",-1))])]),_:1})):O("",!0),!I.value&&P.value.length>0?(w(),j(Q,{key:1},{default:l(()=>[t[8]||(t[8]=o("h5",{class:"q-mb-md"},"M\xE9todos de pago guardados",-1)),o("div",aa,[(w(!0),G(qe,null,Ne(P.value,a=>{var h;return w(),G("div",{key:a.id,class:"col-12"},[r(ie,{flat:"",bordered:"",class:Fe(((h=R.value)==null?void 0:h.id)===a.id?"bg-primary text-white":"bg-grey-8 text-white"),clickable:"",onClick:U=>f(a)},{default:l(()=>[r(Q,{class:"row items-center"},{default:l(()=>[r(W,{name:T(a.payment_method_id),size:"sm",class:"q-mr-sm"},null,8,["name"]),o("div",ta,[o("div",oa,"**** **** **** "+$(a.last_four_digits),1),o("div",ra,$(a.card_holder_name),1),o("div",na,$(a.expiration_month)+"/"+$(a.expiration_year),1)]),r(J,{flat:"",icon:"delete",size:"sm",onClick:Ie(U=>se(a),["stop"]),loading:z.value===a.id},null,8,["onClick","loading"])]),_:2},1024)]),_:2},1032,["class","onClick"])])}),128))]),r(Me,{class:"q-my-md"}),r(J,{flat:"",label:m.value?"Usar m\xE9todo guardado":"Usar nueva tarjeta",onClick:t[0]||(t[0]=a=>m.value=!m.value),class:"full-width q-mb-md"},null,8,["label"])]),_:1})):O("",!0),!I.value&&N.value?(w(),j(Q,{key:2},{default:l(()=>[o("div",sa,[r(_e,{color:"primary",size:"2rem"}),t[9]||(t[9]=o("p",{class:"q-mt-md text-white"},"Cargando m\xE9todos de pago...",-1))])]),_:1})):O("",!0),!I.value&&!N.value&&A.value.length===0&&(P.value.length===0||m.value)?(w(),j(Q,{key:3},{default:l(()=>[o("div",la,[r(W,{name:"error",size:"3rem",color:"negative"}),t[10]||(t[10]=o("p",{class:"q-mt-md"},"No se pudieron cargar los m\xE9todos de pago disponibles.",-1)),r(J,{color:"primary",label:"Reintentar",onClick:ne,class:"q-mt-md"})])]),_:1})):O("",!0),!I.value&&!N.value&&A.value.length>0&&(P.value.length===0||m.value)?(w(),j(Q,{key:4},{default:l(()=>[r(De,{onSubmit:Ie(le,["prevent"])},{default:l(()=>[b.value?(w(),G("div",ia,[t[11]||(t[11]=o("div",{class:"text-body2 q-mb-sm text-white"},"Tipo de tarjeta detectado",-1)),o("div",ca,[o("img",{src:F(b.value),alt:q(b.value),style:{height:"32px",width:"auto",filter:"brightness(1.2)"},class:"q-mr-md",onError:Y,onLoad:re},null,40,ua),o("span",da,$(q(b.value)),1)])])):O("",!0),r(ye,{modelValue:c.value.number,"onUpdate:modelValue":t[1]||(t[1]=a=>c.value.number=a),label:"N\xFAmero de tarjeta",placeholder:"1234 5678 9012 3456",filled:"",dark:"",maxlength:"19",rules:[a=>ae(a)||"N\xFAmero de tarjeta inv\xE1lido"],onInput:te,class:"q-mb-md"},Ve({_:2},[b.value?{name:"prepend",fn:l(()=>[o("img",{src:F(b.value),alt:q(b.value),style:{height:"24px",width:"auto"},onError:Y,onLoad:re},null,40,ma)]),key:"0"}:{name:"prepend",fn:l(()=>[r(W,{name:"credit_card",color:"grey"})]),key:"1"}]),1032,["modelValue","rules"]),r(ye,{modelValue:c.value.holderName,"onUpdate:modelValue":t[2]||(t[2]=a=>c.value.holderName=a),label:"Nombre del titular",placeholder:"JUAN P\xC9REZ",filled:"",dark:"",rules:[a=>!!a||"El nombre es requerido"],class:"q-mb-md"},null,8,["modelValue","rules"]),o("div",pa,[o("div",va,[r(ye,{modelValue:c.value.expiry,"onUpdate:modelValue":t[3]||(t[3]=a=>c.value.expiry=a),label:"MM/AA",placeholder:"12/28",filled:"",dark:"",maxlength:"5",rules:[a=>K(a)||"Fecha inv\xE1lida (MM/AA)"],onInput:X,onKeyup:X},null,8,["modelValue","rules"])]),o("div",ya,[r(ye,{modelValue:c.value.cvv,"onUpdate:modelValue":t[4]||(t[4]=a=>c.value.cvv=a),label:"CVV",placeholder:"123",filled:"",dark:"",maxlength:"4",type:"password",rules:[a=>Z(a)||"CVV inv\xE1lido"]},null,8,["modelValue","rules"])])]),_.value&&!d.value.supports_tokenization?(w(),j(Te,{key:1,class:"bg-secondary text-white q-mb-md",rounded:""},{avatar:l(()=>[r(W,{name:"info",color:"white"})]),default:l(()=>[t[12]||(t[12]=o("div",null,[o("strong",null,"Pago seguro alternativo"),o("br"),Re(" Para esta tarjeta, completar\xE1s el pago en el portal seguro de MercadoPago. Esto es requerido por tu banco para mayor seguridad. ")],-1))]),_:1})):O("",!0),_.value&&d.value.supports_tokenization?(w(),j(ze,{key:2,modelValue:u.value,"onUpdate:modelValue":t[5]||(t[5]=a=>u.value=a),label:"Guardar m\xE9todo de pago para futuras compras",color:"primary",dark:"",class:"q-mb-md"},null,8,["modelValue"])):O("",!0),r(J,{type:"submit",color:g.value?"positive":"primary",size:"lg",label:_.value&&!d.value.supports_tokenization?"Continuar a pago seguro":`Pagar $${L.totalAmount}`,class:"full-width text black",loading:k.value,disable:!g.value},null,8,["color","label","loading","disable"])]),_:1})]),_:1})):O("",!0),!I.value&&!N.value&&R.value&&!m.value?(w(),j(Q,{key:5},{default:l(()=>[o("div",_a,[o("p",ga," Pagar con: **** **** **** "+$(R.value.last_four_digits),1),r(J,{color:"positive",size:"lg",label:`Pagar $${L.totalAmount}`,class:"full-width",loading:k.value,onClick:H},null,8,["label","loading"])])]),_:1})):O("",!0)]),_:1}))}};var ha=Ce(fa,[["__scopeId","data-v-24c04a4c"]]);const ba={class:"checkout-bricks-container text-white"},xa={key:0,class:"error-card"},ka={class:"q-mt-md"},wa={class:"payment-section"},Ca={class:"payment-brick-wrapper brick-isolation"},Ia={key:0,class:"brick-loading-overlay text-center"},Pa={__name:"CheckoutBricks",props:{cartItems:{type:Array,required:!0},userInfo:{type:Object,required:!0},totalAmount:{type:Number,required:!0},externalReference:{type:String,required:!0},metadata:{type:Object,default:()=>({})}},emits:["payment-success","payment-error"],setup(L,{emit:p}){const s=L,n=p,E=we(),I=i(!0),k=i(null),N=i(!1),z=i(null),m=i([]),b=i(null),A=i(!1);let V=null,x=null,y=null,P=0;function R(){return window.MercadoPago}function c(d=5e3){return new Promise((g,T)=>{if(R()){g(R());return}const q=Date.now(),D=setInterval(()=>{R()?(clearInterval(D),g(R())):Date.now()-q>d&&(clearInterval(D),T(new Error("Mercado Pago SDK no carg\xF3")))},100)})}async function ue(){var d,g;try{const T=await S.get("/payments/saved_payment_methods");z.value=((d=T.data)==null?void 0:d.mercadopago_customer_id)||null,m.value=(((g=T.data)==null?void 0:g.saved_payment_methods)||[]).filter(q=>q.mercadopago_card_id)}catch{z.value=null,m.value=[]}}async function u(){var d,g,T;if(z.value)return!0;try{const q=await S.post("/payments/create_or_get_customer");return z.value=((d=q.data)==null?void 0:d.mercadopago_customer_id)||null,Boolean(z.value)}catch(q){const D=((T=(g=q.response)==null?void 0:g.data)==null?void 0:T.detail)||q.message||"No se pudo crear el perfil de pago";return E.notify({type:"negative",message:D}),!1}}async function _(){var T,q,D;if(A.value)return;A.value=!0,P+=1;const d=P;I.value=!0,k.value=null,await Pe();const g=b.value;if(!g){I.value=!1,k.value="Contenedor de pago no encontrado",A.value=!1;return}if(g.innerHTML="",x!=null&&x.unmount)try{await x.unmount()}catch{}y&&clearTimeout(y),y=setTimeout(()=>{P===d&&(I.value=!1,k.value="El formulario de pago tard\xF3 demasiado en cargar. Intenta nuevamente.",A.value=!1)},2e4);try{const F=((T={}.VITE_MERCADOPAGO_PUBLIC_KEY)==null?void 0:T.trim())||"";if(!F)throw new Error("Falta VITE_MERCADOPAGO_PUBLIC_KEY en el .env del frontend");const ae=await c();await ue(),m.value.length>0&&!z.value&&await u();const K=new ae(F,{locale:"es-MX"}),Z=(s.userInfo.name||"Usuario").split(" "),te=Z[0]||"",X=Z.slice(1).join(" ")||"",ee=(((q=s.metadata)==null?void 0:q.payer_entity_type)||"").toString().toLowerCase()==="association"?"association":"individual",oe=ee==="association"?"association":"individual",Y={amount:s.totalAmount,payer:{email:s.userInfo.email||"",firstName:te,lastName:X,entityType:ee,entity_type:ee,type:oe}};z.value&&m.value.length>0&&(Y.customerId=z.value,Y.cards=m.value.map(C=>({id:C.mercadopago_card_id,last_four_digits:C.last_four_digits,payment_method_id:C.payment_method_id,cardholderName:C.card_holder_name,expiration_month:C.expiration_month,expiration_year:C.expiration_year})));const re={onSubmit:async({selectedPaymentMethod:C,formData:f})=>{var se,le;try{const H=(f==null?void 0:f.paymentMethodId)||(f==null?void 0:f.payment_method_id)||(C==null?void 0:C.id)||(C==null?void 0:C.payment_method_id),e=f==null?void 0:f.token,t=f.cardholderName||f.cardHolderName||s.userInfo.name||"",a=f.lastFourDigits||f.last_four_digits||"",h=f.expirationMonth||f.expiration_month||"",U=f.expirationYear||f.expiration_year||"";if(!H||!e)throw new Error("Faltan datos de la tarjeta. Verifica el formulario e intenta nuevamente.");if(N.value&&e&&t&&a)if(!await u())N.value=!1;else try{await S.post("/payments/save_card_to_customer",{token:e,payment_method_id:H,last_four_digits:String(a).slice(-4),card_holder_name:t,expiration_month:h||"01",expiration_year:U||new Date().getFullYear().toString().slice(2)}),E.notify({type:"positive",message:"Tarjeta guardada para futuras compras",timeout:2e3})}catch(ce){console.warn("Save card failed (continuing with payment):",ce)}const B={transaction_amount:s.totalAmount,description:`Pago por ${s.cartItems.length} items`,payment_method_id:H,payer:{email:s.userInfo.email,first_name:te,last_name:X},payment_method:{token:e,installments:f.installments||1,card_holder_name:t,issuer_id:f.issuerId||f.issuer_id||null},external_reference:s.externalReference,metadata:s.metadata},M=(await S.post("/payments/process_payment",B)).data;M.status==="approved"||M.status==="pending"?n("payment-success",M):(n("payment-error",M.status_detail||"Pago no aprobado"),E.notify({type:"negative",message:M.status_detail||"Pago no aprobado"}))}catch(H){const e=((le=(se=H.response)==null?void 0:se.data)==null?void 0:le.detail)||H.message||"Error al procesar el pago";n("payment-error",e),E.notify({type:"negative",message:e})}},onReady:()=>{P===d&&(I.value=!1,A.value=!1,y&&(clearTimeout(y),y=null))},onError:C=>{P===d&&(I.value=!1,k.value=(C==null?void 0:C.message)||"Error al cargar el formulario de pago",n("payment-error",k.value),A.value=!1,y&&(clearTimeout(y),y=null))}};if(typeof K.bricks=="function")V=K.bricks();else if(typeof K.bricks=="object"&&typeof K.bricks.create=="function")V=K.bricks;else throw new Error("Mercado Pago Bricks no disponible en este SDK");const ne={theme:"dark",textPrimaryColor:"#ffffff",textSecondaryColor:"rgba(255, 255, 255, 0.75)",inputBackgroundColor:"#1e1e1e",formBackgroundColor:"#2c2c2c",baseColor:"#CFE74E",baseColorFirstVariant:"#b8d042",baseColorSecondVariant:"#a3b93a",errorColor:"#C10015",successColor:"#2e7d32",outlinePrimaryColor:"#CFE74E",outlineSecondaryColor:"#61127C",buttonTextColor:"#000000",fontSizeExtraSmall:"11px",fontSizeSmall:"13px",fontSizeMedium:"15px",fontSizeLarge:"17px",fontSizeExtraLarge:"19px",fontWeightNormal:"400",fontWeightSemiBold:"600",formInputsTextTransform:"none",inputVerticalPadding:"12px",inputHorizontalPadding:"14px",inputFocusedBoxShadow:"0 0 0 2px #CFE74E",inputErrorFocusedBoxShadow:"0 0 0 2px #C10015",inputBorderWidth:"1px",inputFocusedBorderWidth:"2px",borderRadiusSmall:"4px",borderRadiusMedium:"8px",borderRadiusLarge:"12px",borderRadiusFull:"9999px",formPadding:"20px"};console.log("CheckoutBricks init config",Y),x=await V.create("payment","payment-brick-container",{initialization:Y,customization:{paymentMethods:{creditCard:"all",debitCard:"all"},visual:{style:ne}},callbacks:re})}catch(F){console.error("CheckoutBricks init error",((D=F==null?void 0:F.response)==null?void 0:D.data)||F),P===d&&(I.value=!1,k.value=F.message||"Error al inicializar el pago",n("payment-error",k.value),E.notify({type:"negative",message:k.value}),A.value=!1,y&&(clearTimeout(y),y=null))}}return ke(()=>{Pe(()=>{setTimeout(()=>{_()},250)})}),je(()=>{const d=b.value;if(d&&(d.innerHTML=""),x!=null&&x.unmount)try{x.unmount()}catch{}y&&(clearTimeout(y),y=null)}),xe(()=>[s.totalAmount,s.externalReference],()=>{!I.value&&!k.value&&_()}),xe(N,async d=>{d&&(await u()||(N.value=!1))}),(d,g)=>(w(),G("div",ba,[g[2]||(g[2]=o("div",{class:"header"},[o("img",{src:Be,alt:"Logo Mercado Pago",class:"brand"}),o("p",{class:"text-caption"},"Ingresa los datos de tu tarjeta de manera segura")],-1)),k.value?(w(),G("div",xa,[r(W,{name:"error",size:"3rem"}),o("p",ka,$(k.value),1),r(J,{color:"primary",label:"Reintentar",onClick:_,class:"q-mt-md"})])):O("",!0),o("div",wa,[r(ze,{modelValue:N.value,"onUpdate:modelValue":g[0]||(g[0]=T=>N.value=T),label:"Guardar tarjeta para futuras compras",color:"primary",dark:"",class:"q-mb-md text-white"},null,8,["modelValue"]),o("div",Ca,[o("div",{ref_key:"paymentBrickContainer",ref:b,id:"payment-brick-container",class:"payment-brick-container"},null,512),I.value?(w(),G("div",Ia,[r(_e,{color:"primary",size:"3rem"}),g[1]||(g[1]=o("p",{class:"q-mt-md text-white"},"Cargando formulario de pago...",-1))])):O("",!0)])])]))}};var Ea=Ce(Pa,[["__scopeId","data-v-043c64c1"]]);const Sa={name:"MercadoPayment",components:{CheckoutAPI:ha,CheckoutBricks:Ea,PlayerNavigationMenu:Ye},setup(){const L=Oe(),p=Qe(),s=we(),n=i(!0),E=i(null),I=i([]),k=i({}),N=i(null),z=i(null),m=i(!1),b=i(!1),A=i(!1),V=i(""),x=be(()=>I.value.reduce((u,_)=>u+_.unit_price*_.quantity,0).toFixed(2)),y=!0,P=async()=>{n.value=!0,E.value=null;try{try{const _=await S.get("/payments/demo-status");m.value=_.data.demo_mode}catch(_){console.warn("Could not check demo status:",_)}const u=p.params.paymentData||JSON.parse(localStorage.getItem("mercadoPaymentData")||"{}");if(!u.cartItems||!u.userInfo)throw new Error("Datos de pago incompletos");I.value=u.cartItems,k.value=u.userInfo,N.value=u.externalReference,z.value=u.metadata,n.value=!1}catch{E.value="Error al cargar los datos de pago. Por favor, int\xE9ntalo nuevamente.",n.value=!1}},R=async u=>{var d,g,T,q,D,F,ae,K,Z,te,X,de,ee,oe,Y,re,ne,C,f,se,le,H,e,t;console.log("Payment successful:",u);const _=localStorage.getItem("mercadoPaymentData");if(localStorage.removeItem("mercadoPaymentData"),u.status==="approved"){let a={};try{a=JSON.parse(_||"{}")}catch(B){console.error("Error parsing payment data:",B)}const h=(d=a.metadata)==null?void 0:d.item_type,U=(g=a.metadata)==null?void 0:g.payment_order_id;if(console.log("Processing finalization for item type:",h),console.log("Payment metadata:",a.metadata),h&&U){const B={baseData:{clubId:(T=a.metadata)==null?void 0:T.club_id,id:(q=a.metadata)==null?void 0:q.item_id,participants:((D=a.metadata)==null?void 0:D.participants)||1},extraData:{date:(F=a.metadata)==null?void 0:F.date,time:(ae=a.metadata)==null?void 0:ae.time,duration:((K=a.metadata)==null?void 0:K.duration)||60,paymentOption:((Z=a.metadata)==null?void 0:Z.payment_option)||"total",isPublicMatch:((te=a.metadata)==null?void 0:te.is_public_match)||!1,partnerId:(X=a.metadata)==null?void 0:X.partner_id,isRetas:(de=a.metadata)==null?void 0:de.is_retas,matchId:(ee=a.metadata)==null?void 0:ee.match_id,slotIndex:(oe=a.metadata)==null?void 0:oe.slot_index,teamToJoin:(Y=a.metadata)==null?void 0:Y.team_to_join},selectedProducts:((re=a.metadata)==null?void 0:re.additional_items)||[],paymentOrderId:U,totalAmount:((ne=a.metadata)==null?void 0:ne.total_amount)||((f=(C=a.cartItems)==null?void 0:C[0])==null?void 0:f.unit_price)||0,amountToPay:((se=a.metadata)==null?void 0:se.amount_to_pay)||((H=(le=a.cartItems)==null?void 0:le[0])==null?void 0:H.unit_price)||0,itemDetails:((e=a.metadata)==null?void 0:e.item_details)||[],paymentOption:((t=a.metadata)==null?void 0:t.payment_option)||"total"};try{let v={success:!1},M="/player/dashboard";h==="court"?(v=await Je(u,B,S,s),v.success&&v.matchId&&(M=`/player/match/${v.matchId}`)):h==="class"||h==="private_lesson"?(v=await We(u,B,S,s),v.success&&v.path&&(M=v.path)):h==="public_lesson"?v=await Ge(u,B,S,s):h==="match"||h==="match_join"||h==="open_match_join"?(v=await Ze(u,B,S,s),v.success&&v.matchId&&(M=`/player/match/${v.matchId}`)):h==="tournament"?v=await Xe(u,B,S,s):(console.warn("Unknown item type:",h),s.notify({type:"warning",message:"Tipo de compra no reconocido, pero el pago fue exitoso.",timeout:3e3}),v={success:!0}),v.success?(localStorage.setItem("mercadoPagoSuccessRedirect",M),b.value=!0):c("El pago fue exitoso, pero hubo un problema al completar la operaci\xF3n. Contacta al soporte.")}catch(v){console.error("Error during finalization:",v),c("El pago fue exitoso, pero hubo un problema al completar la operaci\xF3n. Contacta al soporte.")}}else console.warn("Could not determine item type or payment order ID"),b.value=!0}else u.status==="pending"?(s.notify({type:"info",message:"Tu pago est\xE1 siendo procesado. Te notificaremos cuando se complete.",timeout:5e3}),setTimeout(()=>{L.push("/player/dashboard")},2e3)):c("El pago no fue aprobado. Por favor, intenta con otro m\xE9todo de pago.")},c=u=>{console.error("Payment error:",u),V.value=u,A.value=!0},ue=()=>{b.value=!1;const u=localStorage.getItem("mercadoPagoSuccessRedirect");localStorage.removeItem("mercadoPagoSuccessRedirect"),u?L.push(u).catch(_=>{console.error("Error navigating to stored path:",_),L.push("/player/dashboard")}):L.push("/player/dashboard").catch(()=>{L.push("/")})};return ke(()=>{P()}),{loading:n,error:E,cartItems:I,userInfo:k,externalReference:N,metadata:z,demoModeActive:m,totalAmount:x,useCheckoutBricks:y,showSuccessDialog:b,showErrorDialog:A,paymentErrorMessage:V,initPayment:P,handlePaymentSuccess:R,handlePaymentError:c,navigateToSuccess:ue}}},Na={class:"row q-col-gutter-md"},qa={class:"col-12 col-md-6"},Ma={class:"row justify-between"},za={class:"row justify-between text-h6"},Ta={class:"col-12 col-md-6"},Ba={class:"text-center"},Aa={class:"text-center text-negative"},Va={class:"q-mt-md"},Ra={key:0,class:"col-12 brick-full-width"};function Fa(L,p,s,n,E,I){const k=he("CheckoutAPI"),N=he("CheckoutBricks"),z=he("PlayerNavigationMenu");return w(),j($e,{view:"hHh lpR fFf",class:"text-white"},{default:l(()=>[r(Ae,{elevated:"",class:"text-white"},{default:l(()=>[...p[3]||(p[3]=[o("div",{class:"header-content"},[o("div",{class:"greeting"},[o("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon"})]),o("div",{class:"header-icons"})],-1)])]),_:1}),r(Le,{class:"home"},{default:l(()=>[r(Ue,{class:"q-pa-md"},{default:l(()=>[n.demoModeActive?(w(),j(Te,{key:0,class:"bg-secondary text-white q-mb-md"},{avatar:l(()=>[r(W,{name:"info",color:"white"})]),default:l(()=>[p[4]||(p[4]=o("strong",null,"MODO DEMOSTRACI\xD3N ACTIVO",-1)),p[5]||(p[5]=o("div",{class:"text-caption"}," Todos los pagos se aprueban autom\xE1ticamente para prop\xF3sitos de demostraci\xF3n. ",-1))]),_:1})):O("",!0),o("div",Na,[o("div",qa,[r(ie,{class:"text-white"},{default:l(()=>[r(Q,null,{default:l(()=>[...p[6]||(p[6]=[o("h4",{class:"text-white q-my-none"},"Resumen de la compra",-1)])]),_:1}),r(Q,null,{default:l(()=>[(w(!0),G(qe,null,Ne(n.cartItems,m=>(w(),G("div",{key:m.id,class:"q-mb-sm"},[o("div",Ma,[o("span",null,$(m.title)+" (x"+$(m.quantity)+")",1),o("span",null,"$"+$((m.unit_price*m.quantity).toFixed(2)),1)])]))),128)),r(Me,{class:"q-my-md"}),o("div",za,[o("strong",null,"Total: $"+$(n.totalAmount),1)])]),_:1})]),_:1})]),o("div",Ta,[n.loading?(w(),j(ie,{key:0,class:"text-white"},{default:l(()=>[r(Q,null,{default:l(()=>[o("div",Ba,[r(_e,{color:"primary",size:"3rem"}),p[7]||(p[7]=o("p",{class:"q-mt-md"},"Cargando formulario de pago...",-1))])]),_:1})]),_:1})):n.error?(w(),j(ie,{key:1,class:"text-white"},{default:l(()=>[r(Q,null,{default:l(()=>[o("div",Aa,[r(W,{name:"error",size:"3rem"}),o("p",Va,$(n.error),1),r(J,{color:"primary",label:"Reintentar",onClick:n.initPayment,class:"q-mt-md"},null,8,["onClick"])])]),_:1})]),_:1})):n.useCheckoutBricks?O("",!0):(w(),j(k,{key:2,"cart-items":n.cartItems,"user-info":n.userInfo,"total-amount":parseFloat(n.totalAmount),"external-reference":n.externalReference,metadata:n.metadata,onPaymentSuccess:n.handlePaymentSuccess,onPaymentError:n.handlePaymentError},null,8,["cart-items","user-info","total-amount","external-reference","metadata","onPaymentSuccess","onPaymentError"]))]),n.useCheckoutBricks&&!n.loading&&!n.error?(w(),G("div",Ra,[r(N,{"cart-items":n.cartItems,"user-info":n.userInfo,"total-amount":parseFloat(n.totalAmount),"external-reference":n.externalReference,metadata:n.metadata,onPaymentSuccess:n.handlePaymentSuccess,onPaymentError:n.handlePaymentError},null,8,["cart-items","user-info","total-amount","external-reference","metadata","onPaymentSuccess","onPaymentError"])])):O("",!0)]),r(Ee,{modelValue:n.showSuccessDialog,"onUpdate:modelValue":p[0]||(p[0]=m=>n.showSuccessDialog=m),persistent:""},{default:l(()=>[r(ie,{class:"text-center"},{default:l(()=>[r(Q,null,{default:l(()=>[r(W,{name:"check_circle",color:"positive",size:"4rem"}),p[8]||(p[8]=o("h4",{class:"q-my-md"},"\xA1Pago exitoso!",-1)),p[9]||(p[9]=o("p",null,"Tu pago ha sido procesado correctamente.",-1))]),_:1}),r(Se,{align:"center"},{default:l(()=>[r(J,{color:"primary",label:"Continuar",onClick:n.navigateToSuccess},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),r(Ee,{modelValue:n.showErrorDialog,"onUpdate:modelValue":p[2]||(p[2]=m=>n.showErrorDialog=m)},{default:l(()=>[r(ie,{class:"text-center"},{default:l(()=>[r(Q,null,{default:l(()=>[r(W,{name:"error",color:"negative",size:"4rem"}),p[10]||(p[10]=o("h4",{class:"q-my-md"},"Error en el pago",-1)),o("p",null,$(n.paymentErrorMessage),1)]),_:1}),r(Se,{align:"center"},{default:l(()=>[r(J,{color:"primary",label:"Intentar nuevamente",onClick:p[1]||(p[1]=m=>n.showErrorDialog=!1)})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),r(z)]),_:1})}var rt=Ce(Sa,[["render",Fa],["__scopeId","data-v-22547117"]]);export{rt as default};
