import{Q as be}from"./QSpinnerCube.58ab00ba.js";import{x as xe,y as $e,r as D,a0 as Ve,f as P,w as me,o as n,z as $,A as r,d as o,B as i,a7 as de,a8 as q,t as u,a as c,aa as R,ab as E,aK as T,a9 as g,e as I,ac as ce,aI as Be,aJ as Fe,ad as pe,D as b,ae as ye,af as Ae,aL as Re,h as Ee,a1 as Ie,a6 as fe,aM as ze,aN as Le}from"./index.687b44e8.js";import{u as Je}from"./summaryStore.ade2e05f.js";import{Q as Ue}from"./QHeader.289f0645.js";import{Q as je}from"./QTooltip.a50ac131.js";import{Q as Me}from"./QPage.fcc9aae1.js";import{a as Ge,Q as He}from"./QLayout.30990248.js";import{Q as Ke}from"./QSpace.0ef43295.js";import{Q as We}from"./QSpinnerDots.ed8017b0.js";import{Q as ge}from"./QItemLabel.bbebea39.js";import{Q as Xe,a as _e}from"./QItem.eb9291fb.js";import{C as ve}from"./ClosePopup.89fae5e1.js";import{u as Ye}from"./use-quasar.ba375293.js";import{g as Ze}from"./products.03f65746.js";import{a as ea}from"./api.1c42dce4.js";import{P as aa}from"./PlayerNavigationMenu.1a7d2e68.js";import{_ as De}from"./plugin-vue_export-helper.21dcd24c.js";import{D as ta}from"./DesktopNavigation.642093f4.js";import"./position-engine.46674690.js";import"./selection.0f785986.js";import"./supabase.66aa98e2.js";import"./QTabs.979bee57.js";import"./rtl.276c3f1b.js";import"./QFooter.b7b22f15.js";const oa={class:"text-white"},sa={key:0},la={class:"q-ml-md q-mb-sm",style:{"list-style-type":"none","padding-left":"0"}},ra={class:"text-h6"},ia={key:2,class:"text-caption q-mt-sm"},na={key:0,class:"text-center q-pa-md"},ua={key:1,class:"text-grey-7 q-pa-md text-center"},ma={class:"row items-center no-wrap"},da={class:"text-h6 text-black text-weight-bold q-mx-xs",style:{"min-width":"25px","text-align":"center"}},ca={__name:"OrderComponent",props:{summaryTitle:{type:String,required:!0,default:"Resumen"},itemDetails:{type:Array,required:!0,default:()=>[]},baseData:{type:Object,required:!0},commissionRate:{type:Number,default:4},showPublicToggle:{type:Boolean,default:!1},allowPaymentSplit:{type:Boolean,default:!1},extraData:{type:Object,default:()=>({})}},setup(y){var J,U,j;const e=y,h=xe(),k=Ye(),V=$e();console.log("OrderComponent - Props received:"),console.log("baseData:",e.baseData),console.log("extraData:",e.extraData),console.log("baseData.player2_email:",(J=e.baseData)==null?void 0:J.player2_email),console.log("extraData.player2_email:",(U=e.extraData)==null?void 0:U.player2_email);const d=D([]),l=Ve({}),p=D([]),Q=D(!1),B=D(!1),S=D(!1),F=D(!1),f=D(e.allowPaymentSplit&&((j=e.baseData)==null?void 0:j.participants)>1?"partial":"total"),A=P(()=>{var t;return(((t=e.baseData)==null?void 0:t.price)||0)+z.value}),Pe=P(()=>A.value*(e.commissionRate/100)),z=P(()=>p.value.reduce((a,t)=>a+t.product.price*t.quantity,0)),_=P(()=>A.value+Pe.value),he=P(()=>{var a;return[{label:`Pagar mi parte (1/${((a=e.baseData)==null?void 0:a.participants)||1})`,value:"partial"},{label:"Pagar el total",value:"total"}]}),we=P(()=>{var s;const a=((s=e.baseData)==null?void 0:s.participants)||1;let t=_.value;return e.allowPaymentSplit&&a>1&&f.value==="partial"&&(t=_.value/a),`Pagar $${t.toFixed(2)}`}),L=async()=>{var a;if(!((a=e.baseData)!=null&&a.clubId)){d.value=[];return}B.value=!0;try{const t=await Ze(e.baseData.clubId);d.value=t||[],d.value.forEach(s=>{l[s.id]===void 0&&(l[s.id]=0)})}catch(t){console.error("Error al cargar productos:",t),d.value=[],k.notify({type:"warning",message:"No se pudieron cargar los productos adicionales."})}finally{B.value=!1}},ke=()=>{var a;d.value.length===0&&((a=e.baseData)==null?void 0:a.clubId)?L():p.value.length===0&&d.value.forEach(t=>{l[t.id]=0}),Q.value=!0},Qe=a=>{(l[a]===void 0||l[a]===null||isNaN(Number(l[a])))&&(l[a]=0);const t=Number(l[a]);t>0&&(l[a]=t-1)},qe=a=>{(l[a]===void 0||l[a]===null||isNaN(Number(l[a])))&&(l[a]=0);const t=Number(l[a]);l[a]=t+1},Se=()=>{p.value=d.value.filter(a=>l[a.id]&&Number(l[a.id])>0).map(a=>({product:{id:a.id,name:a.name,price:a.price},quantity:Number(l[a.id])})),Q.value=!1},Ne=()=>{Ce("mercadopago")},Ce=async a=>{var t,s,m,N,M,G,H,K,W,X,Y,Z,ee,ae,te,oe,se,le,re,ie,ne;F.value=!0,k.loading.show({spinner:be,message:"Generando orden de pago..."});try{const v=((t=e.baseData)==null?void 0:t.participants)||1;let w=_.value,ue=!0;e.allowPaymentSplit&&v>1&&f.value==="partial"&&(w=_.value/v,ue=!1);const x={total_price:_.value,pay_total:ue,item_id:(s=e.baseData)==null?void 0:s.id,item_type:(m=e.baseData)==null?void 0:m.type,club_id:(N=e.baseData)==null?void 0:N.clubId,recipient_id:(M=e.baseData)==null?void 0:M.recipient_user_id,participants:v,products:p.value.map(O=>({id:O.product.id,quantity:O.quantity})),is_public:e.showPublicToggle?S.value:void 0};((G=e.baseData)==null?void 0:G.type)==="tournament"&&(x.player2_email=(W=(H=e.baseData)==null?void 0:H.player2_email)!=null?W:(K=e.extraData)==null?void 0:K.player2_email,x.tournament_name=(X=e.extraData)==null?void 0:X.tournament_name,x.is_retas=((Y=e.extraData)==null?void 0:Y.isRetas)||!1,console.log("Tournament registration - baseData:",e.baseData),console.log("Tournament registration - extraData:",e.extraData),console.log("Tournament registration - baseData.player2_email:",(Z=e.baseData)==null?void 0:Z.player2_email),console.log("Tournament registration - extraData.player2_email:",(ee=e.extraData)==null?void 0:ee.player2_email),console.log("Tournament registration - final player2_email:",x.player2_email),console.log("Tournament registration - is_retas:",x.is_retas)),console.log("Enviando a API /payment_order_and_split_payment:",x);const C=(ae=(await ea.post("payments/payment_order_and_split_payment",x)).data)==null?void 0:ae.payment_order_id;if(!C)throw new Error("Respuesta inv\xE1lida del servidor: No se recibi\xF3 payment_order_id.");if(a==="stripe")h.push({name:"StripePayment",query:{paymentOrderId:C,amountToPay:w.toFixed(2),totalAmount:_.value.toFixed(2),description:e.summaryTitle,clubId:(te=e.baseData)==null?void 0:te.clubId,baseData:JSON.stringify(e.baseData||{}),extraData:JSON.stringify(e.extraData||{}),selectedProducts:JSON.stringify(p.value||[]),itemDetails:JSON.stringify(e.itemDetails||[]),paymentOption:f.value}});else if(a==="mercadopago"){const O=[{id:((oe=e.baseData)==null?void 0:oe.id)||"item_1",title:e.summaryTitle,quantity:1,unit_price:w}],Oe={email:V.email||"user@example.com",name:V.fullName||"Usuario"},Te={cartItems:O,userInfo:Oe,externalReference:C,metadata:{payment_order_id:C,club_id:(se=e.baseData)==null?void 0:se.clubId,item_type:(le=e.baseData)==null?void 0:le.type,amount_to_pay:w,payment_option:f.value,item_id:(re=e.baseData)==null?void 0:re.id,participants:v,is_public_match:e.showPublicToggle?S.value:!1,total_amount:_.value,additional_items:p.value,...e.extraData&&{date:e.extraData.date,time:e.extraData.time,duration:e.extraData.duration,reservation_date:e.extraData.date,start_time:e.extraData.time,lesson_date:e.extraData.date,lesson_time:e.extraData.time,tournament_id:e.extraData.tournament_id,partner_id:e.extraData.partner_id,is_retas:e.extraData.is_retas,match_id:e.extraData.match_id,slot_index:e.extraData.slot_index,team_to_join:e.extraData.team_to_join},item_details:e.itemDetails}};localStorage.setItem("mercadoPaymentData",JSON.stringify(Te)),h.push({name:"MercadoPayment"})}}catch(v){console.error("Error en processPayment:",v);const w=((ne=(ie=v.response)==null?void 0:ie.data)==null?void 0:ne.message)||v.message||"Error al procesar el pago. Por favor intente de nuevo.";k.notify({type:"negative",message:w})}finally{F.value=!1,k.loading.hide()}};return me(()=>{var a;return(a=e.baseData)==null?void 0:a.clubId},(a,t)=>{a&&a!==t&&(d.value=[],p.value=[],Object.keys(l).forEach(s=>delete l[s]),L())},{immediate:!0}),me(()=>e.allowPaymentSplit,a=>{var t;a&&((t=e.baseData)==null?void 0:t.participants)>1?f.value="partial":f.value="total"},{immediate:!0}),(a,t)=>(n(),$(He,{view:"hHh lpR fFf",class:"text-white"},{default:r(()=>[o(Ue,{elevated:"",class:"text-white"},{default:r(()=>[...t[3]||(t[3]=[i("div",{class:"header-content"},[i("div",{class:"greeting"},[i("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon"})]),i("div",{class:"header-icons"})],-1)])]),_:1}),o(Ge,{class:"home"},{default:r(()=>[o(Me,{class:"q-pa-md"},{default:r(()=>[o(de,{class:"text-white"},{default:r(()=>[o(q,null,{default:r(()=>[i("h3",oa,u(e.summaryTitle),1)]),_:1}),o(q,null,{default:r(()=>{var s;return[(n(!0),c(E,null,R(e.itemDetails,(m,N)=>(n(),c("p",{key:N},[i("strong",null,u(m.label)+":",1),g(" "+u(m.value),1)]))),128)),o(T,{dark:"",spaced:"sm"}),i("p",null,[t[4]||(t[4]=i("strong",null,"Precio Base:",-1)),g(" $"+u(((s=e.baseData.price)==null?void 0:s.toFixed(2))||"0.00"),1)]),p.value.length>0?(n(),c("div",sa,[i("p",null,[t[5]||(t[5]=i("strong",null,"Adicionales:",-1)),g(" $"+u(z.value.toFixed(2)),1)]),i("ul",la,[(n(!0),c(E,null,R(p.value,m=>(n(),c("li",{key:m.product.id,class:"text-caption"},[o(ce,{name:"mdi-cart-outline",size:"xs",class:"q-mr-xs"}),g(" "+u(m.product.name)+" x "+u(m.quantity)+" - $"+u((m.product.price*m.quantity).toFixed(2)),1)]))),128))])])):I("",!0),i("p",null,[t[6]||(t[6]=i("strong",null,"Subtotal:",-1)),g(" $"+u(A.value.toFixed(2)),1)]),o(T,{dark:"",spaced:"sm"}),i("p",ra,[t[7]||(t[7]=i("strong",null,"Total a pagar:",-1)),g(" $"+u(_.value.toFixed(2))+" ",1),o(ce,{name:"o_info",size:"sm",class:"cursor-help q-ml-xs"},{default:r(()=>[o(je,{anchor:"top middle",self:"bottom middle",offset:[0,10],class:"bg-grey-9 text-body2"},{default:r(()=>[g(" Precio total (Base + Adicionales + Comisi\xF3n del "+u(e.commissionRate)+"%). ",1)]),_:1})]),_:1})])]}),_:1}),o(q,{class:"q-pt-none"},{default:r(()=>[e.showPublicToggle?(n(),$(Be,{key:0,modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=s=>S.value=s),"checked-icon":"check",color:"primary",label:"Partido P\xFAblico (otros podr\xE1n unirse)",class:"q-mb-sm"},null,8,["modelValue"])):I("",!0),e.allowPaymentSplit&&e.baseData.participants>1?(n(),$(Fe,{key:1,modelValue:f.value,"onUpdate:modelValue":t[1]||(t[1]=s=>f.value=s),options:he.value,color:"primary",inline:"",dense:""},null,8,["modelValue","options"])):e.baseData.participants>1?(n(),c("div",ia," Nota: El pago es individual por participante. ")):I("",!0)]),_:1}),o(pe,{align:"right",class:"q-pa-md"},{default:r(()=>[o(b,{icon:"mdi-basket-plus-outline",label:"Productos",color:"primary",onClick:ke,dense:""}),o(b,{label:we.value,color:"green","icon-right":"mdi-credit-card-outline",onClick:Ne,loading:F.value,padding:"sm lg"},null,8,["label","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),o(Ae,{modelValue:Q.value,"onUpdate:modelValue":t[2]||(t[2]=s=>Q.value=s)},{default:r(()=>[o(de,{style:{"min-width":"300px","max-width":"400px"},class:"bg-grey-2 text-black"},{default:r(()=>[o(q,{class:"row items-center q-pb-none bg-primary text-white"},{default:r(()=>[t[8]||(t[8]=i("div",{class:"text-h6"},"A\xF1adir Productos",-1)),o(Ke),ye(o(b,{icon:"close",flat:"",round:"",dense:""},null,512),[[ve]])]),_:1}),o(q,{style:{"max-height":"60vh","overflow-y":"auto"}},{default:r(()=>[B.value?(n(),c("div",na,[o(We,{color:"primary",size:"40px"}),t[9]||(t[9]=i("div",{class:"q-mt-sm"},"Cargando...",-1))])):!d.value||d.value.length===0?(n(),c("div",ua," No hay productos adicionales disponibles en este club. ")):(n(!0),c(E,{key:2},R(d.value,s=>(n(),c("div",{key:s.id,class:"q-mb-xs"},[o(Xe,{dense:""},{default:r(()=>[o(_e,null,{default:r(()=>[o(ge,{class:"text-weight-medium text-black"},{default:r(()=>[g(u(s.name),1)]),_:2},1024),o(ge,{caption:""},{default:r(()=>[g("$"+u(s.price.toFixed(2)),1)]),_:2},1024)]),_:2},1024),o(_e,{side:"",top:""},{default:r(()=>[i("div",ma,[o(b,{icon:"mdi-minus",color:"negative",round:"",dense:"",flat:"",size:"sm",onClick:m=>Qe(s.id),disable:!l[s.id]||l[s.id]<=0,class:"q-mr-xs"},null,8,["onClick","disable"]),i("span",da,u(l[s.id]||0),1),o(b,{icon:"mdi-plus",color:"positive",round:"",dense:"",flat:"",size:"sm",onClick:m=>qe(s.id),class:"q-ml-xs"},null,8,["onClick"])])]),_:2},1024)]),_:2},1024),o(T,{spaced:"xs"})]))),128))]),_:1}),o(T),o(pe,{align:"right",class:"q-pa-md"},{default:r(()=>[ye(o(b,{label:"Cancelar",color:"grey-7",flat:""},null,512),[[ve]]),o(b,{label:"Aceptar",color:"primary",push:"",onClick:Se})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(aa)]),_:1}))}};var pa=De(ca,[["__scopeId","data-v-4be28148"]]);const ya=Re({name:"OrderSummary",components:{OrderComponent:pa,DesktopNavigation:ta},setup(){const y=Je(),e=xe(),h=P(()=>y.getSummaryDetails);return Ee(()=>{y.hasActiveSummary?console.log("ReservationSummaryPage mounted with data:",h.value):(console.warn("No hay datos de resumen en el store. Redirigiendo..."),e.replace({name:"DashboardPlayer"}))}),Ie(()=>{y.clearSummaryDetails()}),{summaryData:h}}}),fa={key:1,class:"fullscreen text-white text-center q-pa-md flex flex-center"};function ga(y,e,h,k,V,d){const l=fe("OrderComponent"),p=fe("DesktopNavigation");return n(),c("div",null,[y.summaryData?(n(),$(l,ze(Le({key:0},y.summaryData)),null,16)):(n(),c("div",fa,[i("div",null,[o(be,{color:"primary",size:"xl"}),e[1]||(e[1]=i("div",{class:"q-mt-md text-h6"},"Cargando resumen...",-1)),o(b,{class:"q-mt-xl",color:"white","text-color":"black",unelevated:"",onClick:e[0]||(e[0]=Q=>y.$router.go(-1)),label:"Volver","no-caps":""})])])),o(p)])}var La=De(ya,[["render",ga]]);export{La as default};
