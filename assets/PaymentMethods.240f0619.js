import{Q as ve}from"./QHeader.907a1956.js";import{Q as te}from"./QPage.ce31240f.js";import{Q as fe,a as _e}from"./QLayout.d8f1103d.js";import{aN as re,f as ne,j as V,i as ge,r as l,B as Y,X as ye,w as le,q as c,s as C,L as J,bP as Ee,y as I,bJ as he,G as Q,H as n,v as e,a9 as W,aa as O,I as x,ab as M,ad as Se,ac as Ce,ae as X,x as P,J as D,Q as Z,bM as ee,af as be,n as we,F as Ne}from"./index.98c82dee.js";import{u as Ie}from"./summaryStore.b8319122.js";import{Q as F}from"./QItemLabel.4f226cee.js";import{Q as xe,a as B}from"./QItem.ea82eb28.js";import{Q as ke}from"./QList.c1e6c9aa.js";import"./index.46922028.js";import{u as Te}from"./use-quasar.4bd5d9ce.js";import{u as Pe}from"./userStore.970be199.js";import{a as $}from"./api.2af71db3.js";import{_ as se}from"./plugin-vue_export-helper.21dcd24c.js";import{P as Qe}from"./PlayerNavigationMenu.f0f41841.js";import"./pinia.6266255e.js";import"./QTabs.3a1f3d35.js";import"./rtl.276c3f1b.js";import"./QFooter.a4119c68.js";const L={STRIPE_NOT_LOADED:"Stripe is not loaded. Include it as script or load using loadStripe method of @stripe/stripe-js",INSTANCE_NOT_DEFINED:"Stripe instance is not defined. Initialize Stripe before creating elements",ELEMENTS_NOT_DEFINED:"Elements object is not defined. You can't create stripe element without it",ELEMENT_TYPE_NOT_DEFINED:"elementType is required. You can't create stripe element without it"},je=(p,s)=>{try{if(!window.Stripe)throw new Error(L.STRIPE_NOT_LOADED);return window.Stripe(p,s)}catch(d){console.error(d)}},qe=(p,s)=>{try{if(!p)throw new Error(L.INSTANCE_NOT_DEFINED);return s!=null&&s.clientSecret,p.elements(s)}catch(d){console.error(d)}},Me=(p,s,d)=>{try{if(!p)throw new Error(L.ELEMENTS_NOT_DEFINED);if(!s)throw new Error(L.ELEMENT_TYPE_NOT_DEFINED);return p.create.bind(p)(s,d)}catch(b){console.error(b)}},ae=["change","ready","focus","blur","click","escape","loaderror","loaderstart"],Oe=re({__name:"StripeElement",props:{type:{},elements:{},options:{}},emits:ae,setup(p,{expose:s,emit:d}){const b=p,w=d,{type:v,elements:m,options:o}=ne(b),N=V(()=>m.value?"card":"payment"),y=ge("providedElements"),E=l(document.createElement("div")),a=l(),S=l();return Y(()=>{const f=()=>{var i,h;a.value=Me(m.value||y.value,v.value||N.value,o.value),(i=S.value)==null||i.appendChild(E.value),(h=a.value)==null||h.mount(E.value)},_=()=>{function i(h){return!!h&&typeof h.on=="function"}if(a.value&&i(a.value))for(const h of ae)a.value.on(h,R=>{w(h,R)})};try{f(),_()}catch(i){console.error(i)}}),ye(()=>{var f,_;(f=a.value)==null||f.unmount(),(_=a.value)==null||_.destroy()}),le(o,()=>{o.value&&a.value&&"update"in a.value&&a.value.update(o.value)}),s({stripeElement:a,domElement:E,mountPoint:S}),(f,_)=>(c(),C("div",{ref_key:"mountPoint",ref:S},null,512))}}),De={key:0},Le=re({__name:"StripeElements",props:{stripeKey:{},instanceOptions:{},elementsOptions:{}},setup(p,{expose:s}){const d=p,{stripeKey:b,instanceOptions:w,elementsOptions:v}=ne(d),m=l(),o=l(),N=V(()=>o.value?Object.keys(o.value).length>0:!1);return Y(()=>{m.value=je(b.value,w.value),o.value=qe(m.value,v.value)}),le(v,()=>{var y;(y=o.value)==null||y.update(v.value)}),J("providedInstance",m),J("providedElements",o),s({elements:o,instance:m,elementsUsable:N}),(y,E)=>N.value?(c(),C("div",De,[Ee(y.$slots,"default",{instance:m.value,elements:o.value})])):I("",!0)}});const Re={key:1,class:"text-center text-grey q-pa-lg"},Ae={key:2,class:"text-center q-pa-lg"},Fe={class:"q-mt-lg"},Be={key:0,class:"stripe-elements-container"},$e={key:0,class:"text-negative q-mt-sm text-caption"},Ve={key:1,class:"text-negative q-pa-sm"},Ye={key:2,class:"text-center q-my-md"},ze={__name:"PaymentMethodsComponent",setup(p){const s=Te(),d=Pe(),b=l({}.VITE_STRIPE_PUBLISHABLE_KEY),w=l([]),v=l(!1),m=l(!1),o=l(null),N=l(null),y=l(!1),E=l(!1),a=l(null),S=l(null),f=l(!1),_=l(null),i=l(null);he(null),l(null);const h=l({}),R=V(()=>({clientSecret:i.value,appearance:{theme:"night",labels:"floating"}})),oe=l({style:{base:{iconColor:"#c4f0ff",color:"#fff",fontWeight:"500",fontFamily:"Roboto, Open Sans, Segoe UI, sans-serif",fontSize:"16px",fontSmoothing:"antialiased",":-webkit-autofill":{color:"#fce883"},"::placeholder":{color:"#87bbfd"}},invalid:{iconColor:"#ffc7ee",color:"#ffc7ee"}},hidePostalCode:!0}),A=async()=>{v.value=!0;try{const t=await $.get("/payments/payment-methods");w.value=t.data||[]}catch{}finally{v.value=!1}},ie=t=>{s.dialog({title:"Confirmar",message:"\xBFEst\xE1s seguro de que quieres eliminar esta tarjeta?",cancel:{label:"Cancelar",flat:!0},ok:{label:"Eliminar",color:"negative",push:!0},persistent:!0,dark:!0,class:"bg-black"}).onOk(async()=>{await ue(t)})},ue=async t=>{var r,u;s.loading.show({message:"Eliminando..."});try{await $.delete(`/payments/payment-methods/${t}`),s.notify({type:"positive",message:"Tarjeta eliminada correctamente."}),await A()}catch(g){console.error("Error deleting payment method:",g),s.notify({type:"negative",message:((u=(r=g.response)==null?void 0:r.data)==null?void 0:u.detail)||"Error al eliminar la tarjeta."})}finally{s.loading.hide()}},ce=t=>({visa:"img:/icons/visa.svg",mastercard:"img:/icons/mastercard.svg",amex:"img:/icons/amex.svg"})[t]||"mdi-credit-card",z=t=>({visa:"Visa",mastercard:"Mastercard",amex:"American Express"})[t]||t.charAt(0).toUpperCase()+t.slice(1),de=t=>{f.value=t.complete,S.value=t.error?t.error.message:null},U=()=>{m.value=!1,a.value=null,S.value=null,_.value=null,i.value=null,f.value=!1},me=async()=>{var t,r,u;E.value=!0,m.value=!0,_.value=null,i.value=null,f.value=!1;try{const q=(t=(await $.post("/payments/setup-intent")).data)==null?void 0:t.clientSecret;if(!q)throw new Error("No se recibi\xF3 la configuraci\xF3n de pago del servidor.");i.value=q,console.log("Client Secret obtenido para SetupIntent"),await we()}catch(g){console.error("Error fetching client secret for SetupIntent:",g),_.value=((u=(r=g.response)==null?void 0:r.data)==null?void 0:u.detail)||g.message||"Error al iniciar el formulario de pago.",m.value=!1}finally{E.value=!1}},pe=async()=>{var u,g,q,H;const t=(u=o.value)==null?void 0:u.instance,r=(g=N.value)==null?void 0:g.stripeElement;if(!t||!r){a.value="El formulario de pago no est\xE1 listo (instancias no encontradas).",console.error("Error: Instancia de Stripe o CardElement no encontrada en refs. Verifica 'elementsRef' y 'cardElementRef'.",{stripeRef:o.value,cardRef:N.value});return}if(!f.value){a.value="Por favor, completa los datos de la tarjeta.";return}if(!i.value){a.value="Falta la configuraci\xF3n de pago (Client Secret).";return}y.value=!0,a.value=null,S.value=null;try{console.log("Llamando a confirmCardSetup con clientSecret:",i.value);const{error:k,setupIntent:T}=await t.confirmCardSetup(i.value,{payment_method:{card:r,billing_details:{name:d.userName||"Nombre No Disponible",email:d.userEmail||void 0}},expand:["payment_method"]});if(k)console.error("Stripe confirmCardSetup error:",k),a.value=k.message||"Ocurri\xF3 un error al guardar la tarjeta.";else if(T.status==="succeeded"){console.log("SetupIntent Succeeded:",T);const j=T.payment_method;let K="tarjeta",G="****";typeof j=="object"&&(j==null?void 0:j.card)&&(K=j.card.brand,G=j.card.last4),s.notify({type:"positive",message:`Tarjeta ${z(K)} terminada en ${G} guardada.`}),U(),await A()}else T.status==="requires_action"?(console.warn("SetupIntent requires_action despu\xE9s de confirmCardSetup. Status:",T.status),a.value="Se requiere autenticaci\xF3n adicional o la acci\xF3n no se complet\xF3."):(console.warn("SetupIntent status:",T.status),a.value=`El estado de la configuraci\xF3n fue: ${T.status}. Intenta de nuevo.`)}catch(k){console.error("Error in saveNewCard function execution:",k),a.value=((H=(q=k.response)==null?void 0:q.data)==null?void 0:H.detail)||k.message||"Error inesperado al guardar la tarjeta."}finally{y.value=!1}};return Y(()=>{A()}),(t,r)=>(c(),Q(te,{class:"q-pa-md"},{default:n(()=>[e(W,null,{default:n(()=>[e(O,{class:"card-methods"},{default:n(()=>[r[2]||(r[2]=x("h4",{class:"q-mt-none q-mb-md text-white"},"Mis M\xE9todos de Pago",-1)),!v.value&&w.value.length>0?(c(),Q(ke,{key:0,bordered:"",separator:""},{default:n(()=>[e(F,{header:"",class:"text-grey-7"},{default:n(()=>r[0]||(r[0]=[M("Tarjetas Guardadas")])),_:1}),(c(!0),C(Se,null,Ce(w.value,u=>(c(),Q(xe,{key:u.id},{default:n(()=>[e(B,{avatar:""},{default:n(()=>[e(X,{name:ce(u.brand),size:"lg",color:"white"},null,8,["name"])]),_:2},1024),e(B,null,{default:n(()=>[e(F,null,{default:n(()=>[M(P(z(u.brand))+" terminada en "+P(u.last4),1)]),_:2},1024),e(F,{caption:""},{default:n(()=>[M("Expira: "+P(String(u.expMonth).padStart(2,"0"))+"/"+P(u.expYear),1)]),_:2},1024)]),_:2},1024),e(B,{side:""},{default:n(()=>[e(D,{icon:"delete",color:"negative",flat:"",round:"",dense:"",onClick:g=>ie(u.id),title:"Eliminar tarjeta"},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):I("",!0),!v.value&&w.value.length===0&&!m.value?(c(),C("div",Re,[e(X,{name:"mdi-credit-card-off-outline",size:"lg"}),r[1]||(r[1]=x("p",{class:"q-mt-sm"},"No tienes tarjetas guardadas.",-1))])):I("",!0),v.value?(c(),C("div",Ae,[e(Z,{color:"primary",size:"md"})])):I("",!0)]),_:1})]),_:1}),x("div",Fe,[m.value?I("",!0):(c(),Q(D,{key:0,label:"A\xF1adir Nueva Tarjeta",color:"green",icon:"add_card",onClick:me,loading:E.value,push:""},null,8,["loading"])),m.value?(c(),Q(W,{key:1,flat:"",bordered:"",class:"q-pa-md"},{default:n(()=>[e(O,{class:"q-pb-none"},{default:n(()=>r[3]||(r[3]=[x("div",{class:"text-h6"},"A\xF1adir Tarjeta",-1)])),_:1}),e(O,null,{default:n(()=>[b.value&&i.value?(c(),C("div",Be,[e(ee(Le),{ref_key:"elementsRef",ref:o,"stripe-key":b.value,"instance-options":h.value,"elements-options":R.value},{default:n(()=>[e(ee(Oe),{ref_key:"cardElementRef",ref:N,type:"card",options:oe.value,onChange:de},null,8,["options"])]),_:1},8,["stripe-key","instance-options","elements-options"]),S.value?(c(),C("div",$e,P(S.value),1)):I("",!0)])):_.value?(c(),C("div",Ve,P(_.value),1)):(c(),C("div",Ye,[e(Z,{color:"primary",size:"sm"}),r[4]||(r[4]=M(" Iniciando formulario seguro... "))]))]),_:1}),a.value?(c(),Q(O,{key:0,class:"text-negative"},{default:n(()=>[M(P(a.value),1)]),_:1})):I("",!0),e(be,{align:"right"},{default:n(()=>[e(D,{label:"Cancelar",flat:"",color:"grey",onClick:U}),e(D,{label:"Guardar Tarjeta",color:"primary",onClick:pe,loading:y.value||E.value,disable:E.value||!i.value||!f.value,push:""},null,8,["loading","disable"])]),_:1})]),_:1})):I("",!0)])]),_:1}))}};var Ue=se(ze,[["__scopeId","data-v-d78b2aa2"]]);const He={__name:"PaymentMethods",setup(p){return Ie(),Ne(),(s,d)=>(c(),Q(fe,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:n(()=>[e(ve,{elevated:"",class:"text-white"},{default:n(()=>d[0]||(d[0]=[x("div",{class:"header-content"},[x("div",{class:"greeting"},[x("img",{src:"/padelplay.png",alt:"Logo",class:"logo-icon"})]),x("div",{class:"header-icons"})],-1)])),_:1}),e(_e,null,{default:n(()=>[e(te,{class:"q-pa-md"},{default:n(()=>[e(Ue)]),_:1})]),_:1}),e(Qe)]),_:1}))}};var ma=se(He,[["__scopeId","data-v-7381d6ab"]]);export{ma as default};
