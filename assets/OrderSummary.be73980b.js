import{Q as _e}from"./QSpinnerCube.9454e40a.js";import{k as Te,p as $e,F as be,r as x,a as Ve,j as D,w as ue,q as n,G as $,H as r,v as s,I as i,a9 as me,aa as Q,x as u,s as c,ac as E,ad as I,aM as T,ab as f,y as R,ae as de,aK as Be,aL as Fe,af as ce,J as b,ag as pe,ah as Ae,aN as Ee,B as Ie,a2 as Re,a8 as ye,aO as ze,aP as Le}from"./index.71d630fb.js";import{u as je}from"./summaryStore.d5b6cbea.js";import{Q as Je}from"./QHeader.1501c452.js";import{Q as Ue}from"./QTooltip.cfd14cb0.js";import{Q as Me}from"./QPage.ce9abbf4.js";import{a as Ge,Q as He}from"./QLayout.c08f0fa0.js";import{Q as Ke}from"./QSpinnerDots.3805b4a3.js";import{Q as ge}from"./QItemLabel.00b7ff5b.js";import{Q as We,a as fe}from"./QItem.be3e7c8c.js";import{C as ve}from"./ClosePopup.bd252fc7.js";import{u as Xe}from"./use-quasar.0b14f354.js";import{g as Ye}from"./products.7a56d192.js";import{u as Ze}from"./userStore.0094877c.js";import{a as ea}from"./api.f1a1189d.js";import{P as aa}from"./PlayerNavigationMenu.4f189334.js";import{_ as xe}from"./plugin-vue_export-helper.21dcd24c.js";import{D as ta}from"./DesktopNavigation.2fc4da49.js";import"./pinia.014ff78d.js";import"./position-engine.25e73adf.js";import"./selection.040452b6.js";import"./supabase.60a2aacd.js";import"./QTabs.00f0efae.js";import"./rtl.276c3f1b.js";import"./QFooter.a6cd6ca7.js";var sa=Te({name:"QSpace",setup(){const p=$e("div",{class:"q-space"});return()=>p}});const oa={class:"text-white"},la={key:0},ra={class:"q-ml-md q-mb-sm",style:{"list-style-type":"none","padding-left":"0"}},ia={class:"text-h6"},na={key:2,class:"text-caption q-mt-sm"},ua={key:0,class:"text-center q-pa-md"},ma={key:1,class:"text-grey-7 q-pa-md text-center"},da={class:"row items-center no-wrap"},ca={class:"text-h6 text-black text-weight-bold q-mx-xs",style:{"min-width":"25px","text-align":"center"}},pa={__name:"OrderComponent",props:{summaryTitle:{type:String,required:!0,default:"Resumen"},itemDetails:{type:Array,required:!0,default:()=>[]},baseData:{type:Object,required:!0},commissionRate:{type:Number,default:4},showPublicToggle:{type:Boolean,default:!1},allowPaymentSplit:{type:Boolean,default:!1},extraData:{type:Object,default:()=>({})}},setup(p){var j,J,U;const e=p,P=be(),k=Xe(),V=Ze();console.log("OrderComponent - Props received:"),console.log("baseData:",e.baseData),console.log("extraData:",e.extraData),console.log("baseData.player2_email:",(j=e.baseData)==null?void 0:j.player2_email),console.log("extraData.player2_email:",(J=e.extraData)==null?void 0:J.player2_email);const d=x([]),l=Ve({}),y=x([]),w=x(!1),B=x(!1),S=x(!1),F=x(!1),g=x(e.allowPaymentSplit&&((U=e.baseData)==null?void 0:U.participants)>1?"partial":"total"),A=D(()=>{var t;return(((t=e.baseData)==null?void 0:t.price)||0)+z.value}),De=D(()=>A.value*(e.commissionRate/100)),z=D(()=>y.value.reduce((a,t)=>a+t.product.price*t.quantity,0)),v=D(()=>A.value+De.value),Pe=D(()=>{var a;return[{label:`Pagar mi parte (1/${((a=e.baseData)==null?void 0:a.participants)||1})`,value:"partial"},{label:"Pagar el total",value:"total"}]}),he=D(()=>{var o;const a=((o=e.baseData)==null?void 0:o.participants)||1;let t=v.value;return e.allowPaymentSplit&&a>1&&g.value==="partial"&&(t=v.value/a),`Pagar $${t.toFixed(2)}`}),L=async()=>{var a;if(!((a=e.baseData)!=null&&a.clubId)){d.value=[];return}B.value=!0;try{const t=await Ye(e.baseData.clubId);d.value=t||[],d.value.forEach(o=>{l[o.id]===void 0&&(l[o.id]=0)})}catch(t){console.error("Error al cargar productos:",t),d.value=[],k.notify({type:"warning",message:"No se pudieron cargar los productos adicionales."})}finally{B.value=!1}},ke=()=>{var a;d.value.length===0&&((a=e.baseData)==null?void 0:a.clubId)?L():y.value.length===0&&d.value.forEach(t=>{l[t.id]=0}),w.value=!0},we=a=>{(l[a]===void 0||l[a]===null||isNaN(Number(l[a])))&&(l[a]=0);const t=Number(l[a]);t>0&&(l[a]=t-1)},qe=a=>{(l[a]===void 0||l[a]===null||isNaN(Number(l[a])))&&(l[a]=0);const t=Number(l[a]);l[a]=t+1},Qe=()=>{y.value=d.value.filter(a=>l[a.id]&&Number(l[a.id])>0).map(a=>({product:{id:a.id,name:a.name,price:a.price},quantity:Number(l[a.id])})),w.value=!1},Se=()=>{Ce("mercadopago")},Ce=async a=>{var t,o,m,C,M,G,H,K,W,X,Y,Z,ee,ae,te,se,oe,le,re,ie;F.value=!0,k.loading.show({spinner:_e,message:"Generando orden de pago..."});try{const _=((t=e.baseData)==null?void 0:t.participants)||1;let h=v.value,ne=!0;e.allowPaymentSplit&&_>1&&g.value==="partial"&&(h=v.value/_,ne=!1);const q={total_price:v.value,pay_total:ne,item_id:(o=e.baseData)==null?void 0:o.id,item_type:(m=e.baseData)==null?void 0:m.type,club_id:(C=e.baseData)==null?void 0:C.clubId,recipient_id:(M=e.baseData)==null?void 0:M.recipient_user_id,participants:_,products:y.value.map(O=>({id:O.product.id,quantity:O.quantity})),is_public:e.showPublicToggle?S.value:void 0};((G=e.baseData)==null?void 0:G.type)==="tournament"&&(q.player2_email=(W=(H=e.baseData)==null?void 0:H.player2_email)!=null?W:(K=e.extraData)==null?void 0:K.player2_email,q.tournament_name=(X=e.extraData)==null?void 0:X.tournament_name,console.log("Tournament registration - baseData:",e.baseData),console.log("Tournament registration - extraData:",e.extraData),console.log("Tournament registration - baseData.player2_email:",(Y=e.baseData)==null?void 0:Y.player2_email),console.log("Tournament registration - extraData.player2_email:",(Z=e.extraData)==null?void 0:Z.player2_email),console.log("Tournament registration - final player2_email:",q.player2_email)),console.log("Enviando a API /payment_order_and_split_payment:",q);const N=(ee=(await ea.post("payments/payment_order_and_split_payment",q)).data)==null?void 0:ee.payment_order_id;if(!N)throw new Error("Respuesta inv\xE1lida del servidor: No se recibi\xF3 payment_order_id.");if(a==="stripe")P.push({name:"StripePayment",query:{paymentOrderId:N,amountToPay:h.toFixed(2),totalAmount:v.value.toFixed(2),description:e.summaryTitle,clubId:(ae=e.baseData)==null?void 0:ae.clubId,baseData:JSON.stringify(e.baseData||{}),extraData:JSON.stringify(e.extraData||{}),selectedProducts:JSON.stringify(y.value||[]),itemDetails:JSON.stringify(e.itemDetails||[]),paymentOption:g.value}});else if(a==="mercadopago"){const O=[{id:((te=e.baseData)==null?void 0:te.id)||"item_1",title:e.summaryTitle,quantity:1,unit_price:h}],Ne={email:V.email||"user@example.com",name:V.fullName||"Usuario"},Oe={cartItems:O,userInfo:Ne,externalReference:N,metadata:{payment_order_id:N,club_id:(se=e.baseData)==null?void 0:se.clubId,item_type:(oe=e.baseData)==null?void 0:oe.type,amount_to_pay:h,payment_option:g.value,item_id:(le=e.baseData)==null?void 0:le.id,participants:_,is_public_match:e.showPublicToggle?S.value:!1,total_amount:v.value,additional_items:y.value,...e.extraData&&{date:e.extraData.date,time:e.extraData.time,duration:e.extraData.duration,reservation_date:e.extraData.date,start_time:e.extraData.time,lesson_date:e.extraData.date,lesson_time:e.extraData.time,tournament_id:e.extraData.tournament_id,partner_id:e.extraData.partner_id,is_retas:e.extraData.is_retas,match_id:e.extraData.match_id,slot_index:e.extraData.slot_index,team_to_join:e.extraData.team_to_join},item_details:e.itemDetails}};localStorage.setItem("mercadoPaymentData",JSON.stringify(Oe)),P.push({name:"MercadoPayment"})}}catch(_){console.error("Error en processPayment:",_);const h=((ie=(re=_.response)==null?void 0:re.data)==null?void 0:ie.message)||_.message||"Error al procesar el pago. Por favor intente de nuevo.";k.notify({type:"negative",message:h})}finally{F.value=!1,k.loading.hide()}};return ue(()=>{var a;return(a=e.baseData)==null?void 0:a.clubId},(a,t)=>{a&&a!==t&&(d.value=[],y.value=[],Object.keys(l).forEach(o=>delete l[o]),L())},{immediate:!0}),ue(()=>e.allowPaymentSplit,a=>{var t;a&&((t=e.baseData)==null?void 0:t.participants)>1?g.value="partial":g.value="total"},{immediate:!0}),(a,t)=>(n(),$(He,{view:"hHh lpR fFf",class:"bg-dark text-white"},{default:r(()=>[s(Je,{elevated:"",class:"text-white"},{default:r(()=>t[3]||(t[3]=[i("div",{class:"header-content"},[i("div",{class:"greeting"},[i("img",{src:"/src/assets/padelplay.png",alt:"Logo",class:"logo-icon"})]),i("div",{class:"header-icons"})],-1)])),_:1}),s(Ge,{class:"home"},{default:r(()=>[s(Me,{class:"q-pa-md"},{default:r(()=>[s(me,{class:"text-white"},{default:r(()=>[s(Q,null,{default:r(()=>[i("h3",oa,u(e.summaryTitle),1)]),_:1}),s(Q,null,{default:r(()=>{var o;return[(n(!0),c(I,null,E(e.itemDetails,(m,C)=>(n(),c("p",{key:C},[i("strong",null,u(m.label)+":",1),f(" "+u(m.value),1)]))),128)),s(T,{dark:"",spaced:"sm"}),i("p",null,[t[4]||(t[4]=i("strong",null,"Precio Base:",-1)),f(" $"+u(((o=e.baseData.price)==null?void 0:o.toFixed(2))||"0.00"),1)]),y.value.length>0?(n(),c("div",la,[i("p",null,[t[5]||(t[5]=i("strong",null,"Adicionales:",-1)),f(" $"+u(z.value.toFixed(2)),1)]),i("ul",ra,[(n(!0),c(I,null,E(y.value,m=>(n(),c("li",{key:m.product.id,class:"text-caption"},[s(de,{name:"mdi-cart-outline",size:"xs",class:"q-mr-xs"}),f(" "+u(m.product.name)+" x "+u(m.quantity)+" - $"+u((m.product.price*m.quantity).toFixed(2)),1)]))),128))])])):R("",!0),i("p",null,[t[6]||(t[6]=i("strong",null,"Subtotal:",-1)),f(" $"+u(A.value.toFixed(2)),1)]),s(T,{dark:"",spaced:"sm"}),i("p",ia,[t[7]||(t[7]=i("strong",null,"Total a pagar:",-1)),f(" $"+u(v.value.toFixed(2))+" ",1),s(de,{name:"o_info",size:"sm",class:"cursor-help q-ml-xs"},{default:r(()=>[s(Ue,{anchor:"top middle",self:"bottom middle",offset:[0,10],class:"bg-grey-9 text-body2"},{default:r(()=>[f(" Precio total (Base + Adicionales + Comisi\xF3n del "+u(e.commissionRate)+"%). ",1)]),_:1})]),_:1})])]}),_:1}),s(Q,{class:"q-pt-none"},{default:r(()=>[e.showPublicToggle?(n(),$(Be,{key:0,modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=o=>S.value=o),"checked-icon":"check",color:"green",label:"Partido P\xFAblico (otros podr\xE1n unirse)",class:"q-mb-sm"},null,8,["modelValue"])):R("",!0),e.allowPaymentSplit&&e.baseData.participants>1?(n(),$(Fe,{key:1,modelValue:g.value,"onUpdate:modelValue":t[1]||(t[1]=o=>g.value=o),options:Pe.value,color:"green",inline:"",dense:""},null,8,["modelValue","options"])):e.baseData.participants>1?(n(),c("div",na," Nota: El pago es individual por participante. ")):R("",!0)]),_:1}),s(ce,{align:"right",class:"q-pa-md"},{default:r(()=>[s(b,{icon:"mdi-basket-plus-outline",label:"Productos",color:"primary",onClick:ke,dense:""}),s(b,{label:he.value,color:"green","icon-right":"mdi-credit-card-outline",onClick:Se,loading:F.value,padding:"sm lg"},null,8,["label","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),s(Ae,{modelValue:w.value,"onUpdate:modelValue":t[2]||(t[2]=o=>w.value=o)},{default:r(()=>[s(me,{style:{"min-width":"300px","max-width":"400px"},class:"bg-grey-2 text-black"},{default:r(()=>[s(Q,{class:"row items-center q-pb-none bg-primary text-white"},{default:r(()=>[t[8]||(t[8]=i("div",{class:"text-h6"},"A\xF1adir Productos",-1)),s(sa),pe(s(b,{icon:"close",flat:"",round:"",dense:""},null,512),[[ve]])]),_:1}),s(Q,{style:{"max-height":"60vh","overflow-y":"auto"}},{default:r(()=>[B.value?(n(),c("div",ua,[s(Ke,{color:"primary",size:"40px"}),t[9]||(t[9]=i("div",{class:"q-mt-sm"},"Cargando...",-1))])):!d.value||d.value.length===0?(n(),c("div",ma," No hay productos adicionales disponibles en este club. ")):(n(!0),c(I,{key:2},E(d.value,o=>(n(),c("div",{key:o.id,class:"q-mb-xs"},[s(We,{dense:""},{default:r(()=>[s(fe,null,{default:r(()=>[s(ge,{class:"text-weight-medium text-black"},{default:r(()=>[f(u(o.name),1)]),_:2},1024),s(ge,{caption:""},{default:r(()=>[f("$"+u(o.price.toFixed(2)),1)]),_:2},1024)]),_:2},1024),s(fe,{side:"",top:""},{default:r(()=>[i("div",da,[s(b,{icon:"mdi-minus",color:"negative",round:"",dense:"",flat:"",size:"sm",onClick:m=>we(o.id),disable:!l[o.id]||l[o.id]<=0,class:"q-mr-xs"},null,8,["onClick","disable"]),i("span",ca,u(l[o.id]||0),1),s(b,{icon:"mdi-plus",color:"positive",round:"",dense:"",flat:"",size:"sm",onClick:m=>qe(o.id),class:"q-ml-xs"},null,8,["onClick"])])]),_:2},1024)]),_:2},1024),s(T,{spaced:"xs"})]))),128))]),_:1}),s(T),s(ce,{align:"right",class:"q-pa-md"},{default:r(()=>[pe(s(b,{label:"Cancelar",color:"grey-7",flat:""},null,512),[[ve]]),s(b,{label:"Aceptar",color:"primary",push:"",onClick:Qe})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(aa)]),_:1}))}};var ya=xe(pa,[["__scopeId","data-v-77c2a52e"]]);const ga=Ee({name:"OrderSummary",components:{OrderComponent:ya,DesktopNavigation:ta},setup(){const p=je(),e=be(),P=D(()=>p.getSummaryDetails);return Ie(()=>{p.hasActiveSummary?console.log("ReservationSummaryPage mounted with data:",P.value):(console.warn("No hay datos de resumen en el store. Redirigiendo..."),e.replace({name:"DashboardPlayer"}))}),Re(()=>{p.clearSummaryDetails()}),{summaryData:P}}}),fa={key:1,class:"fullscreen bg-dark text-white text-center q-pa-md flex flex-center"};function va(p,e,P,k,V,d){const l=ye("OrderComponent"),y=ye("DesktopNavigation");return n(),c("div",null,[p.summaryData?(n(),$(l,ze(Le({key:0},p.summaryData)),null,16)):(n(),c("div",fa,[i("div",null,[s(_e,{color:"orange",size:"xl"}),e[1]||(e[1]=i("div",{class:"q-mt-md text-h6"},"Cargando resumen...",-1)),s(b,{class:"q-mt-xl",color:"white","text-color":"black",unelevated:"",onClick:e[0]||(e[0]=w=>p.$router.go(-1)),label:"Volver","no-caps":""})])])),s(y)])}var Ja=xe(ga,[["render",va]]);export{Ja as default};
